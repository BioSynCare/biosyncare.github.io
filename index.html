<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BioSynCare Lab - Neurosensory Stimulation Dashboard</title>
    <meta
      name="description"
      content="Neurosensory stimulation dashboard with binaural beats, isochronic tones, noise generators, and ONC ontology browser."
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .panel {
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        border: 1px solid #e5e7eb;
        padding: 1.5rem;
      }
      .btn-primary {
        padding: 0.5rem 1rem;
        background-color: #2563eb;
        color: white;
        border-radius: 0.5rem;
        font-weight: 500;
        transition: all 0.2s;
      }
      .btn-primary:hover {
        background-color: #1d4ed8;
      }
      .btn-secondary {
        padding: 0.5rem 1rem;
        background-color: #f3f4f6;
        color: #374151;
        border-radius: 0.5rem;
        font-weight: 500;
        transition: all 0.2s;
      }
      .btn-secondary:hover {
        background-color: #e5e7eb;
      }
      .btn-danger {
        padding: 0.5rem 1rem;
        background-color: #dc2626;
        color: white;
        border-radius: 0.5rem;
        font-weight: 500;
        transition: all 0.2s;
      }
      .btn-danger:hover {
        background-color: #b91c1c;
      }
      .tab {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 0.5rem;
        transition: all 0.2s;
        cursor: pointer;
      }
      .tab-active {
        background-color: #2563eb;
        color: white;
      }
      .tab-inactive {
        color: #4b5563;
      }
      .tab-inactive:hover {
        background-color: #f3f4f6;
      }
      .visual-display {
        position: relative;
        overflow: hidden;
        border-radius: 0.75rem;
        border: 1px solid #e5e7eb;
        background: radial-gradient(
          circle at center,
          #f8fafc 0%,
          #e2e8f0 75%
        );
        transition: background 0.6s ease, transform 0.6s ease;
        min-height: 12rem;
      }
      @keyframes blinkPalette {
        0%,
        100% {
          background: radial-gradient(
            circle at center,
            #1d4ed8 0%,
            #1e293b 75%
          );
          transform: scale(1);
        }
        25% {
          background: radial-gradient(
            circle at center,
            #0ea5e9 0%,
            #0369a1 80%
          );
          transform: scale(1.03);
        }
        50% {
          background: radial-gradient(
            circle at center,
            #22d3ee 0%,
            #14b8a6 80%
          );
          transform: scale(0.98);
        }
        75% {
          background: radial-gradient(
            circle at center,
            #f97316 0%,
            #c2410c 80%
          );
          transform: scale(1.04);
        }
      }
      .blink-animation {
        animation: blinkPalette 1.4s infinite;
      }
      @keyframes undulatePalette {
        0% {
          background: radial-gradient(
            circle at 20% 20%,
            #4338ca 0%,
            #2563eb 70%
          );
        }
        33% {
          background: radial-gradient(
            circle at 80% 30%,
            #0891b2 0%,
            #0ea5e9 70%
          );
        }
        66% {
          background: radial-gradient(
            circle at 30% 80%,
            #a855f7 0%,
            #7c3aed 70%
          );
        }
        100% {
          background: radial-gradient(
            circle at 70% 80%,
            #f59e0b 0%,
            #ef4444 70%
          );
        }
      }
      .undulate-animation {
        animation: undulatePalette 10s infinite alternate;
      }
      .track-section {
        border-top: 1px solid #e5e7eb;
        padding-top: 1rem;
      }
      .track-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .track-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
      }
      .track-item h4 {
        font-size: 0.95rem;
        font-weight: 600;
        color: #1f2937;
      }
      .track-item p {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 0.125rem;
      }
      .track-item button {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        background-color: #fee2e2;
        color: #b91c1c;
        border: 1px solid #fecaca;
        transition: background 0.2s, color 0.2s;
      }
      .track-item button:hover {
        background-color: #fecaca;
        color: #7f1d1d;
      }
      .track-empty {
        font-size: 0.875rem;
        color: #6b7280;
        padding: 0.75rem 0.5rem;
      }
      .visual-layer-container {
        position: absolute;
        inset: 0;
        display: grid;
        pointer-events: none;
        z-index: 1;
      }
      .visual-layer {
        position: absolute;
        inset: 0;
        border-radius: inherit;
        mix-blend-mode: screen;
        opacity: 0.85;
        transition: transform 0.6s ease, opacity 0.6s ease;
        pointer-events: none;
      }
      .visual-status-text {
        position: relative;
        z-index: 5;
        font-size: 0.9rem;
        line-height: 1.4;
        color: #374151;
        text-shadow: 0 1px 3px rgba(15, 23, 42, 0.1);
      }
      .visual-status-text.active {
        color: #f8fafc;
        text-shadow: 0 4px 12px rgba(15, 23, 42, 0.45);
      }
      @media (prefers-reduced-motion: reduce) {
        .blink-animation,
        .undulate-animation {
          animation-duration: 0s;
          animation-iteration-count: 1;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <header class="bg-white border-b sticky top-0 z-50 shadow-sm">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold shadow"
            >
              B
            </div>
            <div>
              <h1 class="text-xl font-bold">BioSynCare Lab</h1>
              <p class="text-xs text-gray-500">
                Neurosensory Stimulation Dashboard
              </p>
            </div>
          </div>
          <div class="flex gap-2">
            <button id="btn-init" class="btn-primary text-sm">
              üéß Initialize
            </button>
            <button id="btn-stop" class="btn-danger text-sm hidden">
              ‚èπ Stop
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
      <div class="panel mb-6" id="identity-panel">
        <div
          class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between"
        >
          <div class="space-y-2">
            <h2 class="text-2xl font-bold">Session & Identity</h2>
            <p id="auth-status" class="text-sm text-gray-600">
              Checking authentication state...
            </p>
            <div class="flex flex-wrap items-center gap-2 text-sm">
              <span class="uppercase tracking-wide text-gray-400 text-xs"
                >Current identity</span
              >
              <span id="auth-identity" class="font-medium text-gray-800"
                >‚Äî</span
              >
              <span
                id="auth-anonymous-badge"
                class="hidden rounded-full bg-slate-200 px-2 py-1 text-xs font-medium text-slate-600"
              >
                Anonymous session
              </span>
            </div>
          </div>
          <div class="flex items-start justify-end">
            <button
              id="btn-signout"
              class="btn-secondary text-sm hidden"
              type="button"
            >
              ‚Ü© Sign out
            </button>
          </div>
        </div>
        <div id="auth-login-section" class="mt-5 space-y-4">
          <div class="space-y-3">
            <p class="text-xs font-semibold uppercase text-gray-400">
              Quick login
            </p>
            <div class="flex flex-wrap items-center gap-3">
              <button
                id="btn-login-google"
                class="btn-primary text-sm"
                type="button"
              >
                ‚ú® Continue with Google
              </button>
              <button
                id="btn-login-github"
                class="btn-secondary text-sm"
                type="button"
              >
                üêô Continue with GitHub
              </button>
            </div>
          </div>
          <div class="space-y-3 border-t border-slate-200 pt-4">
            <p class="text-xs font-semibold uppercase text-gray-400">
              Email access
            </p>
            <div class="grid gap-2 sm:grid-cols-2">
              <input
                id="auth-email"
                type="email"
                autocomplete="email"
                placeholder="you@example.com"
                class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring focus:ring-blue-200"
              />
              <input
                id="auth-password"
                type="password"
                autocomplete="current-password"
                placeholder="Password"
                class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
            <div class="flex flex-wrap items-center gap-3">
              <button
                id="btn-email-login"
                class="btn-primary text-sm"
                type="button"
              >
                Login
              </button>
              <button
                id="btn-email-register"
                class="btn-secondary text-sm"
                type="button"
              >
                Register
              </button>
            </div>
          </div>
          <p
            id="auth-feedback"
            class="text-xs text-red-500 hidden"
            role="status"
          ></p>
        </div>
      </div>

      <div class="grid gap-6 lg:grid-cols-2">
        <div class="panel">
          <h2 class="text-2xl font-bold mb-4">Audio Controls</h2>
          <p id="status" class="text-gray-600 mb-4">Click Initialize to start</p>
          <div class="space-y-6">
            <div class="space-y-2">
              <div class="flex items-center justify-between gap-2">
                <label
                  for="audio-menu"
                  class="block text-sm font-medium text-gray-700"
                  >Audio feature</label
                >
                <span class="text-xs text-gray-400"
                  >Layer tracks to craft a session</span
                >
              </div>
              <div class="grid gap-3 sm:grid-cols-[1fr_auto]">
                <select
                  id="audio-menu"
                  class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring focus:ring-blue-200"
                >
                  <option value="sine">Pure sine ‚Ä¢ 440Hz</option>
                  <option value="binaural">Binaural beat ‚Ä¢ Alpha 10Hz</option>
                  <option value="monaural">Monaural beat ‚Ä¢ Theta 6Hz</option>
                  <option value="isochronic">
                    Isochronic pulse ‚Ä¢ 12Hz breathing
                  </option>
                  <option value="martigli">Martigli harmonics</option>
                  <option value="noise-white">Noise ‚Ä¢ White spectrum</option>
                  <option value="noise-pink">Noise ‚Ä¢ Pink spectrum</option>
                  <option value="noise-brown">Noise ‚Ä¢ Brown spectrum</option>
                </select>
                <button id="btn-add-audio" class="btn-primary">
                  ‚ûï Add track
                </button>
              </div>
              <p
                id="audio-description"
                class="text-xs text-gray-500 leading-relaxed"
              >
                Pure sine tone at 440Hz for quick calibration and reference.
              </p>
            </div>
            <div class="flex flex-wrap gap-3">
              <button id="btn-stop-all-audio" class="btn-secondary text-sm">
                ‚èπ Stop all audio
              </button>
            </div>
            <div class="track-section">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-gray-700">
                  Active audio tracks
                </h3>
                <span
                  id="audio-track-count"
                  class="text-xs font-medium text-gray-400"
                  >0 layers</span
                >
              </div>
              <div id="audio-active-empty" class="track-empty">
                No audio layers running. Add a track to begin.
              </div>
              <div id="audio-active-list" class="track-list"></div>
            </div>
          </div>
        </div>
        <div class="panel">
          <h2 class="text-2xl font-bold mb-4">Visual Controls</h2>
          <p class="text-gray-600 mb-4">
            Pair color entrainment with audio sessions or run standalone.
          </p>
          <div class="space-y-6">
            <div class="space-y-2">
              <div class="flex items-center justify-between gap-2">
                <label
                  for="visual-menu"
                  class="block text-sm font-medium text-gray-700"
                  >Visual feature</label
                >
                <span class="text-xs text-gray-400">Stack light cues</span>
              </div>
              <div class="grid gap-3 sm:grid-cols-[1fr_auto]">
                <select
                  id="visual-menu"
                  class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring focus:ring-blue-200"
                >
                  <option value="blink">Blinking colors</option>
                  <option value="undulate">Undulating colors</option>
                </select>
                <button id="btn-add-visual" class="btn-primary">
                  ‚ûï Add visual
                </button>
              </div>
              <p
                id="visual-description"
                class="text-xs text-gray-500 leading-relaxed"
              >
                High-contrast blinking palette for alert focus and breathing
                cadence.
              </p>
            </div>
            <div class="flex flex-wrap gap-3">
              <button id="btn-stop-all-visual" class="btn-secondary text-sm">
                ‚èπ Stop all visual
              </button>
            </div>
          </div>
          <div
            id="visual-display"
            class="visual-display mt-6 flex h-48 items-center justify-center px-4 text-center text-sm font-medium text-gray-600 transition-colors"
          >
            <div
              id="visual-layer-container"
              class="visual-layer-container"
              aria-hidden="true"
            ></div>
            <span
              id="visual-status-text"
              class="visual-status-text transition-colors duration-300"
              >Visual output appears here once started.</span
            >
          </div>
          <div class="track-section mt-6">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-semibold text-gray-700">
                Active visual layers
              </h3>
              <span
                id="visual-track-count"
                class="text-xs font-medium text-gray-400"
                >0 layers</span
              >
            </div>
            <div id="visual-active-empty" class="track-empty">
              No visual layers running. Add a cue to illuminate the panel.
            </div>
            <div id="visual-active-list" class="track-list"></div>
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      import { AudioEngine } from './src/core/audio-engine.js';
      import {
        ensureAnonymousUser,
        onAuthChanged,
        signInWithGoogle,
        signInWithGitHub,
        signInWithEmail,
        registerWithEmail,
        signOutUser,
        getCurrentUser,
        isAnonymousUser,
      } from './src/utils/firebase.js';

      const generateTrackId = (prefix) =>
        `${prefix}_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;

      let engine = null;

      // --- Identity UI ---
      const authStatusEl = document.getElementById('auth-status');
      const authIdentityEl = document.getElementById('auth-identity');
      const authAnonymousBadge = document.getElementById(
        'auth-anonymous-badge'
      );
      const authLoginSection = document.getElementById('auth-login-section');
      const authFeedbackEl = document.getElementById('auth-feedback');
      const authEmailInput = document.getElementById('auth-email');
      const authPasswordInput = document.getElementById('auth-password');

      const btnLoginGoogle = document.getElementById('btn-login-google');
      const btnLoginGitHub = document.getElementById('btn-login-github');
      const btnEmailLogin = document.getElementById('btn-email-login');
      const btnEmailRegister = document.getElementById('btn-email-register');
      const btnSignout = document.getElementById('btn-signout');

      const authButtons = [
        btnLoginGoogle,
        btnLoginGitHub,
        btnEmailLogin,
        btnEmailRegister,
        btnSignout,
      ].filter(Boolean);

      const AUTH_ERROR_MESSAGES = {
        'auth/invalid-email': 'Invalid email address.',
        'auth/user-disabled': 'This account has been disabled.',
        'auth/user-not-found': 'No account found with that email.',
        'auth/wrong-password':
          'Incorrect password. Please double-check and try again.',
        'auth/email-already-in-use':
          'This email is already in use. Try logging in instead.',
        'auth/weak-password':
          'Password too weak. Use at least 6 characters in length.',
        'auth/popup-blocked':
          'Popup was blocked by the browser. Allow popups and retry.',
        'auth/popup-closed-by-user':
          'Popup closed before finishing authentication.',
        'auth/account-exists-with-different-credential':
          'This email is linked to a different provider. Sign in with that provider first.',
      };

      const AUTH_INFO_CODES = new Set(['auth/popup-closed-by-user']);

      const authState = {
        currentUser: null,
        unsubscribe: null,
      };

      const toggleElement = (element, show) => {
        if (!element) return;
        element.classList.toggle('hidden', !show);
      };

      const setAuthLoading = (isLoading) => {
        authButtons.forEach((btn) => {
          btn.disabled = isLoading;
          btn.classList.toggle('opacity-60', isLoading);
          btn.classList.toggle('pointer-events-none', isLoading);
        });
      };

      const showAuthFeedback = (message, tone = 'info') => {
        if (!authFeedbackEl) return;
        if (!message) {
          authFeedbackEl.textContent = '';
          authFeedbackEl.classList.add('hidden');
          authFeedbackEl.classList.remove(
            'text-red-500',
            'text-emerald-500',
            'text-slate-500'
          );
          return;
        }

        authFeedbackEl.textContent = message;
        authFeedbackEl.classList.remove('hidden', 'text-red-500', 'text-emerald-500', 'text-slate-500');
        if (tone === 'success') {
          authFeedbackEl.classList.add('text-emerald-500');
        } else if (tone === 'info') {
          authFeedbackEl.classList.add('text-slate-500');
        } else {
          authFeedbackEl.classList.add('text-red-500');
        }
      };

      const describeUserLabel = (user) => {
        if (!user) return '‚Äî';
        if (isAnonymousUser(user)) {
          return `Anonymous #${user.uid.slice(-6)}`;
        }
        return user.displayName || user.email || `User ${user.uid.slice(-6)}`;
      };

      const updateAuthUI = (user) => {
        authState.currentUser = user;
        const hasUser = Boolean(user);
        const anonymous = hasUser ? isAnonymousUser(user) : true;

        authIdentityEl.textContent = describeUserLabel(user);

        if (!hasUser) {
          authStatusEl.textContent =
            'No active session. Establishing secure connection‚Ä¶';
        } else if (anonymous) {
          authStatusEl.textContent =
            'Anonymous session active. Sign in to sync usage across devices.';
        } else {
          const name =
            user.displayName || user.email || `User ${user.uid.slice(-6)}`;
          authStatusEl.textContent = `Signed in as ${name}. Sessions will sync to your account.`;
        }

        toggleElement(authAnonymousBadge, hasUser && anonymous);
        toggleElement(authLoginSection, !hasUser || anonymous);
        toggleElement(btnSignout, hasUser && !anonymous);

        if (hasUser && !anonymous) {
          if (authEmailInput) authEmailInput.value = '';
          if (authPasswordInput) authPasswordInput.value = '';
        }

        if (hasUser) {
          showAuthFeedback('');
        }

        setAuthLoading(false);
      };

      const handleAuthError = (error, fallbackMessage) => {
        if (!error) {
          showAuthFeedback(fallbackMessage || 'Authentication failed.', 'error');
          return;
        }
        const code = error.code;
        const message =
          AUTH_ERROR_MESSAGES[code] ||
          fallbackMessage ||
          error.message ||
          'Authentication failed.';

        const tone = AUTH_INFO_CODES.has(code) ? 'info' : 'error';
        if (tone === 'error') {
          console.error('[Auth] Error:', error);
        }
        showAuthFeedback(message, tone);
      };

      const initAuthFlow = async () => {
        try {
          authState.unsubscribe = await onAuthChanged((user) => {
            updateAuthUI(user);
          });
        } catch (error) {
          console.error('[Auth] Failed to attach listener:', error);
        }

        try {
          await ensureAnonymousUser();
        } catch (error) {
          console.error('[Auth] Unable to ensure anonymous user:', error);
          handleAuthError(error, 'Unable to start anonymous session.');
        }

        try {
          const user = await getCurrentUser();
          updateAuthUI(user);
        } catch (error) {
          console.error('[Auth] Failed to fetch current user:', error);
        }
      };

      btnLoginGoogle?.addEventListener('click', async () => {
        showAuthFeedback('');
        setAuthLoading(true);
        try {
          await signInWithGoogle();
          showAuthFeedback('Google sign-in successful.', 'success');
        } catch (error) {
          handleAuthError(error, 'Google sign-in failed.');
        } finally {
          setAuthLoading(false);
        }
      });

      btnLoginGitHub?.addEventListener('click', async () => {
        showAuthFeedback('');
        setAuthLoading(true);
        try {
          await signInWithGitHub();
          showAuthFeedback('GitHub sign-in successful.', 'success');
        } catch (error) {
          handleAuthError(error, 'GitHub sign-in failed.');
        } finally {
          setAuthLoading(false);
        }
      });

      btnEmailLogin?.addEventListener('click', async () => {
        const email = authEmailInput?.value.trim();
        const password = authPasswordInput?.value || '';

        if (!email || !password) {
          showAuthFeedback('Enter both email and password to login.', 'error');
          return;
        }

        showAuthFeedback('');
        setAuthLoading(true);

        try {
          await signInWithEmail(email, password);
          showAuthFeedback('Signed in with email.', 'success');
        } catch (error) {
          handleAuthError(error, 'Email sign-in failed.');
        } finally {
          setAuthLoading(false);
        }
      });

      btnEmailRegister?.addEventListener('click', async () => {
        const email = authEmailInput?.value.trim();
        const password = authPasswordInput?.value || '';

        if (!email || !password) {
          showAuthFeedback(
            'Provide email and password to create an account.',
            'error'
          );
          return;
        }

        showAuthFeedback('');
        setAuthLoading(true);

        try {
          await registerWithEmail(email, password);
          showAuthFeedback('Account created and signed in.', 'success');
        } catch (error) {
          handleAuthError(error, 'Registration failed.');
        } finally {
          setAuthLoading(false);
        }
      });

      btnSignout?.addEventListener('click', async () => {
        showAuthFeedback('');
        setAuthLoading(true);
        try {
          await signOutUser();
          await ensureAnonymousUser();
          showAuthFeedback('Signed out successfully.', 'success');
        } catch (error) {
          handleAuthError(error, 'Failed to sign out.');
        } finally {
          setAuthLoading(false);
        }
      });

      window.addEventListener('beforeunload', () => {
        if (typeof authState.unsubscribe === 'function') {
          authState.unsubscribe();
        }
      });

      initAuthFlow();

      const initBtn = document.getElementById('btn-init');
      const stopBtn = document.getElementById('btn-stop');

      const statusEl = document.getElementById('status');
      const audioMenu = document.getElementById('audio-menu');
      const audioDescriptionEl = document.getElementById('audio-description');
      const addAudioBtn = document.getElementById('btn-add-audio');
      const stopAllAudioBtn = document.getElementById('btn-stop-all-audio');
      const audioActiveList = document.getElementById('audio-active-list');
      const audioActiveEmpty = document.getElementById('audio-active-empty');
      const audioTrackCount = document.getElementById('audio-track-count');

      const visualMenu = document.getElementById('visual-menu');
      const visualDescriptionEl = document.getElementById('visual-description');
      const addVisualBtn = document.getElementById('btn-add-visual');
      const stopAllVisualBtn = document.getElementById('btn-stop-all-visual');
      const visualLayerContainer = document.getElementById(
        'visual-layer-container'
      );
      const visualActiveList = document.getElementById('visual-active-list');
      const visualActiveEmpty = document.getElementById('visual-active-empty');
      const visualTrackCount = document.getElementById('visual-track-count');
      const visualStatusText = document.getElementById('visual-status-text');

      const activeAudioTracks = new Map();
      const activeVisualTracks = new Map();

      const audioPresets = {
        sine: {
          label: 'Pure sine ‚Ä¢ 440Hz',
          description:
            'Pure sine tone at 440Hz for quick calibration and reference.',
          start: () => {
            const nodeId = engine.playWaveform({
              type: 'sine',
              freq: 440,
              gain: 0.2,
            });
            return {
              nodeId,
              detail: '440 Hz reference tone at moderate gain.',
            };
          },
        },
        binaural: {
          label: 'Binaural beat ‚Ä¢ Alpha 10Hz',
          description:
            'Stereo carriers offset by 10Hz promote relaxed alpha entrainment.',
          start: () => {
            const nodeId = engine.playBinaural({
              base: 200,
              beat: 10,
              duration: 0,
              gain: 0.25,
            });
            return {
              nodeId,
              detail: 'Carrier 200 Hz, beat 10 Hz (alpha window).',
            };
          },
        },
        monaural: {
          label: 'Monaural beat ‚Ä¢ Theta 6Hz',
          description:
            'Summed dual-tone beat for headphones or speakers, aimed at theta relaxation.',
          start: () => {
            const nodeId = engine.playMonaural({
              base: 210,
              beat: 6,
              duration: 0,
              gain: 0.3,
            });
            return {
              nodeId,
              detail: 'Carrier 210 Hz, beat 6 Hz (theta).',
            };
          },
        },
        isochronic: {
          label: 'Isochronic pulse ‚Ä¢ 12Hz breathing',
          description:
            'Amplitude-gated tone delivering crisp rhythmic cues for breath pacing.',
          start: () => {
            const nodeId = engine.playIsochronic({
              freq: 180,
              pulseFreq: 12,
              duration: null,
              gain: 0.22,
            });
            return {
              nodeId,
              detail: '180 Hz carrier with 12 Hz gating pulses.',
            };
          },
        },
        martigli: {
          label: 'Martigli harmonics',
          description:
            'Layered harmonic ratios inspired by Martigli sequences for rich texture.',
          start: () => {
            const nodeId = engine.playMartigliWave({
              fundamental: 220,
              harmonics: [1, 1.5, 2, 3, 5, 8, 13],
              duration: null,
              gain: 0.14,
              fadeIn: 0.6,
              fadeOut: 0.6,
            });
            return {
              nodeId,
              detail: 'Fundamental 220 Hz with Martigli/Fibonacci ratios.',
            };
          },
        },
        'noise-white': {
          label: 'Noise ‚Ä¢ White spectrum',
          description: 'Broad-spectrum white noise for masking and focus.',
          start: () => {
            const nodeId = engine.playNoise({
              type: 'white',
              duration: null,
              gain: 0.18,
            });
            return {
              nodeId,
              detail: 'Flat broadband spectrum.',
            };
          },
        },
        'noise-pink': {
          label: 'Noise ‚Ä¢ Pink spectrum',
          description:
            '1/f pink noise with gentle energy taper, supportive for relaxation.',
          start: () => {
            const nodeId = engine.playNoise({
              type: 'pink',
              duration: null,
              gain: 0.18,
            });
            return {
              nodeId,
              detail: 'Pink noise (1/f falloff).',
            };
          },
        },
        'noise-brown': {
          label: 'Noise ‚Ä¢ Brown spectrum',
          description:
            'Low-frequency weighted brown noise ideal for grounding and masking.',
          start: () => {
            const nodeId = engine.playNoise({
              type: 'brown',
              duration: null,
              gain: 0.22,
            });
            return {
              nodeId,
              detail: 'Brown noise with warm low emphasis.',
            };
          },
        },
      };

      const visualPresets = {
        blink: {
          label: 'Blinking colors',
          description:
            'High-contrast blinking palette to energize focus and breathing cadence.',
          start: () => {
            const layer = document.createElement('div');
            layer.className = 'visual-layer';
            layer.style.opacity = '0.9';
            visualLayerContainer.appendChild(layer);

            const palettes = [
              { inner: '#1d4ed8', outer: '#1e293b', scale: 1 },
              { inner: '#0ea5e9', outer: '#0369a1', scale: 1.03 },
              { inner: '#22d3ee', outer: '#14b8a6', scale: 0.98 },
              { inner: '#f97316', outer: '#c2410c', scale: 1.05 },
            ];
            let index = Math.floor(Math.random() * palettes.length);

            const applyPalette = () => {
              const { inner, outer, scale } = palettes[index];
              layer.style.background = `radial-gradient(circle at center, ${inner} 0%, ${outer} 78%)`;
              layer.style.transform = `scale(${scale ?? 1})`;
            };

            applyPalette();
            const interval = 250; // ‚âà4 Hz
            const timer = setInterval(() => {
              index = (index + 1) % palettes.length;
              applyPalette();
            }, interval);

            let active = true;
            const cleanup = () => {
              if (!active) return;
              active = false;
              clearInterval(timer);
              layer.remove();
            };

            return {
              element: layer,
              detail: '‚âà4 Hz multicolor pulse.',
              cleanup,
            };
          },
        },
        undulate: {
          label: 'Undulating colors',
          description:
            'Slow undulating gradients for ambient relaxation and coherence.',
          start: () => {
            const layer = document.createElement('div');
            layer.className = 'visual-layer';
            layer.style.opacity = '0.8';
            visualLayerContainer.appendChild(layer);

            let active = true;
            let phase = Math.random() * Math.PI * 2;
            let frameId = null;
            let last = performance.now();

            const animate = (now) => {
              if (!active) return;
              const delta = (now - last) / 1000;
              last = now;
              const targetHz = 9;
              phase += delta * targetHz * Math.PI * 2;

              const x = 50 + 35 * Math.sin(phase * 0.25);
              const y = 50 + 35 * Math.cos(phase * 0.31);
              const innerHue =
                (210 + 60 * Math.sin(phase * 0.5)) % 360;
              const midHue =
                (180 + 50 * Math.sin(phase * 0.35 + Math.PI / 4)) % 360;
              const outerHue =
                (200 + 40 * Math.cos(phase * 0.42)) % 360;
              const scale = 1 + 0.04 * Math.sin(phase * 0.18);
              const rotate = 2 * Math.sin(phase * 0.12);
              const opacity = 0.75 + 0.15 * Math.sin(phase * 0.1);

              layer.style.background = `radial-gradient(circle at ${x}% ${y}%, hsl(${innerHue}, 90%, 62%) 0%, hsl(${midHue}, 85%, 55%) 55%, hsl(${outerHue}, 80%, 48%) 100%)`;
              layer.style.transform = `scale(${scale.toFixed(
                3
              )}) rotate(${rotate.toFixed(2)}deg)`;
              layer.style.opacity = opacity.toFixed(3);

              frameId = requestAnimationFrame(animate);
            };

            frameId = requestAnimationFrame(animate);

            const cleanup = () => {
              if (!active) return;
              active = false;
              if (frameId) cancelAnimationFrame(frameId);
              layer.remove();
            };

            return {
              element: layer,
              detail: '‚âà9 Hz hue undulation with spatial drift.',
              cleanup,
            };
          },
        },
      };

      const updateAudioDescription = () => {
        const preset = audioPresets[audioMenu.value];
        audioDescriptionEl.textContent = preset
          ? preset.description
          : 'Select an audio feature to play.';
      };

      const updateVisualDescription = () => {
        const preset = visualPresets[visualMenu.value];
        visualDescriptionEl.textContent = preset
          ? preset.description
          : 'Select a visual feature to display.';
      };

      const renderAudioTracks = ({ message } = {}) => {
        audioActiveList.innerHTML = '';
        const entries = Array.from(activeAudioTracks.entries());
        const count = entries.length;

        audioTrackCount.textContent = `${count} layer${count === 1 ? '' : 's'}`;
        audioActiveEmpty.hidden = count !== 0;
        audioActiveList.hidden = count === 0;

        entries.forEach(([id, track]) => {
          const item = document.createElement('div');
          item.className = 'track-item';

          const info = document.createElement('div');
          info.className = 'flex-1 pr-4';

          const title = document.createElement('h4');
          title.textContent = track.label;
          info.appendChild(title);

          if (track.detail) {
            const detail = document.createElement('p');
            detail.textContent = track.detail;
            info.appendChild(detail);
          }

          const stopButton = document.createElement('button');
          stopButton.type = 'button';
          stopButton.dataset.trackId = id;
          stopButton.textContent = 'Stop';
          stopButton.classList.add('track-stop');

          item.appendChild(info);
          item.appendChild(stopButton);
          audioActiveList.appendChild(item);
        });

        if (!engine) return;

        if (message) {
          statusEl.textContent = message;
        } else if (count === 0) {
          statusEl.textContent = 'Audio engine ready. No active layers.';
        } else {
          statusEl.textContent = `${count} audio layer${
            count === 1 ? '' : 's'
          } running.`;
        }
      };

      const renderVisualTracks = ({ message } = {}) => {
        visualActiveList.innerHTML = '';
        const entries = Array.from(activeVisualTracks.entries());
        const count = entries.length;

        visualTrackCount.textContent = `${count} layer${
          count === 1 ? '' : 's'
        }`;
        visualActiveEmpty.hidden = count !== 0;
        visualActiveList.hidden = count === 0;

        entries.forEach(([id, track]) => {
          const item = document.createElement('div');
          item.className = 'track-item';

          const info = document.createElement('div');
          info.className = 'flex-1 pr-4';

          const title = document.createElement('h4');
          title.textContent = track.label;
          info.appendChild(title);

          if (track.detail) {
            const detail = document.createElement('p');
            detail.textContent = track.detail;
            info.appendChild(detail);
          }

          const stopButton = document.createElement('button');
          stopButton.type = 'button';
          stopButton.dataset.trackId = id;
          stopButton.textContent = 'Stop';
          stopButton.classList.add('track-stop');

          item.appendChild(info);
          item.appendChild(stopButton);
          visualActiveList.appendChild(item);
        });

        if (count === 0) {
          visualStatusText.textContent =
            message ?? 'Visual output appears here once started.';
          visualStatusText.classList.remove('active');
        } else {
          visualStatusText.textContent =
            message ??
            `Running ${count} visual layer${count === 1 ? '' : 's'}.`;
          visualStatusText.classList.add('active');
        }
      };

      const stopAllAudio = ({ message } = {}) => {
        if (engine) {
          try {
            engine.stopAll();
          } catch (error) {
            console.warn('Failed to stop audio nodes', error);
          }
        }
        activeAudioTracks.clear();
        renderAudioTracks({
          message: message ?? 'All audio layers stopped.',
        });
      };

      const stopAllVisual = ({ message } = {}) => {
        activeVisualTracks.forEach((track) => {
          try {
            track.cleanup();
          } catch (error) {
            console.warn('Failed to stop visual layer', error);
          }
        });
        activeVisualTracks.clear();
        renderVisualTracks({
          message: message ?? 'Visual layers cleared.',
        });
      };

      audioMenu.addEventListener('change', updateAudioDescription);
      visualMenu.addEventListener('change', updateVisualDescription);

      addAudioBtn.addEventListener('click', async () => {
        if (!engine) {
          alert('Initialize first!');
          return;
        }

        const presetKey = audioMenu.value;
        const preset = audioPresets[presetKey];
        if (!preset) return;

        try {
          await engine.resume();
          const result = preset.start();
          if (!result || !result.nodeId) {
            throw new Error('Preset did not return a node id');
          }

          const trackId = generateTrackId('audio');
          activeAudioTracks.set(trackId, {
            presetKey,
            label: preset.label,
            detail: result.detail || '',
            nodeId: result.nodeId,
            startedAt: Date.now(),
          });

          const count = activeAudioTracks.size;
          renderAudioTracks({
            message: `Started ${preset.label}. ${count} audio layer${
              count === 1 ? '' : 's'
            } active.`,
          });
        } catch (error) {
          console.error('Failed to start audio preset', error);
          statusEl.textContent = 'Unable to add audio track.';
        }
      });

      stopAllAudioBtn.addEventListener('click', () =>
        stopAllAudio({ message: 'All audio layers stopped.' })
      );

      audioActiveList.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-track-id]');
        if (!button) return;

        const trackId = button.dataset.trackId;
        const track = activeAudioTracks.get(trackId);
        if (!track) return;

        if (engine && track.nodeId) {
          try {
            engine.stop(track.nodeId);
          } catch (error) {
            console.warn('Failed to stop audio track', error);
          }
        }

        activeAudioTracks.delete(trackId);
        const count = activeAudioTracks.size;
        renderAudioTracks({
          message:
            count === 0
              ? 'Audio engine ready. No active layers.'
              : `Stopped ${track.label}. ${count} audio layer${
                  count === 1 ? '' : 's'
                } active.`,
        });
      });

      addVisualBtn.addEventListener('click', () => {
        const presetKey = visualMenu.value;
        const preset = visualPresets[presetKey];
        if (!preset) return;

        try {
          const result = preset.start();
          const cleanup =
            typeof result?.cleanup === 'function'
              ? result.cleanup
              : () => {};

          const trackId = generateTrackId('visual');
          activeVisualTracks.set(trackId, {
            presetKey,
            label: preset.label,
            detail: result?.detail || '',
            cleanup,
          });

          const count = activeVisualTracks.size;
          renderVisualTracks({
            message: `Started ${preset.label}. ${count} visual layer${
              count === 1 ? '' : 's'
            } active.`,
          });
        } catch (error) {
          console.error('Failed to start visual preset', error);
          renderVisualTracks({
            message: 'Unable to start visual preset.',
          });
        }
      });

      stopAllVisualBtn.addEventListener('click', () =>
        stopAllVisual({ message: 'Visual layers cleared.' })
      );

      visualActiveList.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-track-id]');
        if (!button) return;

        const trackId = button.dataset.trackId;
        const track = activeVisualTracks.get(trackId);
        if (!track) return;

        try {
          track.cleanup();
        } catch (error) {
          console.warn('Failed to cleanup visual track', error);
        }

        activeVisualTracks.delete(trackId);
        const count = activeVisualTracks.size;
        renderVisualTracks({
          message:
            count === 0
              ? 'Visual layers cleared.'
              : `Stopped ${track.label}. ${count} visual layer${
                  count === 1 ? '' : 's'
                } active.`,
        });
      });

      initBtn.addEventListener('click', async () => {
        if (!engine) {
          engine = new AudioEngine();
        }

        initBtn.disabled = true;
        try {
          await engine.init();
          statusEl.textContent =
            'Audio engine ready. Layer tracks freely.';
          initBtn.classList.add('hidden');
          stopBtn.classList.remove('hidden');
        } catch (error) {
          console.error('Failed to initialise audio engine', error);
          statusEl.textContent = 'Audio engine failed to initialise.';
        } finally {
          initBtn.disabled = false;
        }
      });

      stopBtn.addEventListener('click', () => {
        stopAllAudio({ message: 'All audio layers stopped.' });
        stopAllVisual({ message: 'Visual layers cleared.' });
      });

      updateAudioDescription();
      updateVisualDescription();
      renderAudioTracks();
      renderVisualTracks();
    </script>
  </body>
</html>
