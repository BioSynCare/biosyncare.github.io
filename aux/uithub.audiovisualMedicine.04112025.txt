├── .ctags
├── .gitignore
├── Makefile
├── app.js
├── assets
    ├── UFRJ-logo.png
    ├── aafav2.png
    ├── audio
    │   ├── aloop.mp3
    │   ├── boom.mp3
    │   └── ocean1.mp3
    ├── cityNames.json
    ├── cityNamesIT.json
    ├── csvToJson.py
    ├── donation
    │   ├── qrBitcoin.png
    │   └── qrPaypal.png
    ├── fav5.png
    ├── flags
    │   ├── br2.svg
    │   └── uk2.svg
    ├── loading.gif
    ├── text
    │   └── biblePt.txt
    └── worldcities.csv
├── index.html
├── nodemon.json
├── package-lock.json
├── package.json
├── scripts
    ├── bundle.js
    ├── main.js
    └── modules
    │   ├── conductor
    │       ├── index.js
    │       ├── instruments.js
    │       ├── nameGen.js
    │       ├── sync.js
    │       ├── tithorea.js
    │       ├── utils.js
    │       └── you.js
    │   ├── losdheaders.js
    │   ├── maestro.js
    │   ├── med
    │       ├── baseModel.js
    │       ├── common.js
    │       ├── doc.js
    │       ├── index.js
    │       ├── mk.js
    │       ├── model1.js
    │       ├── model2.js
    │       └── model3.js
    │   ├── monk
    │       ├── index.js
    │       └── prayers.js
    │   ├── net.js
    │   ├── router.js
    │   ├── test.js
    │   ├── transfer.js
    │   └── utils.js
└── you
    ├── imgs
        ├── person128.ico
        ├── person16.png
        ├── person32.ico
        └── person48.ico
    ├── imgs2
        ├── person128.ico
        ├── person16.ico
        ├── person32.ico
        └── person48.ico
    ├── manifest.json
    ├── pop.html
    └── scripts
        ├── background.js
        ├── content.js
        ├── fnetwork.js
        ├── ok
            ├── background.js
            ├── content.js
            └── pop.js
        └── pop.js


/.ctags:
--------------------------------------------------------------------------------
 1 | --recurse=yes
 2 | --exclude=.git
 3 | --exclude=BUILD
 4 | --exclude=.svn
 5 | --exclude=vendor/*
 6 | --exclude=node_modules/*
 7 | --exclude=scripts/bundle.js
 8 | --exclude=db/*
 9 | --exclude=log/*
10 | --exclude=\*.min.\*
11 | --exclude=\*.swp
12 | --exclude=\*.bak
13 | --exclude=\*.pyc
14 | --exclude=\*.class
15 | --exclude=\*.sln
16 | --exclude=\*.csproj
17 | --exclude=\*.csproj.user
18 | --exclude=\*.cache
19 | --exclude=\*.dll
20 | --exclude=\*.pdb
21 |


--------------------------------------------------------------------------------
/.gitignore:
--------------------------------------------------------------------------------
1 | node_modules
2 | tags
3 | .DS_Store
4 |


--------------------------------------------------------------------------------
/Makefile:
--------------------------------------------------------------------------------
 1 | # new va, cleaner, rewritten:
 2 | i:
 3 | 	npm i
 4 | d:
 5 | 	npm run dev
 6 | e:
 7 | 	npm run buildExt
 8 | fix:
 9 | 	npm run fixme
10 | e-zip:
11 | 	npm run buildEzip && cd you && zip -vr ../you.zip background_ok.js contentScript_ok.js manifest.json person_.png pop.html pop_ok.js
12 |
13 | backup:
14 | 	python3 mkBackup.py
15 |
16 | # testing of the client code must be performed on the client. The /test page should be accessed,
17 | # e.g. https://0.0.0.0:8080/test/
18 |
19 |
20 | # auxiliary targets:   ################################################################
21 | # create binomial/random bipartite networks in aux_server/data/
22 | mk-random-nets:
23 | 	python3 aux_server/utils/generateNcol.py
24 |
25 | # example usage of mlpb, implemented in the aux_server/server.py, is in:
26 | # aux_server/utils/IOmlpb.py
27 |


--------------------------------------------------------------------------------
/app.js:
--------------------------------------------------------------------------------
 1 | const http = require('http')
 2 | const path = require('path')
 3 | const fs = require('fs')
 4 | const port = 8082
 5 | http.createServer(function (req, res) {
 6 |   const url = 'http://localhost:8083' + req.url // this is ok because framework is to work without the server
 7 |   const filePath = new URL(url).pathname === '/' ? './index.html' : '.' + req.url
 8 |   const extname = req.url.includes('.html') ? '.html' : String(path.extname(filePath)).toLowerCase()
 9 |   const mimeTypes = {
10 |     '.html': 'text/html',
11 |     '.js': 'text/javascript',
12 |     '.css': 'text/css',
13 |     '.json': 'application/json',
14 |     '.png': 'image/png',
15 |     '.jpg': 'image/jpg',
16 |     '.gif': 'image/gif',
17 |     '.svg': 'image/svg+xml',
18 |     '.wav': 'audio/wav',
19 |     '.mp3': 'audio/mpeg',
20 |     '.mp4': 'video/mp4',
21 |     '.woff': 'application/font-woff',
22 |     '.ttf': 'application/font-ttf',
23 |     '.eot': 'application/vnd.ms-fontobject',
24 |     '.otf': 'application/font-otf',
25 |     '.wasm': 'application/wasm'
26 |   }
27 |   const contentType = mimeTypes[extname] || 'application/octet-stream'
28 |   fs.readFile(filePath, function (error, content) {
29 |     if (error) {
30 |       if (error.code === 'ENOENT') {
31 |         fs.readFile('./public/404.html', function (error, content) {
32 |           res.writeHead(404, { 'Content-Type': 'text/html' })
33 |           res.end(content, error, 'utf-8')
34 |         })
35 |       } else {
36 |         res.writeHead(500)
37 |         res.end('Sorry, check with the site admin for error: ' + error.code + ' ..\n')
38 |       }
39 |     } else {
40 |       res.writeHead(200, { 'Content-Type': contentType })
41 |       res.end(content, 'utf-8')
42 |     }
43 |   })
44 | }).listen(port)
45 | console.log('listening in port: ', port)
46 |


--------------------------------------------------------------------------------
/assets/UFRJ-logo.png:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/assets/UFRJ-logo.png


--------------------------------------------------------------------------------
/assets/aafav2.png:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/assets/aafav2.png


--------------------------------------------------------------------------------
/assets/audio/aloop.mp3:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/assets/audio/aloop.mp3


--------------------------------------------------------------------------------
/assets/audio/boom.mp3:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/assets/audio/boom.mp3


--------------------------------------------------------------------------------
/assets/audio/ocean1.mp3:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/assets/audio/ocean1.mp3


--------------------------------------------------------------------------------
/assets/cityNamesIT.json:
--------------------------------------------------------------------------------
1 | ["Rome", "Milan", "Naples", "Turin", "Palermo", "Genoa", "Bologna", "Florence", "Bari", "Catania", "Verona", "Venice", "Messina", "Padova", "Cosenza", "Trieste", "Parma", "Brescia", "Prato", "Taranto", "Modena", "Reggio di Calabria", "Reggio Emilia", "Perugia", "Ravenna", "Livorno", "Rimini", "Cagliari", "Foggia", "Ferrara", "Latina", "Salerno", "Giugliano in Campania", "Monza", "Sassari", "Bergamo", "Pescara", "Trento", "Forl\u00ec", "Siracusa", "Vicenza", "Terni", "Bolzano", "Roncaglia", "Piacenza", "Novara", "Ancona", "Udine", "Andria", "Arezzo", "Cesena", "Pesaro", "Lecce", "Barletta", "La Spezia", "Alessandria", "Mestre", "Pistoia", "Lucca", "Pisa", "Catanzaro", "Treviso", "Como", "Busto Arsizio", "Brindisi", "Fiumicino", "Grosseto", "Torre del Greco", "Marsala", "Sesto San Giovanni", "Varese", "Pozzuoli", "Cinisello Balsamo", "Aprilia", "Casoria", "Asti", "Ragusa", "Caserta", "Carpi", "Gela", "Cremona", "Pavia", "Altamura", "L\u2019Aquila", "Imola", "Quartu Sant\u2019Elena", "Sant\u2019Eufemia Lamezia", "Acilia", "Calimera", "Massa", "Viterbo", "Potenza", "Pomezia", "Vittoria", "Marina di Carrara", "Castellammare di Stabia", "Vigevano", "Afragola", "Olbia", "Viareggio", "Legnano", "Carrara", "Fano", "Matera", "Anzio", "Faenza", "Caltanissetta", "Crotone", "Benevento", "Acerra", "Savona", "Marano di Napoli", "Molfetta", "Cerignola", "Moncalieri", "Cuneo", "Trapani", "Agrigento", "Foligno", "Trani", "Tivoli", "Manfredonia", "Bisceglie", "Modica", "Montesilvano", "Bitonto", "Bagheria", "Siena", "Gallarate", "San Remo", "Velletri", "Avellino", "Portici", "Pordenone", "Civitavecchia", "Teramo", "Cava de\u2019 Tirreni", "Acireale", "Rho", "Ercolano", "Mazara del Vallo", "Rovigo", "Aversa", "Battipaglia", "Scandicci", "San Severo", "Ardea", "Misterbianco", "Empoli", "Sesto Fiorentino", "Mantova", "Chieti", "Collegno", "Scafati", "Nettuno", "Monopoli", "Chioggia", "Campi Bisenzio", "Rivoli", "Paderno Dugnano", "Campobasso", "Corato", "Casalnuovo di Napoli", "San Benedetto del Tronto", "Martina Franca", "Lecco", "Cologno Monzese", "Lissone", "Marino", "Capannori", "Nichelino", "Settimo Torinese", "Ascoli Piceno", "Rieti", "Vercelli", "Paterno", "Seregno", "Cascina", "Terracina", "Lodi", "Alcamo", "Nocera Inferiore", "Senigallia", "Frosinone", "Gravina in Puglia", "Biella", "San Giorgio a Cremano", "Bassano del Grappa", "Alghero", "Imperia", "Civitanova Marche", "San Don\u00e0 di Piave", "Desio", "Rozzano", "Merano", "Monterotondo", "Sassuolo", "Vasto", "Avezzano", "Ladispoli", "Macerata", "Corigliano Calabro", "Torre Annunziata", "Nicastro", "Barcellona-Pozzo di Gotto", "Rovereto", "Carini", "Albano Laziale", "Cant\u00f9", "Pomigliano d\u2019Arco", "Fondi", "San Giuliano Milanese", "Cesano Maderno", "Iesi", "Sciacca", "Fasano", "Monreale", "Voghera", "Ciampino", "Schio", "Saronno", "Marcianise", "Azzano", "Citt\u00e0 di Castello", "Cerveteri", "Mira", "Eboli", "Formia", "Segrate", "Grugliasco", "Maddaloni", "Rossano", "Rende", "Spoleto", "Melito di Napoli", "Modugno", "Bollate", "Cisterna di Latina", "Pioltello", "Chieri", "Caivano", "Fermo", "Caltagirone", "Belluno", "Pinerolo", "Casalecchio di Reno", "Cento", "Cassino", "Brugherio", "Francavilla Fontana", "Cernusco sul Naviglio", "Limbiate", "Osimo", "Augusta", "Mugnano di Napoli", "Nola", "Formigine", "Canicatt\u00ec", "Riccione Marina", "Corsico", "Conegliano", "Licata", "Pagani", "Angri", "Lanciano", "Adrano", "Nuoro", "Crema", "Somma Vesuviana", "Gorizia", "Aosta", "Castelfranco Emilia", "Villafranca di Verona", "Castelfranco Veneto", "San Lazzaro di Savena", "Abbiategrasso", "Lugo", "Sant\u2019Antimo", "Venaria Reale", "Termoli", "Casale Monferrato", "Piombino", "San Donato Milanese", "Arzano", "Mascalucia", "Massafra", "Santa Maria Capua Vetere", "Camaiore", "Favara", "Villaricca", "Alba", "Montebelluna", "Vibo Valentia", "Lucera", "Nard\u00f2", "Treviglio", "Partinico", "San Giuliano Terme", "Grottaglie", "Sarno", "Gubbio", "Avola", "Oristano", "Ostuni", "San Giuseppe Vesuviano", "Rosignano Marittimo", "Milazzo", "Comiso", "Verbania", "Manduria", "Monfalcone", "Bra", "Pontedera", "Castelvetrano", "Desenzano del Garda", "Rapallo", "Marigliano", "Pirri", "Cervia", "Fabriano", "Misilmeri", "Mondragone", "Frattamaggiore", "Selargius", "Castel Volturno", "Poggibonsi", "Carmagnola", "Belpasso", "Gragnano", "Canosa di Puglia", "Cecina", "Aci Catena", "Parabiago", "Mogliano Veneto", "San Giovanni in Persiceto", "San Miniato", "Spinea", "Alatri", "Assisi", "Chiavari", "Novi Ligure", "Mirano", "Vittorio Veneto", "Fidenza", "Albignasego", "Scicli", "Garbagnate Milanese", "Quarrata", "Gioia del Colle", "Iesolo", "Giarre", "Lido di Iesolo", "Tortona", "Carbonia", "San Giovanni Rotondo", "Lainate", "Chivasso", "Sant\u2019Anastasia", "Mesagne", "Montichiari", "Terlizzi", "Erice", "Bresso", "Giussano", "Boscoreale", "Putignano", "Cesenatico", "Noicattaro", "Galatina", "Vimercate", "Triggiano", "Ass\u00e8mini", "Vignola", "Conversano", "Santeramo in Colle", "Scandiano", "Francavilla al Mare", "Valdagno", "Porto Sant\u2019Elpidio", "Falconara Marittima", "Enna", "Roseto degli Abruzzi", "Legnago", "San Giovanni Lupatoto", "Arzignano", "Seriate", "Mariano Comense", "Bacoli", "Bagno a Ripoli", "Iglesias", "Correggio", "Niscemi", "Termini Imerese", "Sora", "Qualiano", "Mola di Bari", "Ruvo di Puglia", "Portogruaro", "Noto", "Fossano", "Magenta", "Mirandola", "Montevarchi", "Pompei", "Seveso", "Thiene", "Nocera Superiore", "San Giovanni la Punta", "Sezze", "Castiglione delle Stiviere", "Muggi\u00f2", "Meda", "Albenga", "Giulianova", "Montecchio Maggiore", "Dalmine", "Capoterra", "Ottaviano", "Vigonza", "Orbassano", "Copertino", "Nova Milanese", "Biancavilla", "Pietrasanta", "Genzano di Roma", "Ventimiglia", "Selvazzano Dentro", "Bressanone", "Frascati", "Fucecchio", "Mentana", "Ivrea", "Ceccano", "Poggiomarino", "Ortona", "Sulmona", "Sant\u2019Arcangelo di Romagna", "Palestrina", "Mondov\u00ec", "Comacchio", "Paese", "Ginosa", "Massarosa", "Pachino", "Sarzana", "Lentini", "Mercato San Severino", "Savigliano", "Pergine Valsugana", "Colle di Val d\u2019Elsa", "Corciano", "Cardito", "Trezzano sul Naviglio", "San Bonifacio", "Palma di Montechiaro", "Senago", "Casal di Principe", "Agropoli", "Borgomanero", "Floridia", "Cortona", "Martellago", "Gorgonzola", "Sondrio", "Porto Torres", "Ariano Irpino", "Suzzara", "San Cataldo", "Argenta", "Castrovillari", "Sestu", "Castel San Pietro Terme", "Anagni", "Monsummano", "Montecatini Terme", "Bussolengo", "Recanati", "Cornaredo", "Piazza Armerina", "Isernia", "Rosolini", "Palo del Colle", "Romano di Lombardia", "Colleferro", "Trecate", "Grottaferrata", "Follonica", "Feltre", "Cormano", "Trentola", "Minturno", "Vico Equense", "Abano Terme", "Sessa Aurunca", "Rivalta di Torino", "Pontassieve", "Pallazzolo sull\u2019Oglio", "Montalto Uffugo", "Ferentino", "Cittadella", "Oderzo", "Piove di Sacco", "Salsomaggiore Terme", "Acquaviva delle Fonti", "Novate Milanese", "Sacile", "Viadana", "San Salvo", "Villabate", "Veroli", "Ischia", "Lastra a Signa", "Gallipoli", "Arese", "Castellana Grotte", "Orvieto", "Sabaudia", "Gaeta", "Casarano", "Giovinazzo", "Casamassima", "Rovato", "Cassano d\u2019Adda", "Pescia", "Vigna di Valle", "Zola Predosa", "Gioia Tauro", "Chiari", "Montemurlo", "Anguillara Sabazia", "Sant\u2019Antonio Abate", "Spoltore", "Scorz\u00e8", "Acqui Terme", "Casalgrande", "Monserrato", "Pozzallo", "Signa", "Acri", "Tradate", "Cusano Milanino", "Ceglie Messapico", "Adria", "San Mauro Torinese", "Ghedi", "Zagarolo", "Castel Maggiore", "Castelfidardo", "Santa Marinella", "Bracciano", "Noci", "Melzo", "Rutigliano", "Budrio", "Bronte", "Laives", "Corbetta", "Ciri\u00e8", "Pavullo nel Frignano", "San Vito dei Normanni", "Borgo San Lorenzo", "Calenzano", "Valenza", "Piossasco", "Marsciano", "Aci Sant\u2019Antonio", "Ariccia", "Melegnano", "Agliana", "Palmi", "Narni", "Tolentino", "Aci Castello", "Savignano sul Rubicone", "Ribera", "Policoro", "Arcore", "Carate Brianza", "Cordenons", "Somma Lombardo", "Arco", "Domodossola", "Pianoro", "Capua", "Siderno Marina", "Marcon", "Sona", "Polignano a Mare", "Villorba", "Rocca di Papa", "Saluzzo", "Albino", "Forio", "Pescantina", "Isola Capo Rizzuto", "Beinasco", "Santa Maria di Sala", "Sestri Levante", "Valenzano", "Riva del Garda", "Maranello", "Monselice", "Castelfiorentino", "Bareggio", "Terzigno", "S\u00ecnnai", "Grumo Nevano", "Tricase", "Figline Valdarno", "Melfi", "Carlentini", "Brunico", "Cercola", "Carovigno", "Nerviano", "Rubano", "Fiorano Modenese", "Baronissi", "Cerea", "Orta Nova", "Bovisio Masciago", "Vimodrone", "Preganziol", "Pisticci", "Campagna", "Medicina", "San Giovanni Valdarno", "Cattolica", "Gussago", "Torre Maggiore", "Cassano al Ionio", "Sant\u2019Elpidio a Mare", "Alpignano", "Adelfia", "Reggello", "San Casciano in Val di Pesa", "Vedelago", "Malnate", "Erba", "Bagnacavallo", "Lein\u00ec", "Umbertide", "Colle Salvetti", "Martinsicuro", "Ispica", "Fiano Romano", "San Martino Buon Albergo", "Giaveno", "Palma Campania", "Castellaneta", "Castenaso", "Caravaggio", "Noale", "Nonantola", "Bovolone", "Scordia", "Samarate", "San Cesareo", "Este", "Valeggio sul Mincio", "Tarquinia", "San Giovanni in Fiore", "Concorezzo", "Brusciano", "Codroipo", "Lonigo", "Grottammare", "Saviano", "Cadoneghe", "Lentate sul Seveso", "Palagiano", "Palagonia", "Altopascio", "Carugate", "Todi", "Azzano Decimo", "Copparo", "Valmontone", "Molinella", "Porto San Giorgio", "Porto Empedocle", "Ponsacco", "Crusinallo", "Galliate", "Zevio", "Agrate Brianza", "Codogno", "Certaldo", "Casalpusterlengo", "Pianezza", "Soliera", "Sorrento", "Potenza Picena", "Besana in Brianza", "Silvi Paese", "Mortara", "Frattaminore", "Sava", "Mottola", "Civita Castellana", "Volpiano", "Castellarano", "Capurso", "San Vito al Tagliamento", "Castiglione del Lago", "Sansepolcro", "Galatone", "Campodarsego", "Pedara", "Pontinia", "Cassano delle Murge", "Sant\u2019Arpino", "Casalmaggiore", "Porcia", "Castelnuovo Rangone", "Dolo", "Finale Emilia", "Cerro Maggiore", "Fiorenzuola d\u2019Arda", "Taurianova", "Merate", "Citt\u00e0 Sant\u2019Angelo", "Laterza", "Sasso Marconi", "Paola", "Santa Croce sull\u2019 Arno", "Surbo", "Ospitaletto", "Collecchio", "Rubiera", "Corridonia", "Malo", "Ros\u00e0", "Magione", "Roncade", "Castellammare del Golfo", "Carmignano", "Guastalla", "Pineto", "Oria", "Sommacampagna", "Tavagnacco", "Vinci", "Sorso", "Impruneta", "Rosarno", "Leno", "Mascali", "Omegna", "Orbetello", "Chiaravalle", "Gualdo Tadino", "Santa Maria a Vico", "Mondolfo", "Opera", "San Giorgio Ionico", "Oleggio", "Rescaldina", "Montelupo Fiorentino", "Massalubrense", "Villasanta", "Luino", "Trepuzzi", "Castel San Giovanni", "Fisciano", "Cir\u00f2 Marina", "Riposto", "Busto Garolfo", "Cassina de\u2019 Pecchi", "Misano Adriatico", "Marostica", "Castellanza", "Locorotondo", "Cossato", "Cefal\u00f9", "Caselle Torinese", "Solaro", "Amantea", "Trinitapoli", "Fara in Sabina", "Strada", "Sannicandro Garganico", "Varedo", "Leverano", "Taggia", "Travagliato", "Bondeno", "Priverno", "Urbino", "Taglio", "Crevalcore", "Arona", "Castel San Giorgio", "San Ferdinando di Puglia", "Fiesole", "Maglie", "Artena", "Formello", "Dueville", "Cervignano del Friuli", "Latiano", "Castelfranco di Sotto", "Calolziocorte", "Calderara di Reno", "Stezzano", "Squinzano", "Monteroni di Lecce", "Veglie", "Vieste", "Arzachena", "Rezzato", "Alzano Lombardo", "Sant\u2019Angelo Lodigiano", "Santa Maria a Monte", "Manerbio", "Ponte San Giovanni", "Vetralla", "Montepulciano", "Montespertoli", "Casandrino", "Casatenovo", "Lariano", "San Martino di Lupari", "Novellara", "Noceto", "Tempio Pausania", "Villacidro", "Castelnuovo di Verona", "Melilli", "Casale sul Sile", "Vigodarzere", "Crispiano", "Latisana", "Sarezzo", "Quattro Castella", "Pavona", "Forlimpopoli", "Capo d\u2019Orlando", "San Pietro Vernotico", "Lavello", "Ficarazzi", "Turi", "Montesarchio", "Montefiascone", "Carpenedolo", "Camponogara", "Trebaseleghe", "Tezze sul Brenta", "Castiglion Fiorentino", "Statte", "Loreto", "Monteprandone", "Palombara Sabina", "M\u00faggia", "Calcinato", "Lanuvio", "Cavallino", "San Pietro in Casale", "Terrasini Favarotta", "Quartucciu", "Spilamberto", "Fontanafredda", "Salzano", "Sedriano", "Granarolo del l\u2019Emilia", "Villa San Giovanni", "Cavarzere", "Calcinaia", "Patti", "Gricignano d\u2019Aversa", "Nicosia", "Olgiate Olona", "Cairo Montenotte", "Santo Stino di Livenza", "San Biagio di Callalta", "San Marco in Lamis", "Castel Goffredo", "Apricena", "Lipari", "Varazze", "Chiampo", "Montegranaro", "Borgo San Dalmazzo", "Rionero in Vulture", "Canegrate", "Lana", "Fagnano Olona", "Bagnolo Mella", "Villa Literno", "Campiglia Marittima", "Grammichele", "Calvizzano", "Orzinuovi", "Anzola dell\u2019Emilia", "Avigliana", "Seravezza", "Porto Recanati", "Piano di Sorrento", "Arluno", "Pontecorvo", "Leonforte", "Biassono", "Lavagna", "Rivarolo Canavese", "Cicciano", "Gavardo", "Spresiano", "Sala Consilina", "Morbegno", "Rottofreno", "Montecorvino Rovella", "Russi", "San Mauro Pascoli", "Pianiga", "Grumo Appula", "San Prisco", "Motta Sant\u2019Anastasia", "Borgosesia", "Ugento", "Sinalunga", "Solofra", "Rocca Priora", "Occhiobello", "Monte San Giovanni Campano", "Raffadali", "San Gennaro Vesuviano", "Cecchina", "Eraclea", "Bernalda", "Terranuova Bracciolini", "Trezzo sull\u2019Adda", "Cinisi", "Lauria Inferiore", "San Severino Marche", "Altavilla Vicentina", "Sant\u2019Agata di Militello", "Olgiate Comasco", "Monte Compatri", "Sant\u2019Ambrogio di Valpolicella", "Monte di Procida", "Lizzanello", "Locri", "Spilimbergo", "Bibbiena", "Vecchiano", "Baranzate", "Camposampiero", "Menfi", "Barrafranca", "Portoferraio", "Susegana", "Tortoreto", "Ronchi dei Legionari", "Portomaggiore", "Fiume Veneto", "Borgaro Torinese", "Bitetto", "Francofonte", "Serravalle Pistoiese", "Mestrino", "Carmiano", "Torri di Quartesolo", "Cornedo Vicentino", "Ponte San Pietro", "Marotta", "Zero Branco", "Casteldaccia", "Castenedolo", "Isola della Scala", "Amelia", "Pieve di Soligo", "Maniago", "Giffoni Valle Piana", "Taviano", "Mercogliano", "San Gregorio di Catania", "Alfonsine", "Lendinara", "Stradella", "Casi\u00e8r", "San Michele al Tagliamento", "Montegrotto Terme", "Campobello di Mazara", "Musile di Piave", "Lonate Pozzolo", "Gardone Val Trompia", "Monte Sant\u2019Angelo", "Taurisano", "Capaci", "Bitritto", "Caldogno", "Teano", "Trecastagni", "Sant\u2019Ilario d\u2019Enza", "Priolo Gargallo", "Scalea", "Inzago", "Monteforte Irpino", "Montechiarugolo", "Nembro", "Carbonera", "Siniscola", "Montopoli in Val d\u2019Arno", "Penne", "Margherita di Savoia", "Creazzo", "Finale Ligure", "Pulsano", "Cerese", "Cisternino", "Valmadrera", "Camisano Vicentino", "Caorle", "Castelvetro di Modena", "Paullo", "Piazzola sul Brenta", "Arenzano", "Codigoro", "Cologno al Serio", "San Giustino", "Bertinoro", "Santa Flavia", "Matino", "Guspini", "Santa Croce Camerina", "Sesto Calende", "Campagnano di Roma", "Peschiera del Garda", "Tortol\u00ec", "Cepagatti", "Mazzarino", "Pellezzano", "Barberino di Mugello", "Venosa", "Castel Mella", "Belmonte Mezzagno", "Venafro", "Cividale del Friuli", "San Valentino Torio", "Castano Primo", "Capena", "Cornate d\u2019Adda", "Paceco", "Ovada", "Cave", "Langhirano", "Racale", "Isola del Liri", "Martinengo", "Motta di Livenza", "Monte San Pietro", "Grezzana", "Campolongo Maggiore", "Botticino Sera", "Loano", "San Felice sul Panaro", "Trevignano", "Medesano", "Gambettola", "Cerreto Guidi", "Cazzago San Martino", "Cameri", "Aulla", "Sant\u2019Ant\u00ecoco", "Avigliano", "Cadelbosco di Sopra", "Massa Lombarda", "La Maddalena", "Trofarello", "Acate", "Trabia", "Nave", "Usmate Velate", "Montale", "Riesi", "Taormina", "Gemona del Friuli", "Melito di Porto Salvo", "Coriano", "Sal\u00f2", "Cislago", "Montecchio Emilia", "Atripalda", "Cori", "Corleone", "Itri", "Bonate di Sopra", "Ravanusa", "Silea", "Atessa", "Riano", "Locate di Triulzi", "Castelli Calepio", "Castelnovo ne\u2019 Monti", "Sant\u2019Agata de\u2019 Goti", "Oppeano", "San Maurizio Canavese", "Alberobello", "Induno Olona", "San Marzano sul Sarno", "Vigasio", "Concordia Sagittaria", "Isola Vicentina", "Ramacca", "Celano", "Randazzo", "Poirino", "Bomporto", "Bordighera", "Arcola", "Busca", "Bibbiano", "San Felice Circeo", "Rignano Flaminio", "Sedico", "Torre Santa Susanna", "Mori", "Nizza Monferrato", "Procida", "Fiuggi", "Novi di Modena", "Badia Polesine", "Alassio", "Macerata Campania", "Verucchio", "Sermoneta", "Volpago del Montello", "Goito", "Canelli", "Montignoso", "Capodrise", "Atri", "Melendugno", "Monteriggioni", "Salemi", "Valdobbiadene", "Quinto di Treviso", "Barano d\u2019Ischia", "Conselve", "Fino Mornasco", "Bucine", "Mussomeli", "Mandello del Lario", "Polistena", "Vaiano", "Lomazzo", "Asola", "Urgnano", "Campi Salentina", "Meldola", "Poggio a Caiano", "Sovicille", "Santo Stefano di Magra", "Altofonte", "Cavriago", "Partanna", "Ozieri", "Vigonovo", "Tolmezzo", "Castelletto sopra Ticino", "Morrovalle", "San Vendemiano", "Boscotrecase", "Trescore Balneario", "Bagnolo in Piano", "Cittanova", "Montemarciano", "Sant\u2019Egidio alla Vibrata", "Gambol\u00f2", "San Giorgio del Sannio", "Terralba", "Poggio Renatico", "Crosia", "Lurate Caccivio", "Castellamonte", "San Lorenzo della Costa", "Broni", "Argelato", "Racconigi", "Boves", "Sannicandro di Bari", "Casaluce", "Cingoli", "Lizzano", "Cesa", "Savignano sul Panaro", "Sorbolo", "Traversetolo", "Conselice", "Volterra", "Castel Bolognese", "Cuorgn\u00e8", "Castelfranco di Sopra", "Vaprio d\u2019Adda", "Garlasco", "Bisignano", "Cherasco", "Legnaro", "Mareno di Piave", "Dolianova", "Deruta", "Lerici", "Barga", "Cavriglia", "San Giovanni in Marignano", "Siano", "Bellinzago Novarese", "Elmas", "Recco", "Piombino Dese", "Resana", "Magnago", "Cetraro", "Capriolo", "Cutro", "Nepi", "Cermenate", "San Giorgio di Piano", "Ruffano", "Santa Teresa di Riva", "Macomer", "Vanzago", "Gatteo", "Zafferana Etnea", "Gassino Torinese", "Marano Vicentino", "San Pancrazio Salentino", "Bagnara Calabra", "Gaggiano", "Pasian di Prato", "Vittuone", "Loria", "Montescaglioso", "Giardini", "Brugnera", "Castelleone", "Inverigo", "Castrolibero", "Vignate", "Matelica", "Reggiolo", "Felino", "Lavis", "Maserada sul Piave", "Santa Lucia di Piave", "Gavirate", "Malalbergo", "Maser\u00e0 di Padova", "Istrana", "Carignano", "Mendicino", "Fiumefreddo di Sicilia", "Mosciano Sant\u2019Angelo", "Orte", "Oggiono", "Campobello di Licata", "Lacchiarella", "Borgosatollo", "Fossombrone", "Podenzano", "Monteroni d\u2019Arbia", "Villa Castelli", "Porto Tolle", "Monticello Conte Otto", "Foiano della Chiana", "Treia", "Venturina", "Druento", "Iseo", "Borgoricco", "Segni", "Noventa Vicentina", "Aviano", "Colorno", "Montagnana", "Monteforte d\u2019Alpone", "Castelnuovo Berardenga", "Filottrano", "Asolo", "Belvedere Marittimo", "San Marzano di San Giuseppe", "Tarcento", "Minerbio", "Teolo", "Sorisole", "Viagrande", "Striano", "Pandino", "Aradeo", "Casorate Primo", "Tirano", "Missaglia", "Albinea", "Soresina", "Porto Santo Stefano", "Ala", "Uta", "Porcari", "La Loggia", "Costa Volpino", "Gessate", "Luzzi", "Aragona", "Pizzo", "Borgo a Buggiano", "Sant\u2019Angelo in Lizzola", "Mozzate", "Coccaglio", "Castagneto Carducci", "Civitella in Val di Chiana", "Roccastrada", "Parabita", "Folignano", "C\u00e0bras", "Montalto di Castro", "Cutrofiano", "Ponte Buggianese", "Besozzo", "Roccapiemonte", "Flero", "Caprino Veronese", "Gonzaga", "Roverbella", "Torre Boldone", "Lequile", "Zanica", "Brandizzo", "Castellabate", "Triuggio", "Altavilla Milicia", "San Sebastiano al Vesuvio", "Serramazzoni", "Bovalino Marina", "Vergiate", "Sant\u2019Agnello", "Martano", "Trissino", "Soverato Marina", "Petilia Policastro", "Aurisina", "Bientina", "Serramanna", "Monte Porzio Catone", "Trebisacce", "Castelnuovo di Porto", "Castel Gandolfo", "Vicopisano", "Brembate", "Troina", "Monte San Savino", "Zogno", "Clusone", "Santa Margherita Ligure", "Campogalliano", "Rignano sull\u2019Arno"]


--------------------------------------------------------------------------------
/assets/csvToJson.py:
--------------------------------------------------------------------------------
 1 | import csv, json
 2 | cities = []
 3 | with open('worldCities.csv') as c:
 4 |     r = csv.reader(c)
 5 |     for row in r:
 6 |         cities.append(row)
 7 |
 8 | names = [c[0] for c in cities[1:]]  # for
 9 |
10 | with open('cityNames.json', 'w') as f:
11 |     json.dump(names, f)
12 |
13 | namesIt = [c[0] for c in cities if c[5] == 'IT']
14 | with open('cityNamesIT.json', 'w') as f:
15 |     json.dump(namesIt, f)
16 |
17 |
18 |


--------------------------------------------------------------------------------
/assets/donation/qrBitcoin.png:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/assets/donation/qrBitcoin.png


--------------------------------------------------------------------------------
/assets/donation/qrPaypal.png:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/assets/donation/qrPaypal.png


--------------------------------------------------------------------------------
/assets/fav5.png:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/assets/fav5.png


--------------------------------------------------------------------------------
/assets/flags/br2.svg:
--------------------------------------------------------------------------------
 1 | <svg xmlns="http://www.w3.org/2000/svg" height="480" width="640" viewBox="0 0 640 480">
 2 |   <g stroke-width="1pt">
 3 |     <path fill-rule="evenodd" fill="#229e45" d="M0 0h640v480H0z"/>
 4 |     <path d="M321.406 435.935l301.483-195.67-303.308-196.2L17.11 240.734l304.296 195.2z" fill-rule="evenodd" fill="#f8e509"/>
 5 |     <path d="M452.77 240.005c0 70.328-57.103 127.34-127.544 127.34-70.442 0-127.544-57.012-127.544-127.34s57.104-127.34 127.544-127.34c70.442 0 127.545 57.012 127.545 127.34z" fill-rule="evenodd" fill="#2b49a3"/>
 6 |     <path fill="#ffffef" fill-rule="evenodd" d="M283.3 316.274L279.357 314l-4.093 2.025.917-4.55-3.162-3.332 4.52-.53 2.124-4.08 1.894 4.22 4.46.81-3.345 3.13m86.098 26.224l-3.94-2.274-4.092 2.025.916-4.55-3.16-3.332 4.52-.53 2.122-4.08 1.894 4.22 4.46.81-3.345 3.13m-36.215-29.993l-3.404-1.964-3.536 1.748.792-3.93-2.73-2.88 3.904-.457 1.834-3.523 1.636 3.645 3.853.7-2.89 2.705m86.865-8.477l-3.342-1.928-3.472 1.718.777-3.858-2.68-2.827 3.833-.45 1.8-3.46 1.607 3.58 3.783.686-2.837 2.657M330.37 265.03l-3.94-2.273-4.093 2.025.916-4.55-3.162-3.332 4.522-.53 2.123-4.08 1.894 4.22 4.46.81-3.346 3.13M225.13 225.52l-3.94-2.274-4.094 2.025.916-4.548-3.16-3.333 4.52-.53 2.122-4.08 1.894 4.22 4.46.81-3.345 3.13m13.283 57.14l-3.94-2.275-4.094 2.025.916-4.548-3.16-3.334 4.52-.53 2.123-4.08 1.894 4.22 4.46.81-3.345 3.132m131.954-67.33l-3.48-2.007-3.616 1.788.81-4.017-2.794-2.944 3.994-.47 1.875-3.603 1.673 3.728 3.94.715-2.955 2.766m-6.665 38.24l-2.74-1.582-2.85 1.408.64-3.164-2.2-2.32 3.145-.368 1.477-2.838 1.318 2.936 3.103.563-2.327 2.18m-142.199 50.422l-2.63-1.518-2.734 1.352.61-3.037-2.11-2.225 3.02-.354 1.416-2.723 1.264 2.818 2.978.54-2.233 2.09m200.14 15.164l-2.144-1.135-2.227 1.01.5-2.27-1.72-1.666 2.46-.265 1.154-2.038 1.03 2.108 2.426.404-1.82 1.563"/>
 7 |     <path fill="#ffffef" fill-rule="evenodd" d="M219.263 287.603l-2.63-1.518-2.734 1.352.61-3.037-2.11-2.225 3.02-.354 1.416-2.723 1.264 2.818 2.978.54-2.233 2.09"/>
 8 |     <path fill="#ffffef" fill-rule="evenodd" d="M219.263 287.603l-2.63-1.518-2.734 1.352.61-3.037-2.11-2.225 3.02-.354 1.416-2.723 1.264 2.818 2.978.54-2.233 2.09m42.299 3.048l-2.63-1.52-2.733 1.353.61-3.037-2.11-2.225 3.02-.354 1.416-2.722 1.265 2.817 2.978.54-2.233 2.09m-4.786 16.989l-2.63-1.518-2.734 1.352.612-3.038-2.11-2.225 3.017-.354 1.417-2.724 1.265 2.817 2.977.54-2.233 2.09m87.381-22.301l-2.63-1.52-2.733 1.353.61-3.036-2.11-2.225 3.018-.353 1.417-2.724 1.265 2.817 2.977.54-2.233 2.09m-25.099 3.048l-2.63-1.518-2.734 1.352.612-3.037-2.11-2.225 3.018-.353 1.417-2.724 1.264 2.817 2.98.54-2.234 2.09m-68.8-5.838l-1.648-.952-1.714.847.384-1.902-1.323-1.394 1.89-.222.89-1.706.792 1.765 1.864.34-1.4 1.31m167.838 45.384l-2.63-1.518-2.733 1.35.612-3.035-2.11-2.226 3.017-.354 1.417-2.724 1.264 2.817 2.978.54-2.233 2.09m-20.832 5.844l-2.178-1.26-2.264 1.122.507-2.522-1.748-1.848 2.5-.294 1.174-2.262 1.048 2.34 2.466.45-1.85 1.735m10.371 2.297l-2.03-1.173-2.108 1.044.472-2.344-1.63-1.718 2.33-.274 1.093-2.103.976 2.177 2.296.417-1.723 1.615m29.11-22.761l-1.955-1.13-2.03 1.006.454-2.257-1.567-1.655 2.243-.262 1.053-2.024.94 2.092 2.21.402-1.658 1.553M394.24 327.69l-2.554-1.395-2.652 1.24.594-2.786-2.05-2.043 2.93-.325 1.376-2.5 1.227 2.586 2.89.496-2.167 1.92m.549 14.247l-2.33-1.395-2.418 1.24.542-2.786-1.87-2.044 2.673-.324 1.255-2.5 1.12 2.586 2.635.496-1.977 1.918m-18.929-23.055l-1.955-1.13-2.032 1.006.455-2.257-1.568-1.653 2.242-.263 1.054-2.025.94 2.093 2.213.402-1.66 1.554m-17.781 2.273l-1.954-1.13-2.03 1.006.454-2.257-1.57-1.653 2.244-.263 1.053-2.025.94 2.093 2.21.402-1.658 1.554m-30.408-24.59l-1.955-1.128-2.03 1.004.454-2.257-1.568-1.654 2.243-.264 1.053-2.024.94 2.094 2.212.402-1.66 1.553m3.734 57.024l-1.656-.956-1.72.85.386-1.91-1.33-1.4 1.9-.223.893-1.715.795 1.772 1.874.34-1.407 1.316m-46.131-86.63l-3.942-2.274-4.093 2.025.917-4.548-3.162-3.334 4.52-.53 2.124-4.08 1.894 4.22 4.46.81-3.345 3.132"/>
 9 |     <path d="M444.368 285.817c1.944-5.083 4.45-12.75 5.783-19.786-67.742-59.508-143.26-89.993-238.68-83.72-3.422 6.558-6.16 13.423-8.47 20.853 113.063-10.786 195.936 39.27 241.37 82.654z" fill-rule="evenodd" fill="#fff"/>
10 |     <path d="M413.914 252.36l2.42 1.323c-.38.858-.48 1.61-.31 2.25.18.645.625 1.208 1.335 1.688.75.515 1.424.74 2.016.68.6-.06 1.045-.306 1.335-.734a1.27 1.27 0 0 0 .225-.863c-.027-.3-.192-.66-.495-1.075-.21-.28-.72-.873-1.53-1.777-1.04-1.16-1.66-2.138-1.86-2.936-.28-1.122-.11-2.14.51-3.06.4-.59.936-1.03 1.612-1.318.686-.29 1.433-.355 2.24-.198.81.157 1.664.54 2.55 1.143 1.453.987 2.33 2.048 2.63 3.184.305 1.138.117 2.253-.565 3.345l-2.404-1.484c.3-.665.375-1.24.218-1.723-.147-.485-.55-.95-1.21-1.397-.676-.46-1.302-.682-1.874-.663a1.01 1.01 0 0 0-.856.468c-.186.277-.228.59-.13.943.13.45.668 1.193 1.625 2.234.953 1.04 1.604 1.89 1.95 2.547.355.657.516 1.34.482 2.05-.023.706-.284 1.427-.778 2.16a4.11 4.11 0 0 1-1.812 1.493c-.76.33-1.57.412-2.437.24-.86-.177-1.794-.607-2.798-1.29-1.462-.992-2.36-2.093-2.687-3.3-.322-1.213-.125-2.523.6-3.925zm-11.478-7.533l2.472 1.22c-.345.872-.417 1.628-.22 2.26.208.637.672 1.183 1.4 1.635.775.482 1.455.68 2.043.596.6-.086 1.037-.346 1.306-.786a1.25 1.25 0 0 0 .19-.87c-.038-.302-.218-.655-.54-1.058-.22-.272-.75-.84-1.597-1.713-1.087-1.117-1.746-2.07-1.978-2.86-.323-1.11-.194-2.133.385-3.077a3.619 3.619 0 0 1 1.56-1.38c.674-.316 1.42-.413 2.23-.29.818.127 1.685.473 2.595 1.04 1.492.926 2.408 1.952 2.753 3.074.35 1.126.21 2.247-.427 3.365l-2.464-1.385c.275-.676.327-1.252.15-1.728-.168-.482-.59-.93-1.264-1.35-.697-.433-1.33-.628-1.9-.586-.37.025-.647.195-.838.504-.172.282-.204.594-.09.944.145.443.714 1.165 1.71 2.168.994 1 1.68 1.822 2.052 2.465.38.64.568 1.318.563 2.027.007.708-.227 1.437-.69 2.193a4.158 4.158 0 0 1-1.75 1.565c-.746.36-1.556.474-2.427.336-.865-.14-1.815-.536-2.848-1.175-1.498-.933-2.438-1.996-2.815-3.19-.374-1.2-.23-2.514.438-3.943zm-14.206-3.807l7.276-11.966 8.837 5.416-1.23 2.026-6.43-3.942-1.615 2.652 5.983 3.668-1.225 2.015-5.984-3.667-1.977 3.256 6.657 4.08-1.228 2.017-9.063-5.557zm-20.692-16.993l1.08-2.1 5.4 2.796-2.546 4.962c-.79.238-1.78.296-2.982.17a9.355 9.355 0 0 1-3.317-.986c-1.3-.673-2.29-1.528-2.976-2.572a5.911 5.911 0 0 1-.974-3.47 8.61 8.61 0 0 1 .977-3.703c.664-1.298 1.53-2.31 2.59-3.04 1.057-.727 2.25-1.09 3.57-1.09 1.008-.002 2.104.306 3.29.916 1.542.8 2.577 1.747 3.104 2.846.54 1.096.638 2.28.298 3.555l-2.728-.82c.14-.702.057-1.356-.25-1.957-.296-.606-.806-1.095-1.527-1.47-1.097-.567-2.146-.67-3.155-.305-1 .363-1.85 1.23-2.554 2.6-.76 1.48-1.005 2.76-.73 3.842.277 1.073.944 1.886 2.008 2.437.524.27 1.1.44 1.73.507.64.066 1.22.05 1.753-.05l.81-1.582-2.872-1.485zm-90.242-22.379l2.034-13.867 4.172.62 1.123 9.826 3.86-9.093 4.188.618-2.033 13.87-2.59-.382 1.6-10.918-4.343 10.512-2.685-.398-1.134-11.32-1.6 10.915-2.592-.382zm-14.108-1.638l1.305-13.96 10.307.974-.217 2.36-7.503-.706-.29 3.095 6.978.657-.22 2.352-6.98-.658-.353 3.8 7.764.73-.22 2.354-10.572-.998z" fill="#309e3a"/>
11 |     <g stroke-opacity=".502">
12 |       <path d="M216.5 191.28c.04-1.43.284-2.62.736-3.58a6.649 6.649 0 0 1 1.346-1.884c.566-.552 1.18-.956 1.844-1.21.88-.347 1.888-.505 3.023-.475 2.056.06 3.682.744 4.877 2.057 1.205 1.315 1.775 3.114 1.714 5.395-.06 2.26-.72 4.017-1.982 5.264-1.26 1.24-2.914 1.834-4.963 1.777-2.077-.056-3.708-.736-4.9-2.037-1.19-1.308-1.755-3.078-1.694-5.307z" fill="#309e3a"/>
13 |       <path d="M219.414 191.252c-.043 1.586.29 2.8.997 3.643.708.837 1.625 1.27 2.748 1.3 1.122.03 2.055-.35 2.794-1.138.745-.797 1.14-2.007 1.184-3.633.043-1.605-.277-2.813-.96-3.622-.676-.81-1.595-1.23-2.757-1.262-1.162-.03-2.11.345-2.843 1.128-.733.777-1.12 1.972-1.163 3.584z" fill="#f7ffff"/>
14 |     </g>
15 |     <g stroke-opacity=".502">
16 |       <path d="M233.052 198.51l.163-14.017 5.933.07c1.494.018 2.574.157 3.244.42.677.257 1.214.71 1.613 1.36s.593 1.385.584 2.215c-.013 1.052-.332 1.918-.956 2.598-.623.675-1.55 1.095-2.777 1.26.605.363 1.104.76 1.49 1.193.397.43.923 1.195 1.585 2.293l1.673 2.754-3.372-.04-2.002-3.074c-.71-1.098-1.198-1.788-1.46-2.072-.265-.29-.545-.487-.842-.593-.297-.11-.77-.17-1.418-.177l-.57-.008-.068 5.852-2.82-.033z" fill="#309e3a"/>
17 |       <path d="M235.976 190.455l2.086.024c1.353.016 2.198-.03 2.536-.142.337-.112.603-.305.796-.584s.293-.627.3-1.048c.004-.472-.118-.853-.37-1.142-.243-.296-.594-.486-1.05-.567-.23-.034-.915-.06-2.057-.072l-2.2-.026-.04 3.555z" fill="#fff"/>
18 |     </g>
19 |     <g stroke-opacity=".502">
20 |       <path d="M249.003 185.188l5.147.26c1.16.06 2.04.195 2.64.405a4.68 4.68 0 0 1 2.036 1.396c.553.646.958 1.426 1.218 2.34.26.907.356 2.015.29 3.326-.058 1.153-.252 2.138-.58 2.96-.4 1-.938 1.797-1.618 2.396-.51.453-1.19.79-2.034 1.016-.632.166-1.468.222-2.51.17l-5.295-.27.706-14z" fill="#309e3a"/>
21 |       <path d="M251.706 187.685l-.468 9.274 2.103.105c.786.042 1.357.025 1.71-.046.46-.093.85-.268 1.16-.526.32-.26.59-.695.81-1.31.223-.62.36-1.47.416-2.553s0-1.918-.16-2.507c-.16-.59-.404-1.053-.73-1.397-.327-.342-.75-.583-1.27-.724-.39-.11-1.157-.193-2.306-.25l-1.264-.067z" fill="#fff"/>
22 |     </g>
23 |     <g stroke-opacity=".502">
24 |       <path d="M317.63 210.22l3.26-13.63 4.4 1.06c1.666.402 2.737.732 3.21.99.73.392 1.274.996 1.634 1.81.36.81.41 1.755.152 2.84-.2.836-.518 1.504-.958 2-.438.5-.932.854-1.48 1.07-.54.212-1.064.31-1.57.3-.685-.028-1.65-.19-2.89-.49l-1.786-.432-1.23 5.142-2.743-.66z" fill="#309e3a"/>
25 |       <path d="M323.086 199.552l-.926 3.868 1.5.362c1.082.26 1.82.364 2.218.308a1.85 1.85 0 0 0 1.581-1.448c.12-.496.073-.94-.14-1.33a1.94 1.94 0 0 0-.957-.87c-.312-.143-.96-.332-1.95-.57l-1.324-.32z" fill="#fff"/>
26 |     </g>
27 |     <g stroke-opacity=".502">
28 |       <path d="M330.606 214.106l4.64-13.22 5.598 1.98c1.408.498 2.387.98 2.937 1.445.56.463.923 1.064 1.093 1.807s.12 1.505-.156 2.286c-.348.992-.928 1.71-1.736 2.153-.806.438-1.817.537-3.032.298.457.54.802 1.076 1.03 1.61.238.536.49 1.43.765 2.683l.704 3.15-3.18-1.126-.913-3.556c-.322-1.27-.562-2.08-.72-2.435-.158-.36-.36-.638-.607-.834-.246-.202-.673-.41-1.286-.627l-.536-.192-1.938 5.52-2.66-.942z" fill="#309e3a"/>
29 |       <path d="M335.938 207.426l1.967.695c1.276.452 2.09.68 2.445.683.355.005.67-.093.943-.295.272-.2.478-.5.616-.896.155-.445.162-.845.017-1.2-.135-.36-.408-.65-.813-.876-.206-.106-.847-.35-1.924-.73l-2.075-.736-1.177 3.356z" fill="#fff"/>
30 |     </g>
31 |     <g stroke-opacity=".502">
32 |       <path d="M347.01 213.6c.424-1.363.982-2.444 1.673-3.24a6.58 6.58 0 0 1 1.808-1.45c.696-.377 1.397-.598 2.102-.665.94-.093 1.953.03 3.038.37 1.965.614 3.344 1.717 4.14 3.308.803 1.593.867 3.48.19 5.658-.67 2.162-1.78 3.67-3.33 4.528-1.548.852-3.302.97-5.26.357-1.982-.62-3.37-1.718-4.164-3.294-.793-1.583-.858-3.44-.196-5.57z" fill="#309e3a"/>
33 |       <path d="M349.826 214.385c-.47 1.514-.48 2.773-.026 3.778.455.996 1.22 1.663 2.293 2 1.073.334 2.07.223 2.996-.336.932-.562 1.64-1.62 2.122-3.172.476-1.535.495-2.783.056-3.75-.432-.962-1.204-1.618-2.313-1.964-1.11-.347-2.123-.243-3.04.312-.915.548-1.61 1.592-2.09 3.133z" fill="#fff"/>
34 |     </g>
35 |     <g stroke-opacity=".502">
36 |       <path d="M374.305 233.12l6.415-12.45 5.27 2.736c1.326.69 2.23 1.3 2.71 1.84.49.532.768 1.18.835 1.94s-.092 1.505-.47 2.242c-.48.934-1.153 1.564-2.017 1.892-.86.322-1.872.28-3.043-.128.378.598.645 1.18.8 1.74.158.564.288 1.484.387 2.763l.262 3.215-2.993-1.555-.415-3.648c-.145-1.304-.27-2.14-.378-2.512-.105-.377-.27-.682-.487-.91-.214-.233-.61-.5-1.186-.798l-.507-.264-2.677 5.197-2.505-1.3z" fill="#309e3a"/>
37 |       <path d="M380.503 227.226l1.853.962c1.2.625 1.977.962 2.33 1.016.35.054.675 0 .973-.162.296-.16.54-.428.733-.803.216-.42.276-.814.184-1.186-.087-.374-.315-.702-.685-.98-.19-.134-.79-.465-1.808-.993l-1.952-1.013-1.63 3.16z" fill="#fff"/>
38 |     </g>
39 |     <g stroke-opacity=".502">
40 |       <path d="M426.107 258.704c.797-1.183 1.642-2.056 2.536-2.62a6.609 6.609 0 0 1 2.146-.862 5.45 5.45 0 0 1 2.2-.028c.93.184 1.864.596 2.805 1.235 1.704 1.156 2.708 2.612 3.014 4.366.31 1.758-.173 3.58-1.448 5.472-1.263 1.873-2.758 2.998-4.488 3.37-1.728.365-3.44-.028-5.14-1.182-1.718-1.168-2.732-2.622-3.04-4.362-.303-1.746.168-3.543 1.413-5.39z" fill="#309e3a"/>
41 |       <path d="M428.578 260.254c-.886 1.316-1.256 2.518-1.112 3.61.15 1.087.69 1.945 1.62 2.578.932.632 1.92.815 2.967.55 1.055-.27 2.037-1.077 2.944-2.425.896-1.33 1.273-2.52 1.13-3.572-.138-1.047-.688-1.898-1.65-2.552s-1.962-.85-3-.583c-1.033.26-1.998 1.06-2.9 2.394z" fill="#fff"/>
42 |     </g>
43 |     <path d="M301.824 204.523l2.248-9.84 7.268 1.675-.378 1.662-5.287-1.217-.504 2.18 4.926 1.136-.382 1.655-4.918-1.132-.614 2.677 5.475 1.26-.378 1.66-7.456-1.717z" fill="#309e3a"/>
44 |   </g>
45 | </svg>
46 |


--------------------------------------------------------------------------------
/assets/flags/uk2.svg:
--------------------------------------------------------------------------------
 1 | <svg xmlns="http://www.w3.org/2000/svg" height="480" width="640" viewBox="0 0 640 480">
 2 |   <defs>
 3 |     <clipPath id="a">
 4 |       <path fill-opacity=".67" d="M-85.333 0h682.67v512h-682.67z"/>
 5 |     </clipPath>
 6 |   </defs>
 7 |   <g clip-path="url(#a)" transform="translate(80) scale(.94)">
 8 |     <g stroke-width="1pt">
 9 |       <path fill="#006" d="M-256 0H768.02v512.01H-256z"/>
10 |       <path d="M-256 0v57.244l909.535 454.768H768.02V454.77L-141.515 0H-256zM768.02 0v57.243L-141.515 512.01H-256v-57.243L653.535 0H768.02z" fill="#fff"/>
11 |       <path d="M170.675 0v512.01h170.67V0h-170.67zM-256 170.67v170.67H768.02V170.67H-256z" fill="#fff"/>
12 |       <path d="M-256 204.804v102.402H768.02V204.804H-256zM204.81 0v512.01h102.4V0h-102.4zM-256 512.01L85.34 341.34h76.324l-341.34 170.67H-256zM-256 0L85.34 170.67H9.016L-256 38.164V0zm606.356 170.67L691.696 0h76.324L426.68 170.67h-76.324zM768.02 512.01L426.68 341.34h76.324L768.02 473.848v38.162z" fill="#c00"/>
13 |     </g>
14 |   </g>
15 | </svg>
16 |


--------------------------------------------------------------------------------
/assets/loading.gif:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/assets/loading.gif


--------------------------------------------------------------------------------
/assets/text/biblePt.txt:
--------------------------------------------------------------------------------
  1 | Quando são muitas as palavras, o pecado está presente, mas quem controla a língua é sensato.
  2 | Provérbios 10:19
  3 |
  4 | o fruto do Espírito é amor, alegria, paz, paciência, amabilidade, bondade, fidelidade, mansidão e domínio próprio. Contra estas coisas não há lei.
  5 | Gálatas 5: 22-23
  6 |
  7 | quem fica observando o vento não plantará, e quem fica olhando para as nuvens não colherá.
  8 | Eclesiasters, 11:4
  9 |
 10 | quem quiser amar a vida e ver dias felizes, guarde a sua lingua do mal e os seus lábios da falsidade. Afaste-se do mal e faça o bem, busque a paz com perseverança.
 11 | 1 Pedro 3:10-11
 12 |
 13 | o Senhor será a sua segurança e o impedirá de cair em armadilha.
 14 | Provérbios 3:26
 15 |
 16 | pela graça de Deus, sou o que sou, e sua graça para comigo não foi inútil.
 17 | 1 Coríntios 15:10
 18 |
 19 | Eu sei, Senhor, que não está nas mãos do homem o seu futuro; não compete ao homem dirigir os seus passos.
 20 | Jeremias 10:23
 21 |
 22 | Clame a mim e eu responderei e lhe direi coisas grandiosas e insondáveis que você não conhece.
 23 | Jeremias 33:3
 24 |
 25 | Entregue o seu caminho ao Senhor, confie nele, e Ele agirá.
 26 | Salmo 37:5
 27 |
 28 | Confie no Senhor de todo o seu coração, e não se apóie em seu próprio entendimento. Reconheça o Senhor em todos os seus caminhos, e ele endireitará as suas veredas. Não seja sábio aos seus próprios olhos; tema ao Senhor e evite o mal. Isso lhe dará saúde ao corpo e vigor aos ossos.
 29 | Provérbios 3:5-8
 30 |
 31 | Coloca, Senhor, uma guarda à minha boca; vigia a porta de meus lábios.
 32 | Salmo 141:3
 33 |
 34 | A língua tem poder sobre a vida e a morte; os que gostam de usá-la comerão do seu fruto.
 35 | Provérbios 18:21
 36 |
 37 | Teus, ó Senhor, são a grandeza, o poder, a glória, a majestade e o esplendor, pois tudo o que há nos céus e na terra é teu. Teu, ó Senhor, é o reino; tu estás acima de tudo.
 38 | 1 Crônicas 29:11
 39 |
 40 | Que o Deus da esperança os encha de toda alegria e paz, por sua confiança nele, para que vocês transbordem de esperança, pelo poder do Espírito Santo.
 41 | Romanos 15:13
 42 |
 43 | empenhem-se para acrescentar à sua fé a virtude, à virtude o conhecimento, ao conhecimento o domínio próprio, ao domínio próprio a perseverança, à perseverança a piedade, à piedade a fraternidade, e à fraternidade o amor.
 44 | 2 Pedro 1:5-7
 45 |
 46 | Ainda que eu fale as línguas dos homens e dos anjos, se não tiver amor, serei como o sino que ressoa ou como o prato que retine. Ainda que eu tenha o dom de profecia e saiba todos os mistérios e todo o conhecimento, e tenha uma fé capaz de mover montanhas, se não tiver amor, nada serei. Ainda que eu dê aos pobres tudo o que possuo e entregue o meu corpo para ser queimado, se não tiver amor, nada disso me valerá. O amor é paciente, o amor é bondoso. Não inveja, não se vangloria, não se orgulha. Não maltrata, não procura seus interesses, não se ira facilmente, não guarda rancor. O amor não se alegra com a injustiça, mas se alegra com a verdade. Tudo sofre, tudo crê, tudo espera, tudo suporta. O amor nunca perece; mas as profecias desaparecerão, as línguas cessarão, o conhecimento passará. Pois em parte conhecemos e em parte profetizamos; quando, porém, vier o que é perfeito, o que é imperfeito desaparecerá. Quando eu era menino, falava como menino, pensava como menino e raciocinava como menino. Quando me tornei homem, deixei para trás as coisas de menino. Agora, pois, vemos apenas um reflexo obscuro, como em espelho; mas, então, veremos face a face. Agora conheço em parte; então conhecerei plenamente, da mesma forma com que sou plenamente conhecido. Assim, permanecem agora estes três: a fé, a esperança, e o amor. O maior deles, porém, é o amor.
 47 | 1 Coríntios 13
 48 |
 49 | Confie no Senhor e faça o bem; assim você habitará na terra e desfrutará segurança. Deleite-se no Senhor, e ele atenderá aos desejos do seu coração. Entregue o seu caminho ao Senhor; confie nele e ele agirá: ele deixará claro como a alvorada que você é justo, e como o sol do meio dia que você é inocente. Descanse no Senhor e aguarde por ele com paciência; não se aborreça com o sucesso dos outros nem com aqueles que maquinam o mal. Evite a ira e rejeite a fúria; não se irrite: isso só leva ao mal. Pois os maus serão eliminados, mas os que esperam no Senhor receberão a terra por herança. Um pouco de tempo, e os ímpios não mais existirão; por mais que você os procure, não serão encontrados. Mas os humildes receberão a terra por herança e desfrutarão pleno bem-estar.
 50 | Salmo 37:3-11
 51 |
 52 | Tu és bondoso e perdoador, Senhor, rico em graça para com todos os que te invocam.
 53 | Salmo 86:5
 54 |
 55 | É Deus quem me reveste de força e torna perfeito o meu caminho.
 56 | 2 Samuel 22:33
 57 |
 58 | Os teus olhos viram o meu embrião; todos os dias determinados para mim foram escritos no teu livro antes de qualquer deles existir.
 59 | Salmo 139:16
 60 |
 61 | bendito é o homem cuja confiança está no Senhor, cuja confiança nele está.
 62 | Jeremias 17:7
 63 |
 64 | Sabemos que Deus age em todas as coisas para o bem daqueles que o amam, daqueles que foram chamados de acordo com o seu propósito.
 65 | Romanos 8:28
 66 |
 67 | As palavras agradáveis são como um favo de mel, são doces para a alma e trazem cura para os ossos.
 68 | Provérbios 16:24
 69 |
 70 | Sempre tenho o Senhor diante de mim. Com ele à minha direita, não serei abalado.
 71 | Salmo 16:8
 72 |
 73 | o teu amor está sempre diante de mim, e continuamente sigo a tua verdade.
 74 | Salmo 26:3
 75 |
 76 | Vivam pelo Espírito, e de modo nenhum satisfarão os desejos da carne.
 77 | Gálatas, 5:16
 78 |
 79 | A tua palavra é lâmpada que ilumina os meus passos e luz que clareia o meu caminho.
 80 | Salmo 119:105
 81 |
 82 | Uma coisa pedi ao Senhor e a procuro: que eu possa viver na casa do Senhor todos os dias da minha vida, para contemplar a bondade do Senhor e buscar sua orientação no seu templo.
 83 | Salmo 27:4
 84 |
 85 | fixamos os olhos, não naquilo que se vê, mas no que não se vê, pois o que se vê é transitório, mas o que não se vê é eterno.
 86 | 2 Coríntios 4:18
 87 |
 88 | a piedade com contentamento é grande fonte de lucro, pois nada trouxemos para este mundo e dele nada podemos levar; por isso, tendo o que comer e com que vestir-nos, estejamos com isso satisfeitos.
 89 | 1 Timóteo 6:6-8
 90 |
 91 | Alegrem-se sempre. Orem continuamente. Deem graças em todas as circunstâncias, pois esta é a vontade de Deus para vocês em Cristo Jesus. Não apaguem o Espírito.
 92 | 1 Tessalonicenses 5:16-19
 93 |
 94 | Quem relaxa em seu trabalho é irmão do que o destrói.
 95 | Provérbios 18:9
 96 |
 97 | Com sabedoria se constrói a casa, e com discernimento se consolida. Pelo conhecimento os seus cômodos se enchem do que é precioso e agradável.
 98 | Provérbios 24:3-4
 99 |
100 | Não permitirás que o teu santo sofra decomposição.
101 | Atos dos Apóstolos 13:35
102 |
103 | não me importo, nem considero a minha vida de valor algum para mim mesmo, se tão-somente puder terminar a corrida e completar o ministério que o Senhor Jesus me confiou
104 | Atos dos Apóstolos 20:24
105 |
106 | O Senhor é bom para todos; a sua compaixão alcança todas as suas criaturas.
107 | Salmo 145:9
108 |
109 | A minha alma descansa somente em Deus; dele vem a minha salvação.
110 | Salmo 62:1
111 |
112 | Nada façam por ambição egoísta ou por vaidade, mas humildemente considerem os outros superiores a si mesmos. Cada um cuide, não somente dos seus interesses, mas também dos interesses dos outros.
113 | Filipenses 2:3-4
114 |
115 | ponham em ação a salvação de vocês com temor e tremor, pois é Deus que efetua em vocês tanto o querer quanto o realizar, de acordo com a boa vontade dele.
116 | Filipenses 2:12-13
117 |
118 | somos criação de Deus realizada em Cristo Jesus para fazermos boas obras, as quais Deus preparou antes para nós as praticarmos.
119 | Efésios 2:10
120 |
121 | Nenhuma palavra torpe saia da boca de vocês, mas apenas a que for útil para edificar os outros, conforme a necessidade, para que conceda graça aos que a ouvem.
122 | Efésios 4:29
123 |
124 | A boca do justo é fonte de vida, mas a boca dos ímpios abriga a violência.
125 | Provérbios 10:11
126 |
127 | Nós, que somos fortes, devemos suportar as fraquezas dos fracos, e não agradar a nós mesmos. Cada um de nós deve agradar ao seu próximo para o bem dele, a fim de edificá-lo.
128 | Romanos 15:1-2
129 |
130 | Pois tudo o que há no mundo - a cobiça da carne, a cobiça dos olhos e a ostentação dos bens - não provém do Pai, mas do mundo.
131 | 1 João 2:16
132 |


--------------------------------------------------------------------------------
/index.html:
--------------------------------------------------------------------------------
  1 | <html>
  2 |   <head>
  3 |     <title class="notranslate">&#x00C6;terni Anima</title>
  4 |     <link id="favicon" rel="shortcut icon" type="image/png" href="assets/fav5.png" />
  5 |
  6 |     <meta property="og:image:secure_url" content="https://aeterni.github.io/assets/imgs/coil2.jpeg" />
  7 |     <meta property="og:image:secure_url" content="https://aeterni.github.io/assets/imgs/sine.jpeg" />
  8 |     <meta property="og:image:secure_url" content="https://aeterni.github.io/assets/imgs/coil.jpeg" />
  9 |     <meta property="og:image:secure_url" content="https://aeterni.github.io/assets/imgs/blank.jpeg" />
 10 |
 11 |     <meta property="og:image" content="https://aeterni.github.io/assets/imgs/coil2.jpeg" />
 12 |     <meta property="og:image" content="https://aeterni.github.io/assets/imgs/sine.jpeg" />
 13 |     <meta property="og:image" content="https://aeterni.github.io/assets/imgs/coil.jpeg" />
 14 |     <meta property="og:image" content="https://aeterni.github.io/assets/imgs/blank.jpeg" />
 15 |   </head>
 16 | <body style="margin:0;font-family:Helvetica, arial">
 17 |     <div id="loading"><br/><br/><div style="padding-top:30%">LOADING...</div></div>
 18 | <script type="text/javascript">
 19 | function googleTranslateElementInit() {
 20 |   // new google.translate.TranslateElement({ pageLanguage: 'en', includedLanguages: 'en,pt,de,zh-CN,ko,it,ja,ru,fr,es', layout: google.translate.TranslateElement.InlineLayout.HORIZONTAL }, 'google_translate_element');
 21 |   new google.translate.TranslateElement({ pageLanguage: 'en' }, 'google_translate_element');
 22 | }
 23 | </script>
 24 |   <script type="module" src="scripts/bundle.js"></script>
 25 |   <input id="file-input" type="file" name="name" style="display: none;" />
 26 |
 27 | </body>
 28 | <style type="text/css">
 29 | #loading {
 30 |   display: block;
 31 |   position: absolute;
 32 |   top: 0;
 33 |   left: 0;
 34 |   z-index: 100;
 35 |   width: 100vw;
 36 |   height: 100vh;
 37 |   background-color: rgba(192, 192, 192, 0.5);
 38 |   background-image: url(assets/loading.gif);
 39 |   background-repeat: no-repeat;
 40 |   background-position: center;
 41 |   text-align: center;
 42 |   font-size: 24px;
 43 | }
 44 |
 45 | /* The Modal (background) */
 46 | .modal {
 47 |   display: none; /* Hidden by default */
 48 |   position: fixed; /* Stay in place */
 49 |   z-index: 1; /* Sit on top */
 50 |   padding-top: 100px; /* Location of the box */
 51 |   left: 0;
 52 |   top: 0;
 53 |   width: 100%; /* Full width */
 54 |   /* height: 100%; /* Full height */
 55 |   overflow: auto; /* Enable scroll if needed */
 56 |   background-color: rgb(0,0,0); /* Fallback color */
 57 |   background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
 58 | }
 59 |
 60 | /* Modal Content */
 61 | .modal-content {
 62 |   background-color: #dedede;
 63 |   margin: auto;
 64 |   padding: 20px;
 65 |   border: 1px solid #888;
 66 |   width: 80%;
 67 |   border-radius: 5%;
 68 | }
 69 |
 70 | /* The Close Button */
 71 | .close {
 72 |   color: #aaaaaa;
 73 |   float: right;
 74 |   font-size: 28px;
 75 |   font-weight: bold;
 76 | }
 77 |
 78 | .close:hover,
 79 | .close:focus {
 80 |   color: #000;
 81 |   text-decoration: none;
 82 |   cursor: pointer;
 83 | }
 84 |
 85 | /* Translate */
 86 | #google_translate_element{
 87 |   display: none;
 88 | }
 89 |
 90 | .skiptranslate{
 91 |   display: none;
 92 | }
 93 |
 94 | body{
 95 |   top: 0!important;
 96 | }
 97 |
 98 | /* span {
 99 |   width: 50%;
100 | } */
101 |
102 |
103 | /* On / Off switch */
104 | .switch {
105 |   position: relative;
106 |   display: inline-block;
107 |   width: 90px;
108 |   height: 34px;
109 | }
110 |
111 | .switch input {display:none;}
112 |
113 | .slideraa {
114 |   position: absolute;
115 |   cursor: pointer;
116 |   top: 0;
117 |   left: 0;
118 |   right: 0;
119 |   bottom: 0;
120 |   background-color: #aaaa09;
121 |   -webkit-transition: .4s;
122 |   transition: .4s;
123 |    border-radius: 34px;
124 | }
125 |
126 | .slideraa:before {
127 |   position: absolute;
128 |   content: "";
129 |   height: 26px;
130 |   width: 26px;
131 |   left: 4px;
132 |   bottom: 4px;
133 |   background-color: white;
134 |   -webkit-transition: .4s;
135 |   transition: .4s;
136 |   border-radius: 50%;
137 | }
138 |
139 | input:checked + .slideraa {
140 |   background-color: #2ab934;
141 | }
142 |
143 | input:focus + .slideraa {
144 |   box-shadow: 0 0 1px #2196F3;
145 | }
146 |
147 | input:checked + .slideraa:before {
148 |   -webkit-transform: translateX(26px);
149 |   -ms-transform: translateX(26px);
150 |   transform: translateX(55px);
151 | }
152 |
153 | /*------ ADDED CSS ---------*/
154 | .slideraa:after
155 | {
156 |  content:'OFF';
157 |  color: white;
158 |  display: block;
159 |  position: absolute;
160 |  transform: translate(-50%,-50%);
161 |  top: 50%;
162 |  left: 50%;
163 |  font-size: 10px;
164 |  font-family: Verdana, sans-serif;
165 | }
166 |
167 | input:checked + .slideraa:after
168 | {
169 |   content:'ON';
170 | }
171 |
172 | /*--------- END --------*/
173 |
174 | .tooltip {
175 |   position: relative;
176 |   display: inline-block;
177 |   border-bottom: 1px dotted black;
178 | }
179 |
180 | .tooltip .tooltiptext {
181 |   visibility: hidden;
182 |   width: 120px;
183 |   background-color: rgb(0,0,0,0.5);
184 |   color: #fff;
185 |   text-align: center;
186 |   border-radius: 6px;
187 |   padding: 5px;
188 |   position: absolute;
189 |   z-index: 1;
190 |   top: 150%;
191 |   left: 50%;
192 |   margin-left: -60px;
193 |   font-size: 150%;
194 |   transition: opacity 0.8s;
195 | }
196 |
197 | .tooltip .tooltiptext::after {
198 |   content: "";
199 |   position: absolute;
200 |   bottom: 100%;
201 |   left: 50%;
202 |   margin-left: -5px;
203 |   border-width: 5px;
204 |   border-style: solid;
205 |   border-color: transparent transparent black transparent;
206 | }
207 |
208 | .tooltip.focus, .tooltip:focus {
209 |     outline: 0;
210 |     box-shadow: none!important;
211 | }
212 |
213 | .tooltip:hover .tooltiptext {
214 |   visibility: visible;
215 | }
216 |
217 | .tooltip .tooltiptext:hover {
218 |   visibility: hidden;
219 | }
220 | </style>
221 | </html>
222 |


--------------------------------------------------------------------------------
/nodemon.json:
--------------------------------------------------------------------------------
1 | {
2 |   "ignore": ["scripts/bundle.js", "you/scripts/ok/pop.js", "you/scripts/ok/content.js", "you/scripts/ok/background.js"]
3 | }
4 |


--------------------------------------------------------------------------------
/package.json:
--------------------------------------------------------------------------------
 1 | {
 2 |   "name": "audiovisualmedicine",
 3 |   "devDependencies": {
 4 |     "standard": "*"
 5 |   },
 6 |   "scripts": {
 7 |     "build": "browserify scripts/main.js > scripts/bundle.js",
 8 |     "dev": "nodemon app.js --exec 'standard && npm run build && node'",
 9 |     "buildAux": "browserify you/scripts/content.js > you/scripts/ok/content.js",
10 |     "buildAux2": "browserify you/scripts/background.js > you/scripts/ok/background.js",
11 |     "buildAux3": "browserify you/scripts/pop.js > you/scripts/ok/pop.js",
12 |     "buildEzip": "standard you/pop.js you/contentScript.js you/background.js you/fnetwork.js && npm run buildAux && npm run buildAux2 && browserify you/pop.js > you/pop_ok.js",
13 |     "buildExt": "nodemon --exec 'standard && npm run buildAux && npm run buildAux2 && npm run buildAux3'",
14 |     "fixme": "standard --fix"
15 |   },
16 |   "dependencies": {
17 |     "@atlassian/jira": "^0.1.0",
18 |     "@eastdesire/jscolor": "^2.4.0",
19 |     "@fortawesome/fontawesome-free": "^5.13.1",
20 |     "bcryptjs": "^2.4.3",
21 |     "browserify": "^17.0.0",
22 |     "chroma-js": "^2.1.0",
23 |     "color-scheme": "^1.0.1",
24 |     "copy-to-clipboard": "^3.3.1",
25 |     "dat.gui": "^0.7.7",
26 |     "distinct-colors": "^3.0.0",
27 |     "encodeurl": "^1.0.2",
28 |     "fast-sha256": "^1.3.0",
29 |     "flatpickr": "^4.6.6",
30 |     "graphology": "^0.17.1",
31 |     "graphology-communities-louvain": "^1.2.0",
32 |     "graphology-components": "^0.1.0",
33 |     "graphology-generators": "^0.10.1",
34 |     "graphology-layout": "^0.2.0",
35 |     "graphology-layout-forceatlas2": "^0.4.4",
36 |     "graphology-metrics": "^1.8.0",
37 |     "graphology-types": "^0.19.2",
38 |     "graphology-utils": "^1.8.0",
39 |     "jira": "^0.9.2",
40 |     "jira-client": "^8.0.0",
41 |     "jquery": "^3.5.1",
42 |     "linkifyjs": "^2.1.9",
43 |     "lz-string": "^1.4.4",
44 |     "mongodb-stitch-browser-sdk": "^4.8.0",
45 |     "nodemon": "^2.0.3",
46 |     "nosleep.js": "^0.12.0",
47 |     "paginationjs": "^2.1.5",
48 |     "percom": "^1.1.0",
49 |     "pixi-projection": "^0.3.11",
50 |     "pixi.js": "^5.3.9",
51 |     "react": "^17.0.1",
52 |     "react-dom": "^17.0.1",
53 |     "scribbletune": "^3.15.0",
54 |     "showdown": "^1.9.1",
55 |     "stats-js": "^1.0.1",
56 |     "superagent": "^6.1.0",
57 |     "tinycolor2": "^1.4.1",
58 |     "tone": "^14.7.77",
59 |     "uglify-js": "^3.13.9",
60 |     "wavefile": "^11.0.0"
61 |   },
62 |   "standard": {
63 |     "ignore": [
64 |       "**/bundle.js",
65 |       "you/scripts/ok/*.js"
66 |     ]
67 |   }
68 | }
69 |


--------------------------------------------------------------------------------
/scripts/main.js:
--------------------------------------------------------------------------------
  1 | /* global wand */
  2 | // to facilitate debug in mobile:
  3 | // window.onerror = function (msg, url, lineNo, columnNo, error) {
  4 | //   const string = msg.toLowerCase()
  5 | //   const substring = 'script error'
  6 | //   if (string.indexOf(substring) > -1) {
  7 | //     window.alert('Script Error: See Browser Console for Detail')
  8 | //   } else {
  9 | //     const message = [
 10 | //       'Message: ' + msg,
 11 | //       'URL: ' + url,
 12 | //       'Line: ' + lineNo,
 13 | //       'Column: ' + columnNo,
 14 | //       'Error object: ' + JSON.stringify(error)
 15 | //     ].join(' - ')
 16 | //     window.alert('SEND THIS ERROR MESSAGE TO ADMINS:', message)
 17 | //   }
 18 | // }
 19 | window.wand = {
 20 |   router: require('./modules/router.js'),
 21 |   net: require('./modules/net.js'),
 22 |   maestro: require('./modules/maestro.js'),
 23 |   transfer: require('./modules/transfer.js'),
 24 |   med: require('./modules/med'),
 25 |   conductor: require('./modules/conductor'),
 26 |   monk: require('./modules/monk'),
 27 |   utils: require('./modules/utils.js'),
 28 |   test: require('./modules/test.js'),
 29 |   $: require('jquery'),
 30 |   bcrypt: require('bcryptjs'),
 31 |   unloadFuncs: [],
 32 |   userFuncs: []
 33 | }
 34 |
 35 | // cleaning facebook auto added argument (aesthetics, cleaning for users):
 36 | window.history.pushState('', '', window.location.search.split('&fbclid=')[0])
 37 |
 38 | const uargs = wand.router.urlAllArguments()
 39 |
 40 | // page is first arg key without value
 41 | // meditation is the same, but starts with _ (version 1)
 42 | // or @ or . (version 2),
 43 | // ~ or - (version 2 through mkLight)
 44 | // sync is specified with <sync id>=<participant ref>
 45 | // else just welcome page
 46 |
 47 | let found = false
 48 | wand.$('<div/>', { id: 'canvasDiv' }).appendTo('body')
 49 | if (uargs.keys[0] === 'doc') {
 50 |   wand.utils.checkLogged()
 51 |   const userRef = uargs.values[0]
 52 |   console.log(`lab/user with id: ${userRef}`)
 53 |   wand.currentMed = new wand.med.Doc()
 54 |   found = true
 55 | } else if (uargs.values[0] === '') {
 56 |   const k = uargs.keys[0]
 57 |   found = true
 58 |   if (k[0] === '_') { // meditation model 1:
 59 |     wand.utils.checkLogged()
 60 |     wand.currentMed = wand.med.model(k.slice(1))
 61 |     wand.utils.confirmExit()
 62 |   } else if ('~-@.'.includes(k[0])) { // meditation model 2 or 3
 63 |     wand.utils.checkLogged()
 64 |     const query = { 'header.med2': k.slice(1) }
 65 |     if ('~-'.includes(k[0])) query['header.ancestral'] = { $exists: true } // created by mkLight. todo: remove '~' ?
 66 |     else if (k[0] !== '@') {
 67 |       query['header.onlyOnce'] = { $exists: true }
 68 |       query._id = { $gt: wand.utils.objectIdWithTimestamp('2021/06/05') }
 69 |     }
 70 |     wand.transfer[k[0] === '@' ? 'findAll' : 'findAny'](query).then(r => {
 71 |       wand.currentSet = r
 72 |       // use r.lemniscate to decide model2 or 3
 73 |       // if (r.visSetting.lemniscate > 30) wand.currentMed = new wand.med.Model3(r, Boolean(r.header.ancestral))
 74 |       // else wand.currentMed = new wand.med.Model2(r, Boolean(r.header.ancestral))
 75 |       wand.currentMed = new wand.med.Model2(r)
 76 |       wand.utils.confirmExit()
 77 |     })
 78 |   } else if (k in wand.test) { // standard page:
 79 |     wand.showLoginDiv = true
 80 |     wand.test[k]() // if k[0] === '-': k is an article
 81 |   } else {
 82 |     found = false
 83 |   }
 84 | } else if (uargs.values.length !== 0) { // sync:
 85 |   found = true
 86 |   const syncId = uargs.keys[0]
 87 |   const userRef = uargs.values[0]
 88 |   console.log(`sync with id: ${syncId}, user: ${userRef}`)
 89 |   wand.transfer.fAll.of4b({ syncId }).then(r => {
 90 |     console.log('data', r)
 91 |     wand.currentSync = new wand.conductor.Sync(r, userRef)
 92 |   })
 93 | }
 94 | if (!found) { // includes empty/no URL parameters:
 95 |   wand.showLoginDiv = true
 96 |   if (uargs.keys.length === 0) {
 97 |     wand.test.welcome()
 98 |   } else {
 99 |     window.open(window.location.origin, '_self')
100 |   }
101 | }
102 |
103 | if (uargs.keys.includes('stay')) wand.utils.confirmExit()
104 |
105 | window.onbeforeunload = e => wand.unloadFuncs.forEach(f => f(e))
106 |
107 | wand.router.mkFooter()
108 |


--------------------------------------------------------------------------------
/scripts/modules/conductor/index.js:
--------------------------------------------------------------------------------
1 | module.exports = {
2 |   Tithorea: require('./tithorea.js').Tithorea,
3 |   Sync: require('./sync.js').Sync,
4 |   You: require('./you.js').You,
5 |   utils: require('./utils.js')
6 | }
7 |


--------------------------------------------------------------------------------
/scripts/modules/conductor/instruments.js:
--------------------------------------------------------------------------------
 1 | const e = module.exports
 2 | e.amset = {
 3 |   volume: 0,
 4 |   detune: 0,
 5 |   portamento: 0,
 6 |   harmonicity: 2.5,
 7 |   oscillator: {
 8 |     partialCount: 0,
 9 |     partials: [],
10 |     phase: 0,
11 |     type: 'fatsawtooth',
12 |     count: 3,
13 |     spread: 20
14 |   },
15 |   envelope: {
16 |     attack: 0.1,
17 |     attackCurve: 'linear',
18 |     decay: 0.2,
19 |     decayCurve: 'exponential',
20 |     release: 0.3,
21 |     releaseCurve: 'exponential',
22 |     sustain: 0.2
23 |   },
24 |   modulation: {
25 |     partialCount: 0,
26 |     partials: [],
27 |     phase: 0,
28 |     type: 'square'
29 |   },
30 |   modulationEnvelope: {
31 |     attack: 0.5,
32 |     attackCurve: 'linear',
33 |     decay: 0.01,
34 |     decayCurve: 'exponential',
35 |     release: 0.5,
36 |     releaseCurve: 'exponential',
37 |     sustain: 1
38 |   }
39 | }
40 |


--------------------------------------------------------------------------------
/scripts/modules/conductor/sync.js:
--------------------------------------------------------------------------------
  1 | const $ = require('jquery')
  2 | const chroma = require('chroma-js')
  3 | const Tone = require('tone')
  4 | const dat = require('dat.gui')
  5 | const subGraph = require('graphology-utils/subgraph')
  6 | const showdown = require('showdown')
  7 |
  8 | const { PIXI, defaultLinkRenderer, activateLink, rec, nl, linkify2, mkIds } = require('./utils.js')
  9 | const { generateName } = require('./nameGen.js')
 10 | // const { amset } = require('./instruments.js')
 11 | window.mkIds = mkIds
 12 |
 13 | const net = require('../net.js')
 14 | const utils = require('../utils.js')
 15 | // const u = require('../router.js').urlArgument
 16 |
 17 | const copyToClipboard = utils.copyToClipboard
 18 | const d = (f, time) => Tone.Draw.schedule(f, time)
 19 |
 20 | // volume OK, rec OK, linkify OK, beautify, spread
 21 | // pt if pt speaking countries, en otherwise
 22 |
 23 | window.showdown = showdown
 24 | showdown.extension('targetlink', function () {
 25 |   return [{
 26 |     type: 'html',
 27 |     regex: /(<a [^>]+?)(>.*<\/a>)/g,
 28 |     replace: '$1 target="_blank"$2'
 29 |   }]
 30 | })
 31 | const converter = new showdown.Converter({
 32 |   extensions: ['targetlink']
 33 | })
 34 | window.mconv = converter
 35 |
 36 | module.exports.Sync = class {
 37 |   constructor (data, heir) {
 38 |     this.heir = heir
 39 |     this.isMobile = utils.mobileAndTabletCheck()
 40 |     this.data = data
 41 |     this.source = data.source
 42 |     // plot stuff
 43 |     $('#loading').hide()
 44 |     const app = this.app = window.wand.app = new PIXI.Application({
 45 |       width: window.innerWidth,
 46 |       height: window.innerHeight * 0.9,
 47 |       backgroundColor: 0x000000,
 48 |       antialias: true
 49 |     })
 50 |     app.stage.sortableChildren = true
 51 |     $('#canvasDiv').append(this.app.view)
 52 |     this.net_ = net.plotSync(data, app, false)
 53 |     if (/^\d+$/.test(this.heir)) {
 54 |       this.heir = parseInt(heir)
 55 |       this.oldFormat = true
 56 |       this.net_.forEachNode((n, a) => {
 57 |         if (a.did === this.heir) this.heirId = n
 58 |       })
 59 |     } else {
 60 |       this.heir = heir
 61 |       const nodes = []
 62 |       let absorb = (n, a) => nodes.push({ name: n, tel: a.tel })
 63 |       if (this.source === 'fb') absorb = (n, a) => nodes.push({ id: n, name: a.name, nid: a.nid, sid: a.sid })
 64 |       this.net_.forEachNode((n, a) => absorb(n, a))
 65 |       this.ids_ = mkIds(nodes, this.data.source)
 66 |       const key = this.source === 'fb' ? 'id' : 'name'
 67 |       this.net_.forEachNode((n, a) => {
 68 |         if (this.ids_[a[key]] === this.heir) this.heirId = n
 69 |       })
 70 |     }
 71 |     this.net = this.setDists()
 72 |     // net.attrNet(this.net)
 73 |     // const pfm = this.pfm = net.plotSync(data, app)
 74 |     const pfm = this.pfm = net.attrNet(this.net, app)
 75 |     const dn = new net.ParticleNet2(app, pfm.net, pfm.atlas)
 76 |     pfm.dn = dn
 77 |     this.net = pfm.net
 78 |     this.net.forEachNode((n, a) => {
 79 |       a.pixiElement.alpha = 0
 80 |     })
 81 |     this.setup()
 82 |   }
 83 |
 84 |   setup () {
 85 |     window.defaultLinkRenderer = defaultLinkRenderer
 86 |     this.setProgression()
 87 |     // this.hideAll()
 88 |     this.setMusic()
 89 |     this.volumeControl()
 90 |     this.setInfo() // when user gives ok on info, music starts
 91 |     // make music!
 92 |   }
 93 |
 94 |   setInfo () {
 95 |     this.setDesc()
 96 |   }
 97 |
 98 |   hideAll () {
 99 |     this.net.forEachNode((n, a) => { a.pixiElement.alpha = 0 })
100 |     this.net.forEachEdge((n, a) => { a.pixiElement.alpha = 0 })
101 |     this.arrows.forEach(a => { a.alpha = 0 })
102 |   }
103 |
104 |   setMusic () {
105 |     // this.amSy = new Tone.AMSynth(amset).toDestination() // random walk it in pentatonic
106 |     const mkSong = () => {
107 |       Tone.Transport.bpm.value = 140
108 |       // Tone.Transport.bpm.value = 240
109 |       const vol = this.vol = new Tone.Volume(-6).toDestination()
110 |       const rev = window.rev = new Tone.Reverb().connect(vol)
111 |       rev.wet.value = 0.9
112 |       const msy = new Tone.MembraneSynth().connect(rev)
113 |       const msy2 = new Tone.MembraneSynth().connect(rev)
114 |       const nsy = new Tone.NoiseSynth({ envelope: { attack: 0.05 } }).connect(rev)
115 |       const isy = new Tone.MetalSynth().connect(rev)
116 |       const isy2 = new Tone.MetalSynth().connect(rev)
117 |       isy.volume.value = -16
118 |       isy2.volume.value = -19
119 |       nsy.volume.value = -13
120 |
121 |       const pe1 = this.net.getNodeAttribute(this.heirId, 'pixiElement')
122 |       const te1 = this.net.getNodeAttribute(this.heirId, 'textElement')
123 |       const pe0 = this.net.getNodeAttribute(this.predecessor, 'pixiElement')
124 |       const te0 = this.net.getNodeAttribute(this.predecessor, 'textElement')
125 |       const zabumba = new Tone.Part((time, note) => {
126 |         if (note === 'C#1') {
127 |           if (Math.random() < 0.2) msy2.triggerAttackRelease(note, '8n', time)
128 |           else return
129 |         } else {
130 |           msy.triggerAttackRelease(note, '8n', time)
131 |         }
132 |         // const pe = Math.random() > 0.2 ? pe1 : pe0
133 |         const [pe, te] = note === 'C1' ? [pe1, te1] : [pe0, te0]
134 |         if (note === 'G1') activateLink(pe0, pe1, this.app)
135 |         d(() => { // blink current or predecessor
136 |           pe.tint = te.tint = 0xffffff * Math.random()
137 |           pe.alpha = 0.6
138 |           te.alpha = 1
139 |           pe.scale.set((2 + 10 * Math.random()) / 10)
140 |         }, time)
141 |         // d(() => { // blink current or predecessor
142 |         //   pe.tint = pe.stdTint
143 |         //   pe.alpha = 1
144 |         //   te.alpha = 0
145 |         //   pe.scale.set(1)
146 |         // }, time + 0.5)
147 |       }, [[0, 'C1'], ['0:0:1.8', 'C#1'], ['0:1:2', 'C1'], ['0:3', 'G1']])
148 |       zabumba.loop = true
149 |       zabumba.humanize = true
150 |
151 |       const les = this.leafs.map(i => [
152 |         this.net.getNodeAttribute(i, 'pixiElement'),
153 |         this.net.getNodeAttribute(i, 'textElement')
154 |       ])
155 |       let leCount = 0
156 |       const chocalho = new Tone.Pattern((time, note) => {
157 |         nsy.triggerAttackRelease('2n', time)
158 |         const [pe, te] = les[leCount++ % les.length]
159 |         d(() => { // blink current or predecessor
160 |           pe.tint = te.tint = 0xffffff
161 |           te.alpha = 1
162 |           pe.alpha = 1
163 |           pe.scale.set(2 / 10)
164 |         }, time)
165 |         d(() => { // blink current or predecessor
166 |           pe.tint = pe.stdTint
167 |           te.alpha = 0
168 |           pe.scale.set(1 / 10)
169 |         }, time + 0.3)
170 |       }, ['C4', 'G4', 'B4', 'C4'])
171 |       chocalho.interval = '8n'
172 |       // chocalho.humanize = true
173 |
174 |       const pes = this.successors.map(i => [
175 |         this.net.getNodeAttribute(i, 'pixiElement'),
176 |         this.net.getNodeAttribute(i, 'textElement')
177 |       ])
178 |       let peCount = 0
179 |       const succ = new Tone.Sequence((time, note) => {
180 |         isy.triggerAttackRelease(note, '8n', time)
181 |         const [pe, te] = pes[peCount++ % pes.length]
182 |         activateLink(pe1, pe, this.app, 0xff0000)
183 |         d(() => { // blink current or predecessor
184 |           pe.tint = te.tint = 0xffffff * Math.random()
185 |           pe.alpha = 1
186 |           te.alpha = 1
187 |           pe.scale.set(3 / 10)
188 |         }, time)
189 |         d(() => { // blink current or predecessor
190 |           pe.tint = pe.stdTint
191 |           te.alpha = 0
192 |           pe.scale.set(1 / 10)
193 |         }, time + 0.5)
194 |       }, [[null, 'G2'], ['C2', null], ['C3', 'E3'], [null, 'G3']], '4n')
195 |       succ.probability = 0.4
196 |       succ.humanize = true
197 |
198 |       // const seq2 = new Tone.Sequence((time, note) => {
199 |       //   isy2.triggerAttackRelease(note, '8n', time)
200 |       // }, ['C8', 'G8'], '4n').start('+2')
201 |       let reCount = 0
202 |       const res = this.remainingNodes.map(i => [
203 |         this.net.getNodeAttribute(i, 'pixiElement'),
204 |         this.net.getNodeAttribute(i, 'textElement')
205 |       ])
206 |       const agogo = new Tone.Sequence((time, note) => {
207 |         isy2.triggerAttackRelease(note, '8n', time)
208 |         const res_ = res[reCount++ % res.length]
209 |         if (res_ === undefined) return
210 |         const [pe, te] = res_
211 |         d(() => { // blink current or predecessor
212 |           pe.tint = te.tint = 0xff00ff
213 |           te.alpha = 1
214 |           pe.alpha = 1
215 |           pe.scale.set(1.3 / 10)
216 |         }, time)
217 |         d(() => { // blink current or predecessor
218 |           pe.tint = pe.stdTint
219 |           te.alpha = 0
220 |           pe.scale.set(1 / 10)
221 |         }, time + 0.4)
222 |       }, ['C7', 'G7'], '4n')
223 |       agogo.humanize = true
224 |       const actions = [
225 |         t => zabumba.start(t),
226 |         t => succ.start(t),
227 |         t => chocalho.start(t),
228 |         t => zabumba.stop(t) && agogo.start(t),
229 |         t => chocalho.stop(t),
230 |         t => zabumba.start(t),
231 |         t => chocalho.start(t),
232 |         t => {
233 |           zabumba.stop(t)
234 |           succ.stop(t)
235 |           chocalho.stop(t)
236 |           agogo.stop(t)
237 |           Tone.Transport.schedule(t2 => {
238 |             msy.triggerAttackRelease('C2', '2n', t2)
239 |             this.setLinks()
240 |             Tone.Transport.stop()
241 |             if (this.recording) setTimeout(() => this.rec.astop(), 1000)
242 |           }, t)
243 |         }
244 |       ]
245 |       actions.forEach((a, i) => a('+' + (1 + 4 * i) + 'm'))
246 |       window.all = {
247 |         zabumba, nsy, msy, chocalho, succ, isy, agogo // , score
248 |       }
249 |       $('#loading').hide()
250 |     }
251 |     mkSong()
252 |   }
253 |
254 |   setProgression () {
255 |     this.arrows = []
256 |     this.progression = [[this.data.links[0][0].from]]
257 |     this.data.links.forEach((step, i) => {
258 |       const stepNodes = []
259 |       step.forEach(link => {
260 |         if (!this.net.hasEdge(link.from, link.to)) return
261 |         this.arrows.push(defaultLinkRenderer(link, this.net, this.app))
262 |         if (!stepNodes.includes(link.to)) stepNodes.push(link.to)
263 |       })
264 |       this.progression.push(stepNodes)
265 |     })
266 |     const cs = chroma.scale(['red', 'yellow', 'green', 'cyan', 'blue', '#ff00ff']).colors(this.progression.length, 'num')
267 |     this.progression.forEach((nodes, i) => {
268 |       const c = cs[i]
269 |       nodes.forEach(n => {
270 |         this.net.getNodeAttribute(n, 'pixiElement').tint = c
271 |         this.net.getNodeAttribute(n, 'pixiElement').stdTint = c
272 |         this.net.setNodeAttribute(n, 'stepColor', c)
273 |       })
274 |     })
275 |     this.predecessor = this.net.inNeighbors(this.heirId)[0]
276 |     if (this.predecessor === undefined) {
277 |       this.isSeed = true
278 |       this.predecessor = this.heirId
279 |     }
280 |     this.successors = this.net.outNeighbors(this.heirId)
281 |     this.leafs = []
282 |     this.net.forEachNode(n => {
283 |       if (this.net.outNeighbors(n).length === 0 && !this.successors.includes(n)) this.leafs.push(n)
284 |     })
285 |     if (this.successors.length === 0) {
286 |       this.isLeaf = true
287 |       this.successors = this.leafs
288 |     }
289 |     const allNodes = [this.heirId, this.predecessor, ...this.successors, ...this.leafs]
290 |     this.remainingNodes = this.net.nodes().filter(n => !allNodes.includes(n))
291 |   }
292 |
293 |   setDists () {
294 |     console.log('heirId:', this.heirId, this.source)
295 |     let currentNodes = [this.heirId]
296 |     const consideredNodes = [this.heirId]
297 |     let newNeighs = [this.heirId]
298 |     // while (consideredNodes.length < 50 && newNeighs.length !== 0) {
299 |     while (consideredNodes.length < 25 && newNeighs.length !== 0) {
300 |       newNeighs = []
301 |       currentNodes.forEach(n => {
302 |         this.net_.forEachNeighbor(n, nn => {
303 |           if (!consideredNodes.includes(nn)) {
304 |             newNeighs.push(nn)
305 |             consideredNodes.push(nn)
306 |           }
307 |         })
308 |       })
309 |       currentNodes = newNeighs
310 |     }
311 |     return subGraph(this.net_, consideredNodes).copy()
312 |   }
313 |
314 |   setDesc () {
315 |     const name = this.net.getNodeAttribute(this.heirId, 'name')
316 |     $('<div/>', {
317 |       id: 'myModal2',
318 |       class: 'modal',
319 |       role: 'dialog'
320 |     }).appendTo('body')
321 |       .append($('<div/>', {
322 |         id: 'mcontent0',
323 |         class: 'modal-content',
324 |         css: { background: '#eeffee' }
325 |       }).html(`<h2>${nl.header(name)}</h2>`)
326 |         .append($('<p/>', { id: 'mcontent2' }))
327 |       )
328 |     $('#myModal2').css('z-index', 0)
329 |     const diag2 = $('<div/>', {
330 |       id: 'diag2'
331 |     })
332 |
333 |     // Tone.setContext(new Tone.Context({ latencyHint: 'playback' }))
334 |     $('<button/>', {
335 |       css: {
336 |         background: 'white',
337 |         border: '4px solid #449944',
338 |         'border-radius': '8px',
339 |         'font-size': 'larger',
340 |         cursor: 'pointer'
341 |       }
342 |     }).html(nl.listen()).on('click', () => {
343 |       Tone.start()
344 |       Tone.Transport.start('+0.1')
345 |       // this.seq.start(2)
346 |       // if (Tone.context.state === 'running') {
347 |       setTimeout(() => {
348 |         if (Tone.Transport.state === 'started') {
349 |           $('#myModal2').hide(2000)
350 |         }
351 |       }, 500)
352 |     }).appendTo(diag2)
353 |       .hover(function (e) {
354 |         $(this).css('background', e.type === 'mouseenter' ? '#e4f3e6' : 'transparent')
355 |       })
356 |
357 |     // todo: support biligual description
358 |     const content = `
359 |     <p>
360 |       ${nl.song(generateName(name, this.data.syncId))}<br><br>
361 |     </p>
362 |
363 |     <div style="background:#ffffee;padding:2%;border-radius:5%;margin:2%">
364 |       <div style="font-family:Georgia">
365 |         ${linkify2(converter.makeHtml(this.data.desc))}
366 |       </div>
367 |     </div>
368 |     `
369 |     $('#mcontent2').html(content).append(diag2)
370 |     // $('#mcontent2', { css: { 'background-color': '#ffffcc' } }).html(content).append(diag2)
371 |     $('#myModal2').show()
372 |   }
373 |
374 |   findSeed () {
375 |     this.net_.forEachNode((n, a) => {
376 |       if (this.net_.inNeighbors(n).length === 0) {
377 |         this.seedId = n
378 |         this.seedAttrs = a
379 |       }
380 |     })
381 |   }
382 |
383 |   setLinks () {
384 |     let links
385 |     if (this.isLeaf) {
386 |       this.findSeed()
387 |       $('#mcontent0').html(`<h2>${nl.leaf0()}</h2>`).append($('<p/>', { id: 'mcontent2' }))
388 |       links = nl.leaf(this.seedAttrs.name, this.net.getNodeAttribute(this.predecessor, 'name')).replace(/\n/g, '<br />')
389 |     } else {
390 |       $('#mcontent0').html(`<h2>${nl.succLinks()}</h2>`).append($('<p/>', { id: 'mcontent2' }))
391 |       const clang = window.wand.speaksPortuguese ? ['copiar ', 'Copiado: '] : ['copy ', 'Copied: ']
392 |       links = this.successors.map((i, ii) => {
393 |         const { id, name, did } = this.net.getNodeAttributes(i)
394 |         const link = `${window.location.origin}?${this.data.syncId}=${did || this.ids_[this.source === 'fb' ? id : name]}`
395 |         const p = $('<li/>').html(name + ': ')
396 |         const a = $('<a/>', {
397 |           href: link,
398 |           target: '_blank'
399 |         }).html(link).appendTo(p)
400 |         const bcolors = ['palegreen', 'lightblue', 0]
401 |         const btn = utils.mkBtn('copy', clang[0] + link, function () {
402 |           copyToClipboard(link)
403 |           btn.mtooltip.text(clang[1] + link + ' !!!')
404 |           btn.css('background', bcolors[++bcolors[2] % 2])
405 |         }, a, ii, 3).mouseleave(function () {
406 |           btn.mtooltip.text(clang[0] + link)
407 |         }).css('margin', '2px 1%')
408 |         return p
409 |       })
410 |     }
411 |     $('#mcontent2').html($('<ul/>').append(links))
412 |     $('<button/>', {
413 |       css: {
414 |         background: 'white',
415 |         border: '4px solid #449944',
416 |         'border-radius': '8px',
417 |         'font-size': 'larger',
418 |         cursor: 'pointer'
419 |       }
420 |     }).html(nl.finall(this.recording, this.net.getNodeAttribute(this.heirId, 'name'))).click(() => {
421 |       // if (u('rec')) return this.rec.aa.click()
422 |       // window.alert('To record your music video, you will listen to it again.')
423 |       // window.open(window.location.href + '&rec=1')
424 |       if (this.recording) return this.rec.aa.click()
425 |       this.recording = true
426 |       this.rec = rec()
427 |       Tone.Transport.schedule(t2 => {
428 |         this.rec.astart()
429 |       }, '+1m')
430 |       Tone.start()
431 |       Tone.Transport.start('+0.1')
432 |       setTimeout(() => {
433 |         if (Tone.Transport.state === 'started') {
434 |           $('#myModal2').hide(2000)
435 |         }
436 |       }, 500)
437 |     }).appendTo('#mcontent2')
438 |       .hover(function (e) {
439 |         $(this).css('background', e.type === 'mouseenter' ? '#e4f3e6' : 'transparent')
440 |       })
441 |     $('#myModal2').fadeIn(4000)
442 |   }
443 |
444 |   volumeControl () {
445 |     const set = { closed: false }
446 |     set.width = window.innerWidth / 3.5
447 |     if (this.isMobile) set.width = window.innerWidth / 2
448 |     const gui = this.theGui = new dat.GUI(set)
449 |     const volGui = gui.add({ volume: 50 }, 'volume', 0, 100).listen()
450 |     volGui.onChange(val => {
451 |       this.vol.volume.value = val - 50
452 |     })
453 |     if (this.isMobile) {
454 |       $('.dg.main .close-button.close-bottom')
455 |         .css('padding-bottom', '10px').css('padding-top', '10px')
456 |       $('.dg .cr.number').css('height', '37px')
457 |       $('.dg .c .slider').css('height', '37px')
458 |       let open = true
459 |       $('.dg.main .close-button.close-bottom').click(() => {
460 |         if (open) {
461 |           $('.dg .cr.number').css('height', '0px')
462 |         } else {
463 |           $('.dg .cr.number').css('height', '37px')
464 |         }
465 |         open = !open
466 |       })
467 |     }
468 |     $('.dg').css('font-size', '24px')
469 |     // $('.close-button').css('background-color', '#777777')
470 |     $('.close-button')
471 |       .css('background-color', 'rgba(0,0,0,0)')
472 |       .css('border', 'solid #777777')
473 |       .click()
474 |     $('.dg .c input[type=text]').css('width', '15%')
475 |     $('.dg .c .slider').css('width', '80%')
476 |     $('.dg.main .close-button.close-bottom').click().hide()
477 |   }
478 | }
479 |


--------------------------------------------------------------------------------
/scripts/modules/conductor/tithorea.js:
--------------------------------------------------------------------------------
  1 | const $ = require('jquery')
  2 | const chroma = require('chroma-js')
  3 |
  4 | const net = require('../net.js')
  5 | const transfer = require('../transfer.js')
  6 | const u = require('../router.js').urlArgument
  7 | const utils = require('../utils.js')
  8 | const { PIXI, defaultLinkRenderer, mkIds } = require('./utils.js')
  9 |
 10 | const copyToClipboard = utils.copyToClipboard
 11 |
 12 | module.exports.Tithorea = class {
 13 |   constructor () {
 14 |     const app = this.app = window.wand.app = new PIXI.Application({
 15 |       width: window.innerWidth,
 16 |       height: window.innerHeight * 0.9,
 17 |       backgroundColor: 0x000000
 18 |     })
 19 |     app.stage.sortableChildren = true
 20 |     document.body.appendChild(app.view)
 21 |     if (u('id') || u('cid')) {
 22 |       (u('id') ? transfer.fAll.mark({ 'userData.id': u('id') }) : transfer.fAll.aeterni({ comName: u('cid') })).then(r => {
 23 |         console.log({ r })
 24 |         this.source = 'fb'
 25 |         const foo = u('id') ? 'net' : 'network'
 26 |         const anet = r[0][foo]
 27 |         const pfm = this.pfm = net.plotFromMongo(anet, app, u('deg'))
 28 |         const dn = new net.ParticleNet2(app, pfm.net, pfm.atlas)
 29 |         pfm.dn = dn
 30 |         this.setup(r)
 31 |       })
 32 |       console.log({ u }, 'yeah man')
 33 |     } else if (u('whats')) {
 34 |       this.source = 'whats'
 35 |       transfer.fAll.ttm({ marker: u('whats') }).then(r => {
 36 |         if (r.length === 0) return window.alert('data has been deleted')
 37 |         const pfm = this.pfm = net.plotWhatsFromMongo(r[0].data, r[0].creator, app, u('full') !== null)
 38 |         const dn = new net.ParticleNet2(app, pfm.net, pfm.atlas)
 39 |         pfm.dn = dn
 40 |         this.setup(r)
 41 |       })
 42 |     }
 43 |   }
 44 |
 45 |   setup (r) {
 46 |     this.data = r
 47 |     this.net = this.pfm.net
 48 |     this.arrows = []
 49 |     this.mkNodesReact()
 50 |     this.setDesc()
 51 |     this.mkButtons()
 52 |     $('#loading').hide()
 53 |   }
 54 |
 55 |   mkButtons () {
 56 |     utils.mkBtn('file-medical-alt', 'describe the sync', () => {
 57 |       $('#myModal').show()
 58 |     })
 59 |   }
 60 |
 61 |   mkNodesReact () {
 62 |     this.net.forEachNode((n, a) => {
 63 |       a.textElement.on('pointerdown', () => {
 64 |         if (this.theSeed === n) return this.consolidateDiff()
 65 |         this.theSeed = n
 66 |         this.net.forEachNode((n, a) => {
 67 |           a.pixiElement.tint = 0x00ffff
 68 |         })
 69 |         a.pixiElement.tint = 0xff0000
 70 |         this.diffusion = this.seededNeighborsLinks()
 71 |         this.arrows.forEach(a => a.destroy())
 72 |         this.arrows = []
 73 |         this.net.forEachEdge((e, a) => { a.pixiElement.alpha = 0 })
 74 |         this.diffusion.progressionLinks.forEach(step => {
 75 |           step.forEach(link => {
 76 |             this.arrows.push(defaultLinkRenderer(link, this.net, this.app))
 77 |             this.net.getEdgeAttribute(link.from, link.to, 'pixiElement').alpha = 1
 78 |           })
 79 |         })
 80 |         const cs = chroma.scale(['red', 'yellow', 'green', 'cyan', 'blue', '#ff00ff']).colors(this.diffusion.progression.length, 'num')
 81 |         this.diffusion.progression.forEach((nodes, i) => {
 82 |           const c = cs[i]
 83 |           nodes.forEach(n => {
 84 |             this.net.getNodeAttribute(n, 'pixiElement').tint = c
 85 |             this.net.getNodeAttribute(n, 'pixiElement').alpha = 1
 86 |             this.net.setNodeAttribute(n, 'stepColor', c)
 87 |           })
 88 |         })
 89 |       })
 90 |     })
 91 |   }
 92 |
 93 |   seededNeighborsLinks (nneighbors = 4) { // adapted from va.netscience.diffusion
 94 |     const net = this.net
 95 |     net.setNodeAttribute(this.theSeed, 'started', true)
 96 |     let seeds = [this.theSeed]
 97 |     const progression = [seeds]
 98 |     const progressionLinks = []
 99 |     while (seeds.length !== 0) {
100 |       const newSeeds = []
101 |       const progressionLinks_ = []
102 |       seeds.forEach(s => {
103 |         const candidates = []
104 |         net.forEachNeighbor(s, (nn, na) => {
105 |           if (!na.started) {
106 |             candidates.push({ n: nn, d: na.degree })
107 |           }
108 |         })
109 |         candidates.sort((i, j) => Math.random()).sort((i, j) => i.d - j.d).slice(0, nneighbors).forEach(c => {
110 |           net.setNodeAttribute(c.n, 'started', true)
111 |           newSeeds.push(c.n)
112 |           progressionLinks_.push({ from: s, to: c.n })
113 |         })
114 |       })
115 |       progression.push(newSeeds)
116 |       progressionLinks.push(progressionLinks_)
117 |       seeds = newSeeds
118 |     }
119 |     net.forEachNode((n, a) => {
120 |       delete a.started
121 |     })
122 |     return { progression, progressionLinks }
123 |   }
124 |
125 |   consolidateDiff () {
126 |     if (!window.confirm('all set to register a sync?')) return
127 |     const nodes = []
128 |     let absorb = (n, a) => nodes.push({ name: n, tel: a.tel })
129 |     if (this.source === 'fb') absorb = (n, a) => nodes.push({ id: n, name: a.name, nid: a.nid, sid: a.sid })
130 |     this.net.forEachNode((n, a) => absorb(n, a))
131 |     // nodes.forEach((n, i) => { n.did = i })
132 |     this.ids_ = mkIds(nodes, this.source)
133 |     this.toBeWritten = {
134 |       source: this.source,
135 |       desc: this.descArea.val(),
136 |       syncId: this.syncIdInput.val(),
137 |       links: this.diffusion.progressionLinks,
138 |       nodes
139 |     }
140 |     // get text to be diffused, and get an ID (e.g. love)
141 |     $('#loading').show()
142 |     const tbw = this.toBeWritten
143 |     transfer.fAll.wf4b(tbw).then(r => { // todo: check if syncId is already in use
144 |       $('#loading').hide()
145 |       const id = tbw.links[0][0].from
146 |       // const did = nodes.filter(i => (tbw.source === 'fb' ? i.id : i.name) === id)[0].did2
147 |       const did = this.ids_[id]
148 |       const link = `${window.location.origin}?${tbw.syncId}=${did}`
149 |       window.alert(`sync created! Link to it: ${link}`)
150 |       copyToClipboard(link)
151 |     }).catch(e => window.alert('not written', e))
152 |     console.log('tbw', this.toBeWritten)
153 |   }
154 |
155 |   setDesc () {
156 |     const diag2 = $('<div/>', {
157 |       id: 'diag2',
158 |       css: {
159 |         'background-color': 'white'
160 |       }
161 |     })
162 |
163 |     const templates = [
164 |       'daba',
165 |       'loto'
166 |     ]
167 |     let counter = 0
168 |     $('<button/>').html('template change').on('click', () => {
169 |       this.descArea.val(templates[++counter % templates.length])
170 |     }).appendTo(diag2)
171 |
172 |     this.syncIdInput = $('<input/>', { placeholder: 'love' }).appendTo(diag2)
173 |     this.descArea = $('<textarea/>', {
174 |       maxlength: 1200,
175 |       css: {
176 |         'background-color': 'white',
177 |         margin: 'auto',
178 |         width: '50%',
179 |         height: '50%'
180 |       }
181 |     }).on('keydown', () => {
182 |       // dcount.html(this.descArea.val().length + ' / 500')
183 |     }).html(templates[0]).appendTo(diag2)
184 |
185 |     $('#mcontent').html('write the HTML you want to diffuse:').append(diag2)
186 |   }
187 | }
188 |


--------------------------------------------------------------------------------
/scripts/modules/conductor/utils.js:
--------------------------------------------------------------------------------
  1 | /* global wand */
  2 | const e = module.exports
  3 | const PIXI = e.PIXI = require('pixi.js')
  4 | const linkify = require('linkifyjs/html')
  5 |
  6 | e.nl = {
  7 |   header: name => wand.speaksPortuguese ? `Olá, ${name}, há uma música feita para você e sobre você!` : `Hi ${name}, there is a song made for you and about you!`,
  8 |   listen: () => wand.speaksPortuguese ? 'Ok, quero ouvir minha música agora!' : 'Okay, I want to hear my music now!',
  9 |   song: sname => wand.speaksPortuguese ? `A música se chama <b>${sname}</b> e chegou junto a uma pequena mensagem de quem muito te admira:` : `The song is called <b>${sname}</b> and came with a small message from someone who admires you a lot:`,
 10 |   leaf0: () => wand.speaksPortuguese ? 'Parabéns, você é sucessor final da sincronização!' : 'Congratulations, you are a ultimate successor of the sync!',
 11 |   leaf: (tseedName, pName) => wand.speaksPortuguese
 12 |     ? `
 13 |   Avise o iniciador da sincronização que você, herdeiro final, recebeu sua música e mensagem.
 14 |   O nome delæ é ${tseedName}.
 15 |
 16 |   Você também pode querer avisar seu/sua predecessor(a), ${pName}, que você é herdeiro final!
 17 |   `
 18 |     : `
 19 |   Notify the sync initiator that you, ultimate heir, have received your music and message.
 20 |    His name is ${tseedName}
 21 |
 22 |    You might also want to let your predecessor ${pName} know that you are the final heir!
 23 |   `,
 24 |   succLinks: () => wand.speaksPortuguese ? 'Repasse as músicas dos seus sucessores para eles mesmos e ajude nesta sincronização social:' : 'Forward your successors\' songs to themselves and help in this social synchronization:',
 25 |   finall: (rec, name) => wand.speaksPortuguese ? `clique para ${rec ? 'baixar' : 'gravar'} o clipe da sua música, ${name}.` : `click to ${rec ? 'download' : 'record'} your music video, ${name}.`
 26 |
 27 | }
 28 |
 29 | e.defaultLinkRenderer = (link, net, app) => { // adapted from va.drawing.base
 30 |   // first, let's compute normalized vector for our link:
 31 |   const p1 = net.getNodeAttribute(link.from, 'pixiElement')
 32 |   const p2 = net.getNodeAttribute(link.to, 'pixiElement')
 33 |   const dx = p2.x - p1.x
 34 |   const dy = p2.y - p1.y
 35 |   const l = Math.sqrt(dx * dx + dy * dy)
 36 |
 37 |   if (l === 0) return // if length is 0 - can't render arrows
 38 |
 39 |   // This is our normal vector. It describes direction of the graph
 40 |   // link, and has length == 1:
 41 |   const nx = dx / l
 42 |   const ny = dy / l
 43 |
 44 |   // Now let's draw the arrow:
 45 |   const arrowLength = 13 // 26 // Length of the arrow
 46 |   const arrowWingsLength = 6 // 12 // How far arrow wings are from the link?
 47 |
 48 |   // This is where arrow should end. We do `(l - NODE_WIDTH)` to
 49 |   // make sure it ends before the node UI element.
 50 |   const NODE_WIDTH = 15
 51 |   const ex = p1.x + nx * (l - NODE_WIDTH)
 52 |   const ey = p1.y + ny * (l - NODE_WIDTH)
 53 |
 54 |   // Offset on the graph link, where arrow wings should be
 55 |   const sx = p1.x + nx * (l - NODE_WIDTH - arrowLength)
 56 |   const sy = p1.y + ny * (l - NODE_WIDTH - arrowLength)
 57 |
 58 |   // orthogonal vector to the link vector is easy to compute:
 59 |   const topX = -ny
 60 |   const topY = nx
 61 |
 62 |   // Let's draw the arrow:
 63 |   const graphics = new PIXI.Graphics()
 64 |   // graphics.lineStyle(1, 0xcccccc, 1)
 65 |   graphics.lineStyle(1, 0xcccccc, 1)
 66 |
 67 |   graphics.moveTo(ex, ey)
 68 |   graphics.lineTo(sx + topX * arrowWingsLength, sy + topY * arrowWingsLength)
 69 |   graphics.moveTo(ex, ey)
 70 |   graphics.lineTo(sx - topX * arrowWingsLength, sy - topY * arrowWingsLength)
 71 |   app.stage.addChild(graphics)
 72 |   graphics.zIndex = 20000
 73 |   return graphics
 74 | }
 75 |
 76 | function mkLink (p1, p2, color, app) {
 77 |   const graphics = new PIXI.Graphics()
 78 |   // graphics.lineStyle(1, 0xcccccc, 1)
 79 |   graphics.lineStyle(3, color, 1)
 80 |
 81 |   graphics.moveTo(p1.x, p1.y)
 82 |   graphics.lineTo(p2.x, p2.y)
 83 |   app.stage.addChild(graphics)
 84 |   return graphics
 85 | }
 86 |
 87 | function mklink (i, c1, c2, dx, dy, app, color) {
 88 |   const p = i / 10
 89 |   const x = c1[0] * (1 - p) + c2[0] * p
 90 |   const y = c1[1] * (1 - p) + c2[1] * p
 91 |   const p1 = { x: x + dx, y: y + dy }
 92 |   const p2 = { x: x - dx, y: y - dy }
 93 |   const link = mkLink(p1, p2, color || 0x00ff00, app)
 94 |   setTimeout(() => { link.destroy() }, 100 * i)
 95 | }
 96 |
 97 | e.activateLink = (p1, p2, app, color) => {
 98 |   const c1 = [p1.x, p1.y]
 99 |   const c2 = [p2.x, p2.y]
100 |   const slope = (c1[1] - c2[1]) / (c1[0] - c2[0])
101 |   const orthSlope = -1 / slope
102 |   const size = 5
103 |   const dx = size / Math.sqrt(1 + orthSlope ** 2)
104 |   const dy = orthSlope * dx
105 |   for (let i = 0; i < 10; i++) {
106 |     setTimeout(() => { mklink(i, c1, c2, dx, dy, app, color) }, 100 * i)
107 |   }
108 | }
109 |
110 | e.xmur3 = str => {
111 |   let h = 1779033703 ^ str.length
112 |   for (let i = 0; i < str.length; i++) {
113 |     h = Math.imul(h ^ str.charCodeAt(i), 3432918353)
114 |     h = h << 13 | h >>> 19
115 |   }
116 |   return function () {
117 |     h = Math.imul(h ^ h >>> 16, 2246822507)
118 |     h = Math.imul(h ^ h >>> 13, 3266489909)
119 |     return (h ^= h >>> 16) >>> 0
120 |   }
121 | }
122 |
123 | e.mulberry32 = a => {
124 |   return function () {
125 |     let t = a += 0x6D2B79F5
126 |     t = Math.imul(t ^ t >>> 15, t | 1)
127 |     t ^= t + Math.imul(t ^ t >>> 7, t | 61)
128 |     return ((t ^ t >>> 14) >>> 0) / 4294967296
129 |   }
130 | }
131 |
132 | e.seededRand = str => {
133 |   const seed = e.xmur3(str)
134 |   return e.mulberry32(seed())
135 | }
136 |
137 | e.rec = () => {
138 |   const actx = window.Tone.context
139 |   const dest = actx.createMediaStreamDestination()
140 |   window.Tone.Master.connect(dest)
141 |
142 |   const canvas = window.wand.app.view // document.querySelector('canvas')
143 |   const stream = canvas.captureStream(30)
144 |
145 |   const combined = new window.MediaStream([...dest.stream.getTracks(), ...stream.getTracks()])
146 |   let recorder = {}
147 |   if (window.MediaRecorder !== undefined) {
148 |     recorder = new window.MediaRecorder(combined, { mimeType: 'video/webm' })
149 |   }
150 |
151 |   let chunks = []
152 |   recorder.ondataavailable = evt => { chunks.push(evt.data) }
153 |   recorder.onstop = function () {
154 |     const blob = new window.Blob(chunks, { type: 'video/webm' })
155 |     const url = URL.createObjectURL(blob)
156 |     const a = document.createElement('a')
157 |     document.body.appendChild(a)
158 |     a.style = 'display: none'
159 |     a.href = url
160 |     a.download = (this.filename || 'test') + '.webm'
161 |     // a.click()
162 |     recorder.aa = a
163 |     // window.URL.revokeObjectURL(url)
164 |   }
165 |   recorder.astart = function () {
166 |     if (recorder.state === 'inactive') {
167 |       chunks = []
168 |       this.start()
169 |     }
170 |   }
171 |   recorder.astop = function () {
172 |     if (recorder.state === 'recording') {
173 |       this.stop()
174 |     } else {
175 |       window.alert('Use a media recording capable browser (such as Firefox or Chrome), or enable media recording (for example if using Safari), to download the audiovisual performance')
176 |     }
177 |   }
178 |   return recorder // use start(), stop() (which will trigger download)
179 | }
180 |
181 | e.linkify2 = link => linkify(`<span class="notranslate">${link}<span>`)
182 |
183 | e.mkIds = (nodes, source) => {
184 |   const ids = []
185 |   const ids_ = {}
186 |   const names = nodes.map(n => {
187 |     return {
188 |       name: n.name,
189 |       id: source === 'fb' ? n.id : n.name
190 |     }
191 |   })
192 |   names.sort((a, b) => { // todo: find alternative to Whats/Telegram
193 |     if (a.name > b.name) return -1
194 |     if (a.name < b.name) return 1
195 |     if (a.id > b.id) return -1
196 |     if (a.id < b.id) return 1
197 |     return 0
198 |   })
199 |   for (let ii = 0; ii < nodes.length; ii++) {
200 |     const n = names[ii]
201 |     const parts = n.name.split(' ')
202 |     let i = 0
203 |     let made = false
204 |     let did2 = parts[0]
205 |     do {
206 |       if (!ids.includes(did2)) {
207 |         ids.push(did2)
208 |         ids_[n.id] = did2
209 |         made = true
210 |       } else {
211 |         if (parts.length >= ++i) {
212 |           did2 = did2 + '.' + parts[i]
213 |         } else {
214 |           did2 = did2 + '.' + ids.reduce((a, e) => a + (e === did2), 0)
215 |         }
216 |       }
217 |     } while (!made)
218 |   }
219 |   return ids_
220 | }
221 |


--------------------------------------------------------------------------------
/scripts/modules/losdheaders.js:
--------------------------------------------------------------------------------
1 | const losdheaders = { authorization: 'Bearer eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJwcm9kLXVzZXItY2xpZW50OnJmYWJicmkiLCJpc3MiOiJhZ2VudDpyZmFiYnJpOjo5YTc5MjA0OC00MDU0LTQ1NzQtODI5OS04MzU2NTVmZjk1NTYiLCJpYXQiOjE1NjA5Mzc2NDcsInJvbGUiOlsidXNlcl9hcGlfcmVhZCIsInVzZXJfYXBpX3dyaXRlIl0sImdlbmVyYWwtcHVycG9zZSI6dHJ1ZSwic2FtbCI6e319.MWcLAY_4bA20A6S8J2f8W2aHEQOrSw-yPCx1dBQHz97krLaRtiS7Yb9IUU1_gNYUO6x7y5fjvO1hB4hteCB1iQ' }
2 |
3 | module.exports = { losdheaders }
4 |


--------------------------------------------------------------------------------
/scripts/modules/maestro.js:
--------------------------------------------------------------------------------
  1 | const d = require('./utils.js').defaultArg
  2 | const { chooseUnique } = require('./utils.js')
  3 | const t = require('tone')
  4 |
  5 | const e = module.exports
  6 |
  7 | e.mkOsc = (freq, vol, pan, type, noConnect, nostart) => {
  8 |   const panner = new t.Panner(d(pan, 1))
  9 |   if (!noConnect) panner.toDestination()
 10 |   const synth = new t.Oscillator(d(freq, 200), d(type, 'sine')).connect(panner)
 11 |   if (!nostart) synth.start()
 12 |   synth.volume.value = d(vol, -200)
 13 |   synth.panner = panner
 14 |   return synth
 15 | }
 16 |
 17 | e.sounds = [
 18 |   ['aloop', 38],
 19 |   ['ocean1', 65],
 20 |   ['boom', 1.5]
 21 | ].map(i => { return { name: i[0], duration: i[1] } })
 22 |
 23 | e.Speaker = class {
 24 |   play (ttext, lang, loop) {
 25 |     if (!ttext) {
 26 |       ttext = chooseUnique(this.sentences, 1)[0]
 27 |     }
 28 |     const utterThis = new window.SpeechSynthesisUtterance(ttext)
 29 |     utterThis.volume = this.volume || 1
 30 |     if (!lang) {
 31 |       lang = chooseUnique(this.languages, 1)[0]
 32 |     } else {
 33 |       if (lang.length === 2) {
 34 |         lang = this.languages.filter(i => i.lang.slice(0, 2) === lang)
 35 |       } else {
 36 |         lang = this.languages.filter(i => i.lang === lang)
 37 |       }
 38 |       lang = lang.filter(i => !i.name.includes('Google'))
 39 |       lang = chooseUnique(lang, 1)[0]
 40 |     }
 41 |     console.log(lang)
 42 |     utterThis.voice = lang
 43 |     this.synth.speak(utterThis)
 44 |     if (loop) {
 45 |       utterThis.onend = () => this.synth.speak(utterThis)
 46 |       return utterThis
 47 |     }
 48 |   }
 49 |
 50 |   langs () {
 51 |     console.log(this.languages.map(i => i.lang))
 52 |   }
 53 |
 54 |   langsNames () {
 55 |     console.log(this.languages.map(i => [i.lang, i.name]))
 56 |   }
 57 |
 58 |   constructor (sentences = [], languages = []) {
 59 |     this.synth = window.speechSynthesis
 60 |     if (!this.synth) {
 61 |       return
 62 |     }
 63 |     this.languages = languages
 64 |     this.sentences = sentences
 65 |     if (!languages || languages.length === 0) {
 66 |       this.languages = this.synth.getVoices()
 67 |       setTimeout(() => {
 68 |         this.languages = this.synth.getVoices()
 69 |       }, 100)
 70 |     }
 71 |     if (!sentences || sentences.length === 0) {
 72 |       this.sentences = [
 73 |         'abracadabra',
 74 |         'abracadabra, pêlo de cabra',
 75 |         'abra de sésamo',
 76 |         'sim sim salabim',
 77 |         '96, 96 / 96',
 78 |         'peace and grace',
 79 |         'Refuá Elohim',
 80 |         'I eye and the "I AM"!',
 81 |         'chokurei',
 82 |         'sina toki e toki sona anu seme?',
 83 |         'time is money'
 84 |       ]
 85 |     }
 86 |   }
 87 | }
 88 |
 89 | e.speaker = new e.Speaker()
 90 |
 91 | e.recOffline = (fun, dur, bitdepth, filename) => {
 92 |   const wavefile = require('wavefile')
 93 |   const wav = new wavefile.WaveFile()
 94 |   const performance = window.performance
 95 |   let now = performance.now()
 96 |   t.Offline(() => {
 97 |     fun()
 98 |   }, dur).then(buffer => {
 99 |     console.log((performance.now() - now) / 1000)
100 |     now = performance.now()
101 |     console.log('buffer in')
102 |     if (bitdepth === '16') {
103 |       const bar_ = []
104 |       buffer.toArray().forEach(chan => {
105 |         const [max, min] = chan.reduce((mm, i) => {
106 |           if (i > mm[0]) mm[0] = i
107 |           if (i < mm[1]) mm[1] = i
108 |           return mm
109 |         }, [-Infinity, Infinity])
110 |         console.log('MAXMIN', max, min)
111 |         const chan_ = chan.map(i => Math.floor((2 ** 15 - 1) * (2 * (i - min) / (max - min) - 1)))
112 |         bar_.push(chan_)
113 |       })
114 |       wav.fromScratch(2, 44100, '16', bar_)
115 |       console.log('16', true)
116 |     } else {
117 |       console.log('32', true)
118 |       wav.fromScratch(2, 44100, '32f', buffer.toArray())
119 |       console.log((performance.now() - now) / 1000)
120 |       now = performance.now()
121 |       // wav.fromBuffer(buffer.get())
122 |     }
123 |     doIt()
124 |   })
125 |   function doIt () {
126 |     console.log('wav in')
127 |     const uri = wav.toDataURI()
128 |     const a = document.createElement('a')
129 |     document.body.appendChild(a)
130 |     a.style = 'display: none'
131 |     a.href = uri
132 |     console.log('URI ok', (performance.now() - now) / 1000)
133 |     now = performance.now()
134 |     console.log('url in')
135 |     a.download = (filename || 'test') + '.wav'
136 |     a.click()
137 |     console.log('click download ok', (performance.now() - now) / 1000)
138 |     console.log('clicked')
139 |   }
140 | }
141 |


--------------------------------------------------------------------------------
/scripts/modules/med/common.js:
--------------------------------------------------------------------------------
 1 | const e = module.exports
 2 |
 3 | e.waveforms = {
 4 |   0: 'sine',
 5 |   1: 'triangle',
 6 |   2: 'square',
 7 |   3: 'sawtooth'
 8 | }
 9 |
10 | e.permfuncs = {
11 |   0: 'shuffle',
12 |   1: 'rotateForward',
13 |   2: 'rotateBackward',
14 |   3: 'reverse',
15 |   4: 'none'
16 | }
17 |
18 | e.times = [
19 |   [0, 0],
20 |   [1, 11],
21 |   [2, 22],
22 |   [3, 33],
23 |   [4, 44],
24 |   [5, 55],
25 |   [6, 30],
26 |   [7, 7],
27 |   [8, 8],
28 |   [9, 9],
29 |   [10, 10],
30 |   [11, 11],
31 |   [12, 12],
32 |   [13, 13],
33 |   [14, 14],
34 |   [15, 15],
35 |   [16, 16],
36 |   [17, 17],
37 |   [18, 18],
38 |   [19, 19],
39 |   [20, 20],
40 |   [21, 21],
41 |   [22, 22],
42 |   [23, 23]
43 | ]
44 |
45 | e.nextSync = (justStr, fake) => {
46 |   const d = new Date()
47 |   if (fake) d.setUTCFullYear(d.getUTCFullYear() + 1)
48 |   let ii
49 |   if (d.getHours() === 23 && d.getMinutes() > 22) ii = 0
50 |   else {
51 |     e.times.some((t, i) => {
52 |       ii = i
53 |       return t[0] >= d.getHours()
54 |     })
55 |     if (e.times[ii][0] === d.getHours() && e.times[ii][1] <= d.getMinutes()) ii++
56 |   }
57 |   if (justStr) {
58 |     const s = i => String(i).padStart(2, '0')
59 |     return e.times[ii].map(i => s(i)).join(':')
60 |   }
61 |   d.setHours(e.times[ii][0])
62 |   d.setMinutes(e.times[ii][1])
63 |   d.setSeconds(0)
64 |   d.setMilliseconds(0)
65 |   if (ii === 0) d.setHours(d.getHours() + 24)
66 |   return d
67 | }
68 |


--------------------------------------------------------------------------------
/scripts/modules/med/index.js:
--------------------------------------------------------------------------------
1 | module.exports = {
2 |   model: require('./model1').meditation,
3 |   Model2: require('./model2').Med,
4 |   Model3: require('./model3').Med, // keep? TTM
5 |   Mk: require('./mk').Mk,
6 |   Doc: require('./doc').Doc
7 | }
8 |


--------------------------------------------------------------------------------
/scripts/modules/med/model1.js:
--------------------------------------------------------------------------------
  1 | const t = require('tone')
  2 | const $ = require('jquery')
  3 | const PIXI = require('pixi.js')
  4 | const maestro = require('../maestro.js')
  5 | const transfer = require('../transfer.js')
  6 | const utils = require('../utils.js')
  7 | const u = require('../router.js').urlArgument
  8 |
  9 | const e = module.exports
 10 | const tr = PIXI.utils.string2hex
 11 |
 12 | e.meditation = mid => {
 13 |   transfer.findAny({ meditation: mid }).then(s => {
 14 |     window.sss = s
 15 |     $('#loading').hide()
 16 |     evocation.on('click', () => {
 17 |       $('#myModal').css('display', 'block')
 18 |       $('#mcontent').html(`
 19 |       <h2>Evocation <button onclick="wand.$('#techdiv').toggle()" id="techBtn">tech</button></h2>
 20 |       <p>
 21 |       I, [your name], will start my mentalization soon (or am mentalizing),
 22 |       and will concentrate for a total of ${s.d} seconds on the theme "${s.meditation.replaceAll('_', '')}".</p><br><br>
 23 |       <span id="techdiv"><p>I'll be using binaural frequencies ${s.fl} and ${s.fr} Hertz in the waveforms
 24 |       ${s.waveformL} and ${s.waveformR},<br>
 25 |       and respiration cycles from ${s.mp0} to ${s.mp1} seconds in a transition of ${s.md} seconds.<br>
 26 |       The respiration represented with oscillations of ${s.ma} Herz in the binaural frequencies.
 27 |       <br><br></p></span>
 28 |       <p>I ask [name of one or more entitites you worship or admire],<br>
 29 |       and my ally and akin essences,<br>
 30 |       for your company and conduction.
 31 |       </p><br><br><br>:::
 32 |       `)
 33 |       $('#techBtn').click()
 34 |     })
 35 |     if (s === null) {
 36 |       grid.css('background', '#ffaaaa')
 37 |       countdown.text("don't exist")
 38 |       conoff.attr('disabled', true)
 39 |       vonoff.text('-----')
 40 |     }
 41 |     const dt = u('s') ? utils.timeArgument() : s.dateTime
 42 |     let duration = (dt.getTime() - (new Date()).getTime()) / 1000
 43 |     if (u('t')) duration = parseFloat(u('t'))
 44 |     function caseConcluded () {
 45 |       vonoff.text('ask team to open a new session.')
 46 |       countdown.text('concluded')
 47 |     }
 48 |     function caseOnOrConcluded () {
 49 |       conoff.attr('checked', true).attr('disabled', true)
 50 |       console.log(duration, s.d)
 51 |       if (-duration < s.d) { // ongoing
 52 |         vonoff.text('join a session before it starts.')
 53 |         // start timer for s.d - duration
 54 |         setCountdown(s.d + duration, caseConcluded, undefined, 'ongoing; countdown to conclude: ')
 55 |       } else { // finished
 56 |         caseConcluded()
 57 |       }
 58 |       grid.css('background', '#ddddff')
 59 |     }
 60 |     if (duration < 0) {
 61 |       return caseOnOrConcluded()
 62 |     }
 63 |     let sampler
 64 |     if (s.soundSample > 0) {
 65 |       sampler = new t.Player(`assets/audio/${maestro.sounds[s.soundSample].name}.mp3`).toDestination()
 66 |       sampler.volume.value = parseFloat(s.soundSampleVolume)
 67 |       sampler.loop = s.soundSamplePeriod === 0
 68 |     }
 69 |
 70 |     const { ticker, synth, synthR, synthM, mod_ } = initialize(s)
 71 |
 72 |     setCountdown(duration, fun1, undefined, 'countdown to start: ')
 73 |     function fun1 () { // to start the med
 74 |       if (!conoff.prop('checked')) {
 75 |         return caseOnOrConcluded()
 76 |       }
 77 |       setSounds(ticker)
 78 |       t.Master.mute = false
 79 |       if (s.vcontrol) tgui(synth, synthR, synthM, sampler)
 80 |       if (s.soundSample > 0) {
 81 |         setTimeout(() => {
 82 |           if (sampler.loop) {
 83 |             sampler.start()
 84 |           } else {
 85 |             new t.Loop(time => {
 86 |               sampler.start()
 87 |             }, s.soundSamplePeriod).start()
 88 |           }
 89 |         }, (s.soundSampleStart || 0) * 1000)
 90 |       }
 91 |       synth.volume.rampTo(-40, 1)
 92 |       synthR.volume.rampTo(-40, 1)
 93 |       synthM.volume.rampTo(-40, 1)
 94 |       mod_.frequency.rampTo(1 / s.mp1, s.md)
 95 |       grid.css('background', 'lightgreen')
 96 |       setCountdown(s.d, fun2, [synth, synthR, synthM], 'countdown to conclude: ')
 97 |     }
 98 |     function fun2 (synth, synthR, synthM) { // to finish the med
 99 |       grid.css('background', '#aaaaff')
100 |       countdown.text('finished')
101 |       synth.volume.rampTo(-400, 10)
102 |       synthR.volume.rampTo(-400, 10)
103 |       synthM.volume.rampTo(-400, 10)
104 |     }
105 |     grid.css('background', '#ffffaa')
106 |   })
107 |   function setCountdown (duration, fun, args, countdownText) { // duration in seconds
108 |     const targetTime = (new Date()).getTime() / 1000 + duration
109 |     setTimeout(() => {
110 |       fun(...(args || []))
111 |       clearInterval(timer)
112 |     }, duration * 1000, ...(args || []))
113 |     const reduce = dur => [Math.floor(dur / 60), Math.floor(dur % 60)]
114 |     const p = num => num < 10 ? '0' + num : num
115 |     const timer = setInterval(() => {
116 |       const moment = targetTime - (new Date()).getTime() / 1000
117 |       let [minutes, seconds] = reduce(moment)
118 |       let hours = ''
119 |       if (minutes > 59) {
120 |         [hours, minutes] = reduce(minutes)
121 |         hours += ':'
122 |       }
123 |       countdown.text((countdownText || 'countdown on ') + `${hours}${p(minutes)}:${p(seconds)}`)
124 |     }, 100)
125 |   }
126 |   const nodeContainer = new PIXI.ParticleContainer(10000, {
127 |     scale: true,
128 |     position: true
129 |   })
130 |
131 |   const myCircle = new PIXI.Graphics()
132 |     .beginFill(0xffffff)
133 |     .drawCircle(0, 0, 5)
134 |     .endFill()
135 |   const myCircle4 = new PIXI.Graphics() // vertical for breathing
136 |     .beginFill(0xffffff)
137 |     .drawCircle(0, 0, 5)
138 |     .endFill()
139 |
140 |   const app = new PIXI.Application({ // todo: make it resizable
141 |     width: window.innerWidth,
142 |     height: window.innerHeight * 0.80,
143 |     antialias: true
144 |   })
145 |   document.body.appendChild(app.view)
146 |   const [w, h] = [app.view.width, app.view.height]
147 |   const c = [w / 2, h / 2] // center
148 |   const a = w * 0.35
149 |
150 |   const circleTexture = app.renderer.generateTexture(myCircle)
151 |   // const circleTexture = PIXI.Texture.from('assets/heart.png') // todo: integrate images: chokurei, sei-he-ki, heart, jesus, dove, star of david
152 |   app.stage.addChild(nodeContainer)
153 |   function mkNode (pos, scale = 1, tint = 0xffffff) {
154 |     const circle = new PIXI.Sprite(circleTexture)
155 |     circle.position.set(...(pos || [0, 0]))
156 |     circle.anchor.set(0.5, 0.5)
157 |     circle.scale.set(scale, scale)
158 |     circle.tint = tint
159 |     nodeContainer.addChild(circle)
160 |     return circle
161 |   }
162 |
163 |   // to draw the sinusoid or lemniscate:
164 |   const xy = (angle, vertical) => { // lemniscate x, y given angle
165 |     const px = a * Math.cos(angle) / (1 + Math.sin(angle) ** 2)
166 |     const py = Math.sin(angle) * px
167 |     return vertical ? [py + c[1], px + c[0]] : [px + c[0], py + c[1]]
168 |   }
169 |   const [x, y] = [w * 0.1, h * 0.5] // for sinusoid
170 |   const [dx, dy] = [w * 0.8, h * 0.4] // for sinusoid
171 |
172 |   function initialize (s) {
173 |     const [x0, y0] = s.lemniscate ? c : [w * 0.2, h * 0.2]
174 |     const myLine = new PIXI.Graphics()
175 |     const segments = 100
176 |     if (s.lemniscate) {
177 |       myCircle4.x = s.bPos === 0 ? c[0] : s.bPos === 1 ? (c[0] - a) / 2 : (3 * c[0] + a) / 2
178 |       myLine.lineStyle(1, 0xffffff)
179 |         .moveTo(...xy(0))
180 |       for (let i = 0; i <= segments; i++) {
181 |         myLine.lineTo(...xy(2 * Math.PI * i / 100))
182 |       }
183 |     } else {
184 |       myLine.lineStyle(1, 0xffffff)
185 |         .moveTo(x, y)
186 |       for (let i = 0; i <= segments; i++) {
187 |         myLine.lineTo(x + dx * i / segments, y + Math.sin(2 * Math.PI * i / segments) * dy)
188 |       }
189 |       const myCircle_ = mkNode([x0, y0]) // fixed left
190 |       const myCircle__ = mkNode([x0, y0]) // fixed right
191 |       myCircle__.position.set(x, y)
192 |       myCircle_.position.set(x + dx, y)
193 |       myCircle_.tint = myCircle__.tint = tr(s.fgc)
194 |       myCircle4.x = s.bPos === 0 ? x + dx / 2 : s.bPos === 1 ? x * 0.5 : x + dx * 1.05
195 |     }
196 |
197 |     const theCircle = mkNode([x0, s.lemniscate ? y / 2 : y0]) // moving white circle to which the flakes go
198 |     const myCircle2 = mkNode(undefined, 1, 0xffff00) // lateral (sinus), right (lemniscate)
199 |     const myCircle3 = mkNode(undefined, 1, 0x00ff00) // center (sinus), left (lemniscate)
200 |
201 |     const co = new PIXI.Container()
202 |     app.stage.addChild(co)
203 |     co.addChild(myLine)
204 |     co.addChild(myCircle4) // breathing cue
205 |
206 |     theCircle.tint = myLine.tint = tr(s.fgc)
207 |     myCircle2.tint = tr(s.lcc)
208 |     myCircle3.tint = tr(s.ccc)
209 |     myCircle4.tint = tr(s.bcc)
210 |     app.renderer.backgroundColor = tr(s.bgc)
211 |
212 |     const synth = maestro.mkOsc(s.fl, -400, -1, s.waveformL || 'sine')
213 |     const synthR = maestro.mkOsc(s.fr, -400, 1, s.waveformR || 'sine')
214 |     const mul = new t.Multiply(s.ma)
215 |     const met2 = new t.DCMeter()
216 |     const mod_ = maestro.mkOsc(1 / s.mp0, 0, 0, 'sine', true).fan(met2, mul)
217 |     let synthM
218 |     if (s.model === '0') {
219 |       mul.chain(new t.Add(s.fl), synth.frequency)
220 |       mul.chain(new t.Add(s.fr), synthR.frequency)
221 |     } else if (s.model === '1') {
222 |       synthM = maestro.mkOsc(0, -400, 0, s.waveformM || 'sine')
223 |       mul.chain(new t.Add(s.mf0), synthM.frequency)
224 |     }
225 |
226 |     const pOsc = parseInt(s.panOsc)
227 |     if (pOsc === 1 || pOsc === 2) { // sinusoid pan oscillation
228 |       let panOsc
229 |       if (pOsc === 1) { // in sync with Martigli oscillation
230 |         panOsc = mod_
231 |       } else { // independent period
232 |         panOsc = maestro.mkOsc(1 / s.panOscPeriod, 0, 0, 'sine', true)
233 |       }
234 |       const neg = new t.Negate()
235 |       const mul1 = new t.Multiply(1)
236 |       panOsc.fan(neg, mul1)
237 |       mul1.connect(synth.panner.pan)
238 |       neg.connect(synthR.panner.pan)
239 |     } else if (pOsc === 3) { // envelope pan oscillation
240 |       // 1s transition, thus period > 1s
241 |       let oTrans = parseFloat(s.panOscTrans)
242 |       oTrans = oTrans === undefined ? 1 : oTrans
243 |       const env = new t.Envelope({
244 |         attack: oTrans,
245 |         decay: 0.01,
246 |         sustain: 1,
247 |         release: oTrans,
248 |         attackCurve: 'linear',
249 |         releaseCurve: 'linear'
250 |       }).chain(new t.Multiply(2), (new t.Add(-1)).connect(synth.panner.pan), new t.Negate(), synthR.panner.pan)
251 |       const aPer = parseFloat(s.panOscPeriod)
252 |       new t.Loop(time => {
253 |         env.triggerAttackRelease(aPer, time)
254 |       }, aPer * 2).start()
255 |       t.Transport.start()
256 |     }
257 |
258 |     // ticker stuff:
259 |     let propx = 1
260 |     let propy = 1
261 |     let rot = Math.random() * 0.1
262 |     const parts = []
263 |     let f1 = (n, sx, sy, mag) => {
264 |       n.x += sx / mag + (Math.random() - 0.5) * 5
265 |       n.y += sy / mag + (Math.random() - 0.5) * 5
266 |     }
267 |     if (s.rainbowFlakes) {
268 |       f1 = (n, sx, sy, mag) => {
269 |         n.x += sx / mag + (Math.random() - 0.5) * 5
270 |         n.y += sy / mag + (Math.random() - 0.5) * 5
271 |         n.tint = (n.tint + 0xffffff * 0.1 * Math.random()) % 0xffffff
272 |       }
273 |     }
274 |     let lastdc = 0
275 |     const ticker = app.ticker.add(() => {
276 |       const dc = met2.getValue()
277 |       if (dc - lastdc > 0) { // inhale
278 |         // mais proximo de 0, mais colorido
279 |         m1.css('opacity', 1 - Math.abs(dc))
280 |         m2.css('opacity', 0)
281 |       } else { // exhale
282 |         // mais proximo de 0, mais colorido
283 |         m2.css('opacity', 1 - Math.abs(dc))
284 |         m1.css('opacity', 0)
285 |       }
286 |       lastdc = dc
287 |       const val = -dc
288 |       const avalr = Math.asin(val) // radians in [-pi/2, pi/2]
289 |       if (s.lemniscate) {
290 |         const p = xy(avalr < 0 ? 2 * Math.PI + avalr : avalr)
291 |         myCircle2.x = p[0]
292 |         myCircle2.y = myCircle3.y = p[1]
293 |         myCircle3.x = 2 * c[0] - p[0]
294 |         myCircle4.y = val * a * 0.5 + y
295 |       } else {
296 |         const px = (avalr < 0 ? 2 * Math.PI + avalr : avalr) / (2 * Math.PI) * dx + x
297 |         const px2 = (Math.PI - avalr) / (2 * Math.PI) * dx + x
298 |         myCircle2.x = px
299 |         myCircle2.y = myCircle3.y = myCircle4.y = val * dy + y
300 |         myCircle3.x = px2
301 |       }
302 |
303 |       const sc = 0.3 + (-val + 1) * 3
304 |       myCircle4.scale.set(sc * propx, sc * propy)
305 |       myCircle4.rotation += rot
306 |
307 |       if (s.ellipse && sc - 0.3 < 0.0005) {
308 |         rot = Math.random() * 0.1
309 |         propx = Math.random() * 0.6 + 0.4
310 |         propy = 1 / propx
311 |       }
312 |
313 |       parts.push(mkNode([myCircle2.x, myCircle2.y], 0.3, myCircle2.tint))
314 |       parts.push(mkNode([myCircle3.x, myCircle3.y], 0.3, myCircle3.tint))
315 |       if (Math.random() > 0.98) {
316 |         parts.push(mkNode([myCircle4.x, myCircle4.y], 0.3, myCircle4.tint))
317 |       }
318 |
319 |       theCircle.x += (Math.random() - 0.5)
320 |       theCircle.y += (Math.random() - 0.5)
321 |       for (let ii = 0; ii < parts.length; ii++) {
322 |         const n = parts[ii]
323 |         const sx = theCircle.x - n.x
324 |         const sy = theCircle.y - n.y
325 |         const mag = (sx ** 2 + sy ** 2) ** 0.5
326 |         if (mag < 5) {
327 |           parts.splice(ii, 1)
328 |           n.destroy()
329 |         } else {
330 |           f1(n, sx, sy, mag)
331 |         }
332 |       }
333 |     })
334 |     setTimeout(() => ticker.stop(), 200)
335 |     return { mod_, synth, synthR, synthM, ticker }
336 |   }
337 |   function setSounds (ticker) {
338 |     ticker.start()
339 |   }
340 |
341 |   const grid = utils.mkGrid(2)
342 |     .css('background', 'grey')
343 |     .append($('<div/>').text('status:'))
344 |   const countdown = $('<div/>').appendTo(grid).html('loading...')
345 |
346 |   const vonoff = $('<div/>', { id: 'vonoff' }).appendTo(grid).text('Check me to join in:')
347 |   const conoff = $('<input/>', { type: 'checkbox' })
348 |     .appendTo(grid).change(function () {
349 |       if (this.checked) {
350 |         this.disabled = true
351 |         t.start()
352 |         t.Master.mute = true
353 |         vonoff.text('All set! Just wait.')
354 |         grid.css('background', 'lightgreen')
355 |       }
356 |     })
357 |
358 |   $('<div/>').text('inhale').appendTo(grid)
359 |   const m1 = $('<div/>').appendTo(grid)
360 |     .css('background', 'rgb(255,255,0)')
361 |     .css('opacity', 0)
362 |   $('<div/>').text('exhale').appendTo(grid)
363 |   const m2 = $('<div/>').appendTo(grid)
364 |     .css('opacity', 0)
365 |   t.Master.mute = true
366 |
367 |   $('<div/>', { id: 'myModal', class: 'modal' }).appendTo('body')
368 |     .append($('<div/>', { class: 'modal-content' })
369 |       .append($('<span/>', { class: 'close' }).html('&times;')
370 |         .on('click', () => {
371 |           $('#myModal').css('display', 'none')
372 |         })
373 |       )
374 |       .append($('<p/>', { id: 'mcontent' }))
375 |     )
376 |   window.onclick = function (event) {
377 |     if (event.target === $('#myModal')[0]) {
378 |       $('#myModal').css('display', 'none')
379 |     }
380 |   }
381 |   // $('#mgrid-0 div').css('background-color', 'rgba(1,0,0,0.9)')
382 |   $('#mgrid-0 *').each((i, e) => {
383 |     window.eee = e
384 |     e.style.backgroundColor = `rgba(255,255,255,${Math.floor(i / 2) % 2 === 1 ? 0.3 : 0})`
385 |     e.style.padding = '1%'
386 |   })
387 |   m1.css('background', 'rgb(255,255,0)')
388 |   m2.css('background', 'rgb(255,255,0)')
389 |   const evocation = $('<button/>', {
390 |     css: {
391 |       'background-color': 'white',
392 |       // border: '2px solid #a7a7a7',
393 |       border: '2px solid #cafbfb',
394 |       color: 'black',
395 |       cursor: 'pointer',
396 |       'transition-duration': '0.4s',
397 |       'border-radius': '6px',
398 |       'margin-left': '5%',
399 |       'margin-right': '5%',
400 |       'margin-top': '2px'
401 |     }
402 |   }).html('Evocation').appendTo(grid).hover(function (e) {
403 |     $(this).css('background-color', e.type === 'mouseenter' ? '#cafbfb' : 'white')
404 |   })
405 |   const gitems = [
406 |     'use headphones whenever possible;',
407 |     'breath with the vertical position of the oval or circular visual cue that don\'t change horizontal position and that expands and contracts;',
408 |     'adjust the sound volume and the screen luminosity;',
409 |     'concentrate;',
410 |     'close your eyes whenever you wish;',
411 |     'such breathing cycles are also represented in the status and help colored section, at the bottom of the page;',
412 |     'repeat the concentration a number of times so you develop the means to better perform;',
413 |     'read the evocation message and adapt it to your repertoire;',
414 |     'mentally visualize the changes in your life, in the life of the loved and known ones, the ones that need the most, and the whole of humanity;',
415 |     'it is usually best to breath using less air when the breathing cycle is fast, and more air as it slows down;',
416 |     'be flexible in your breathing and use the cues mainly to maintain the breathing rhythm: you may hold air in your lungs or hold your breath without air as you wish.'
417 |   ].reduce((a, i) => a + `<li>${i}</li>`, '')
418 |   $('<button/>', {
419 |     css: {
420 |       'background-color': 'white',
421 |       border: '2px solid #cafbfb',
422 |       color: 'black',
423 |       cursor: 'pointer',
424 |       'transition-duration': '0.4s',
425 |       'border-radius': '6px',
426 |       'margin-left': '5%',
427 |       'margin-right': '5%',
428 |       'margin-top': '2px'
429 |     }
430 |   }).html('Guidance').appendTo(grid)
431 |     .on('click', () => {
432 |       $('#myModal').css('display', 'block')
433 |       $('#mcontent').html(`
434 |       <h2>Guidance</h2>
435 |       Some considerations for you to have a nice experience:<br>
436 |       <ul>${gitems}</ul>
437 |
438 |       Good luck and thank you!
439 |       <br><br><br>:::
440 |       `)
441 |     }).hover(function (e) {
442 |       $(this).css('background-color', e.type === 'mouseenter' ? '#cafbfb' : 'white')
443 |     })
444 | }
445 |
446 | function tgui (synth, synthR, synthM, sampler) {
447 |   console.log(synth, synthR, synthM, 'HEREEE')
448 |   const dat = require('dat.gui')
449 |   const gui = new dat.GUI({ closed: true, closeOnTop: true })
450 |
451 |   const binaural = gui.add({ binaural: 50 }, 'binaural', 0, 100).listen()
452 |   let masterV = 0
453 |   const syInitV = -40
454 |   binaural.onChange(v => {
455 |     const aval = v - 50 + masterV + syInitV
456 |     synthR.volume.rampTo(aval, 0.1)
457 |     synth.volume.rampTo(aval, 0.1)
458 |   })
459 |   const syInitM = -40
460 |   if (synthM) {
461 |     const m = gui.add({ Martigli: 50 }, 'Martigli', 0, 100).listen()
462 |     m.onChange(v => {
463 |       const aval = v - 50 + masterV + syInitM
464 |       synthM.volume.rampTo(aval, 0.1)
465 |     })
466 |   }
467 |   let sInitV
468 |   if (sampler) {
469 |     sInitV = sampler.volume.value
470 |     const sample = gui.add({ sample: 50 }, 'sample', 0, 100).listen()
471 |     sample.onChange(v => {
472 |       sampler.volume.value = v - 50 + masterV + sInitV
473 |     })
474 |   }
475 |   if (sampler || synthM) {
476 |     const master = gui.add({ master: 50 }, 'master', 0, 100).listen()
477 |     master.onChange(v => {
478 |       masterV = v - 50
479 |       const aval = v - 50 + masterV + syInitV
480 |       console.log(aval, 'AVAL')
481 |       synthR.volume.rampTo(aval, 0.1)
482 |       synth.volume.rampTo(aval, 0.1)
483 |       if (sampler) sampler.volume.rampTo(v - 50 + masterV + sInitV, 0.1)
484 |       if (synthM) synthM.volume.rampTo(v - 50 + masterV + syInitM, 0.1)
485 |     })
486 |   }
487 |   window.agui = gui
488 |   $('.close-top').text('Open Volume Controls')
489 |   let i = 0
490 |   $('.close-top').click(function () {
491 |     console.log(this, 'yeah2')
492 |     this.textContent = `${i++ % 2 === 0 ? 'Close' : 'Open'} Volume Controls`
493 |     window.ttt = this
494 |   })
495 | }
496 |


--------------------------------------------------------------------------------
/scripts/modules/med/model2.js:
--------------------------------------------------------------------------------
  1 | const PIXI = require('pixi.js')
  2 | const c = require('chroma-js')
  3 |
  4 | const baseModel = require('./baseModel.js')
  5 |
  6 | const e = module.exports
  7 | const tr = PIXI.utils.string2hex
  8 |
  9 | // todo:
 10 | // line thickness
 11 | // 3d drawing
 12 | // draw as trajectory happens
 13 |
 14 | e.Med = class extends baseModel.Med {
 15 |   setVisual (s) { // todo: enhance code quality
 16 |     const { app, mkNode, bCircle, myCircle2, myCircle3, w, h, c, a, dx, dy } = this.visCom
 17 |
 18 |     const [x, y] = [w * 0.1, h * 0.5] // for sinusoid, left-most point
 19 |     const [aLx, aLy] = [w * 0.4, h * 0.4]
 20 |     const [aLx_, aLy_] = [aLx / 15, aLy / 15]
 21 |     const [a_, a__, h_] = [w * 0.13, h * 0.15, h * 0.05] // for trefoil
 22 |
 23 |     const myLine = new PIXI.Graphics()
 24 |       .lineStyle(1, 0xffffff)
 25 |     myLine.tint = tr(s.fgc)
 26 |     app.stage.addChild(myLine)
 27 |     const segments = 1000
 28 |
 29 |     function xyL (angle, vertical) { // lemniscate x, y given angle. todo: use the vertical
 30 |       const px = a * Math.cos(angle) / (1 + Math.sin(angle) ** 2)
 31 |       const py = Math.sin(angle) * px
 32 |       return vertical ? [py + c[1], px + c[0]] : [px + c[0], py + c[1]]
 33 |     }
 34 |
 35 |     function xyT (angle) { // trefoil x, y given angle. todo: add downward
 36 |       const px = a_ * (Math.sin(angle) + 2 * Math.sin(2 * angle))
 37 |       const py = a__ * (Math.cos(angle) - 2 * Math.cos(2 * angle))
 38 |       return [px + c[0], py + c[1] + h_]
 39 |     }
 40 |
 41 |     function xy8 (angle) {
 42 |       const foo = (2 + Math.cos(2 * angle))
 43 |       return [c[0] + a_ * foo * Math.cos(3 * angle), c[1] + a__ * foo * Math.sin(3 * angle)]
 44 |     }
 45 |
 46 |     const [aX, aY] = [a_ * 0.8, a__ * 0.8]
 47 |     function xyTorus (angle, torus, vertical) { // torus knot x, y given angle
 48 |       const foo = 3 + Math.cos(4 * angle)
 49 |       return [c[0] + aX * foo * Math.cos(3 * angle), c[1] + aY * foo * Math.sin(3 * angle)]
 50 |     }
 51 |
 52 |     function xyCinque (angle, torus, vertical) { // torus knot x, y given angle
 53 |       const foo = 3 + Math.cos(5 * angle)
 54 |       return [c[0] + aX * foo * Math.cos(2 * angle), c[1] + aY * foo * Math.sin(2 * angle)]
 55 |     }
 56 |
 57 |     const [aXX, aYY] = [a_ * 1.8, a__ * 1.8]
 58 |     const c1 = c[1] * 0.84
 59 |     function xyTorusDec (angle, torus, vertical) { // lemniscate x, y given angle
 60 |       const foo = 1 + 0.45 * Math.cos(3 * angle) + 0.4 * Math.cos(9 * angle)
 61 |       return [c[0] + aXX * foo * Math.sin(2 * angle), c1 + aYY * foo * Math.cos(2 * angle)]
 62 |     }
 63 |
 64 |     function xyLis (angle, kx, ky) { // torus knot x, y given angle
 65 |       const x = aLx * Math.cos(kx * angle)
 66 |       const y = aLy * Math.sin(ky * angle)
 67 |       return [c[0] + x, c[1] + y]
 68 |     }
 69 |     const xyLis35 = angle => xyLis(angle, 3, 4)
 70 |
 71 |     function xyRay (angle) {
 72 |       const foo = 2 * angle + 1 / angle
 73 |       const x = aLx_ * (foo + 2 * Math.cos(14 * angle))
 74 |       const y = aLy_ * (foo + 2 * Math.sin(15 * angle))
 75 |       return [c[0] / 6 + x, c[1] / 6 + y]
 76 |     }
 77 |
 78 |     let [prevX1, prevY1] = c
 79 |     let [prevX2, prevY2] = c
 80 |     function xyVoid (angle) {
 81 |       prevX1 += 0.1 * aLx_ * (Math.random() - 0.5)
 82 |       prevY1 += 0.1 * aLy_ * (Math.random() - 0.5)
 83 |       prevX2 += 0.1 * aLx_ * (Math.random() - 0.5)
 84 |       prevY2 += 0.1 * aLy_ * (Math.random() - 0.5)
 85 |       return [[prevX1, prevY1], [prevX2, prevY2]]
 86 |     }
 87 |
 88 |     const xyLisDyn = angle => xyLis(angle, 3, 4.02)
 89 |     // let [lastX, lastY] = xyLisDyn(0)
 90 |     function xyDyn (angle) { // Lis with dynamic
 91 |       const [x, y] = xyLisDyn(angle)
 92 |       return [c[0] + x, c[1] + y]
 93 |     }
 94 |     window.xyDyn = xyDyn
 95 |     // 3, 2
 96 |     // 3, 8
 97 |     // 3,4
 98 |     // 3,9, avalr / 2
 99 |     // 3,12, avalr / 2
100 |
101 |     let xy
102 |     const table = []
103 |     if (s.lemniscate) {
104 |       const foo = [0, xyL, xyT, xy8, xyTorus, xyCinque, xyTorusDec, xyLis35, xyRay]
105 |       foo[31] = xyVoid
106 |       foo[32] = () => { }
107 |       window.fooo = foo
108 |       xy = foo[s.lemniscate]
109 |       if (s.lemniscate !== 8) {
110 |         for (let i = 0; i <= segments; i++) {
111 |           table.push(xy(2 * Math.PI * i / segments))
112 |         }
113 |       } else if (s.lemniscate < 30) {
114 |         for (let i = 0; i <= segments; i++) {
115 |           table.push(xy(1 + 13 * i / segments))
116 |         }
117 |       }
118 |     } else { // sinusoid
119 |       bCircle.x = s.bPos === 0 ? x + dx / 2 : s.bPos === 1 ? x * 0.5 : x + dx * 1.05
120 |       for (let i = 0; i <= segments; i++) {
121 |         table.push([x + dx * i / segments, y + Math.sin(2 * Math.PI * i / segments) * dy])
122 |       }
123 |       mkNode([x, y]) // fixed left
124 |         .tint = tr(s.fgc)
125 |       mkNode([x + dx, y]) // fixed right
126 |         .tint = tr(s.fgc)
127 |     }
128 |
129 |     if (s.lemniscate < 30) {
130 |       myLine.moveTo(...table[0])
131 |       for (let i = 1; i <= segments; i++) {
132 |         myLine.lineTo(...table[i])
133 |       }
134 |     }
135 |
136 |     const ticker = app.ticker.add(() => {
137 |       const val = -this.dc
138 |       const avalr = Math.asin(val) // radians in [-pi/2, pi/2]
139 |       if (s.lemniscate === 1) { // lemniscate:
140 |         const p = xy(avalr < 0 ? 2 * Math.PI + avalr : avalr)
141 |         myCircle2.x = p[0]
142 |         myCircle2.y = myCircle3.y = p[1]
143 |         myCircle3.x = 2 * c[0] - p[0]
144 |         bCircle.y = val * a * 0.5 + y
145 |       } else if (s.lemniscate === 2) { // trefoil:
146 |         const pos = xy(avalr + 3 * Math.PI / 2)
147 |         myCircle2.y = myCircle3.y = pos[1]
148 |         myCircle3.x = pos[0]
149 |         myCircle2.x = 2 * c[0] - pos[0]
150 |         bCircle.y = val * a * 0.5 + y
151 |       } else if (s.lemniscate === 3) { // fig8:
152 |         const pos = xy(avalr)
153 |         myCircle2.y = myCircle3.y = pos[1]
154 |         myCircle3.x = pos[0]
155 |         myCircle2.x = 2 * c[0] - pos[0]
156 |         bCircle.y = val * a * 0.5 + y
157 |       } else if (s.lemniscate === 4) { // Torus:
158 |         const pos = xy(-avalr)
159 |         myCircle2.y = myCircle3.y = pos[1]
160 |         myCircle3.x = pos[0]
161 |         myCircle2.x = 2 * c[0] - pos[0]
162 |         bCircle.y = val * a * 0.5 + y
163 |       } else if (s.lemniscate === 5) { // Cinque:
164 |         const avalr_ = avalr + Math.PI / 4
165 |         const pos = xy(avalr_)
166 |         const pos2 = xy(avalr_ + Math.PI)
167 |         myCircle3.y = pos[1]
168 |         myCircle3.x = pos[0]
169 |         myCircle2.y = pos2[1]
170 |         myCircle2.x = pos2[0]
171 |         bCircle.y = val * a * 0.5 + y
172 |       } else if (s.lemniscate === 6) { // TorusDec:
173 |         const pos = xy(avalr - Math.PI / 2)
174 |         myCircle2.y = myCircle3.y = pos[1]
175 |         myCircle3.x = pos[0]
176 |         myCircle2.x = 2 * c[0] - pos[0]
177 |         bCircle.y = val * a * 0.5 + y
178 |       } else if (s.lemniscate === 7) { // Lis34
179 |         const pos = xy(-avalr)
180 |         myCircle2.y = myCircle3.y = pos[1]
181 |         myCircle3.x = pos[0]
182 |         myCircle2.x = 2 * c[0] - pos[0]
183 |         bCircle.y = val * a * 0.5 + y
184 |       } else if (s.lemniscate === 8) { // Ray
185 |         const pos = xy(1 + (1 + val) * 6.5)
186 |         myCircle2.y = myCircle3.y = pos[1]
187 |         myCircle3.x = pos[0]
188 |         myCircle2.x = 2 * c[0] - pos[0]
189 |         bCircle.y = val * a * 0.5 + y
190 |       } else if (s.lemniscate === 31) { // Void
191 |         const p = xy()
192 |         myCircle2.position.set(...p[0])
193 |         myCircle3.position.set(...p[1])
194 |       } else if (s.lemniscate !== 32) { // sinusoid:
195 |         const px = (avalr < 0 ? 2 * Math.PI + avalr : avalr) / (2 * Math.PI) * dx + x
196 |         const px2 = (Math.PI - avalr) / (2 * Math.PI) * dx + x
197 |         myCircle2.x = px
198 |         myCircle2.y = myCircle3.y = val * dy + y
199 |         myCircle3.x = px2
200 |       }
201 |     })
202 |     ticker.stop()
203 |     const tickers = [ticker]
204 |     let ticker2
205 |     if (['uid', 'comName', 'network'].some(x => x in s)) {
206 |       ticker2 = this.initNetwork(s, app, myCircle2, myCircle3)
207 |     }
208 |     if (ticker2 === undefined) {
209 |       ticker2 = { start: () => { }, stop: () => { } }
210 |     }
211 |     tickers.push(ticker2)
212 |
213 |     return {
214 |       start: () => {
215 |         tickers.forEach(t => t.start())
216 |       },
217 |       stop: () => {
218 |         tickers.forEach(t => t.stop())
219 |       }
220 |     }
221 |   }
222 |
223 |   initNetwork (s, app, myCircle2, myCircle3) {
224 |     let component
225 |     let seed_
226 |     let seed
227 |     const cs = c.scale([myCircle2.tint, myCircle3.tint])
228 |     this.bounceFuncs.push(() => {
229 |       if (seed) {
230 |         // component.forEachNode((n, a) => { a.textElement.alpha = a.pixiElement.alpha = 0 })
231 |         // component.forEachEdge((e, a) => { a.pixiElement.alpha = 0 })
232 |         seed_.tint = component.target.tint = 0xffffff
233 |         seed = undefined
234 |       }
235 |     })
236 |     this.notBouncingFuncs.push(() => {
237 |       if (!seed && this.anet && this.anet.net) { // choose random seed using rot:
238 |         seed = this.anet.net.nodes_[Math.floor(this.anet.net.nodes_.length * Math.random())] // todo: use nodes ordered by degree
239 |         component = window.wand.net.getComponent(this.anet.net, seed, s.componentSize) // choose 10 members connected to the seed
240 |         window.gg = component
241 |         seed_ = component.getNodeAttributes(seed)
242 |         const cs_ = window.cs_ = cs.colors(component.ndist[1] + 1, 'num')
243 |         component.forEachNode((n, a) => {
244 |           // a.pixiElement.tint = a.textElement.tint = 0xffffff * Math.random()
245 |           a.pixiElement.tint = a.textElement.tint = cs_[a.ndist]
246 |         })
247 |         component.forEachEdge((e, a, n1, n2, a1, a2) => {
248 |           // a.pixiElement.tint = 0xffffff * Math.random()
249 |           a.pixiElement.tint = cs_[Math.min(a1.ndist, a2.ndist)]
250 |         })
251 |         seed_.pixiElement.tint = seed_.textElement.tint = myCircle2.tint
252 |         component.target.pixiElement.tint = component.target.textElement.tint = myCircle3.tint
253 |       } else if (component) {
254 |         const w = (1 + this.dc) / 2
255 |         component.forEachNode((n, a) => {
256 |           const h = a.ndist__
257 |           let v
258 |           if (w < h) {
259 |             v = 0
260 |             a.textElement.alpha = 0
261 |           } else if (w > h + component.h_) {
262 |             v = 1
263 |             a.textElement.alpha = 0
264 |           } else {
265 |             v = (w - h) / component.h_
266 |             a.textElement.alpha = v ** 0.2
267 |           }
268 |           a.pixiElement.alpha = !this.inhale || v
269 |         })
270 |         component.forEachEdge((e, a, n1, n2, a1, a2) => {
271 |           a.pixiElement.alpha = Math.min(a1.pixiElement.alpha, a2.pixiElement.alpha)
272 |         })
273 |       }
274 |     })
275 |     const f1_ = (n, c) => {
276 |       const sx = c.x - n.x
277 |       const sy = c.y - n.y
278 |       const mag = (sx ** 2 + sy ** 2) ** 0.5
279 |       n.x += sx / mag + (Math.random() - 0.5) * 5
280 |       n.y += sy / mag + (Math.random() - 0.5) * 5
281 |     }
282 |     let ticker
283 |     if (s.lemniscate === 32) {
284 |       ticker = app.ticker.add(() => {
285 |         if (component && component.target) {
286 |           f1_(myCircle2, seed_.pixiElement)
287 |           f1_(myCircle3, component.target.pixiElement)
288 |         } else {
289 |           myCircle2.x += (Math.random() - 0.5)
290 |           myCircle2.y += (Math.random() - 0.5)
291 |         }
292 |       })
293 |       ticker.stop()
294 |     }
295 |     return ticker
296 |   }
297 | }
298 |


--------------------------------------------------------------------------------
/scripts/modules/med/model3.js:
--------------------------------------------------------------------------------
 1 | const net = require('../net.js')
 2 | const baseModel = require('./baseModel.js')
 3 |
 4 | const e = module.exports
 5 |
 6 | // todo:
 7 | // linear vs rampto
 8 | // line thickness
 9 | // 3d drawing
10 | // draw as trajectory happens
11 |
12 | e.Med = class extends baseModel.Med {
13 |   setVisual (s) { // todo: enhance code quality
14 |     const { app, myCircle2, myCircle3 } = this.visCom
15 |
16 |     const f1_ = (n, c) => {
17 |       const sx = c.x - n.x
18 |       const sy = c.y - n.y
19 |       const mag = (sx ** 2 + sy ** 2) ** 0.5
20 |       n.x += sx / mag + (Math.random() - 0.5) * 5
21 |       n.y += sy / mag + (Math.random() - 0.5) * 5
22 |     }
23 |
24 |     let component
25 |     let seed_
26 |     if (s.lemniscate === 32) {
27 |       let seed
28 |       this.bounceFuncs.push(() => {
29 |         if (seed) {
30 |           component.forEachNode((n, a) => { a.textElement.alpha = a.pixiElement.alpha = 0 })
31 |           component.forEachEdge((e, a) => { a.pixiElement.alpha = 0 })
32 |           seed_.tint = component.target.tint = 0xffffff
33 |           seed = undefined
34 |         }
35 |       })
36 |       this.notBouncingFuncs.push(() => {
37 |         if (!seed && this.anet && this.anet.net) { // choose random seed using rot:
38 |           seed = this.anet.net.nodes_[Math.floor(this.anet.net.nodes_.length * Math.random())] // todo: use nodes ordered by degree
39 |           component = net.getComponent(this.anet.net, seed, s.componentSize) // choose 10 members connected to the seed
40 |           window.gg = component
41 |           seed_ = component.getNodeAttributes(seed)
42 |           component.forEachNode((n, a) => {
43 |             a.pixiElement.tint = a.textElement.tint = 0xffffff * Math.random()
44 |           })
45 |           component.forEachEdge((e, a) => {
46 |             a.pixiElement.tint = 0xffffff * Math.random()
47 |           })
48 |           seed_.pixiElement.tint = seed_.textElement.tint = myCircle2.tint
49 |           component.target.pixiElement.tint = component.target.textElement.tint = myCircle3.tint
50 |         } else if (component) {
51 |           const w = (1 + this.dc) / 2
52 |           component.forEachNode((n, a) => {
53 |             const h = a.ndist__
54 |             let v
55 |             if (w < h) {
56 |               v = 0
57 |               a.textElement.alpha = 0
58 |             } else if (w > h + component.h_) {
59 |               v = 1
60 |               a.textElement.alpha = 0
61 |             } else {
62 |               v = (w - h) / component.h_
63 |               a.textElement.alpha = v ** 0.2
64 |             }
65 |             a.pixiElement.alpha = v
66 |           })
67 |           component.forEachEdge((e, a, n1, n2, a1, a2) => {
68 |             a.pixiElement.alpha = Math.min(a1.pixiElement.alpha, a2.pixiElement.alpha)
69 |           })
70 |         }
71 |       })
72 |     }
73 |     const ticker = app.ticker.add(() => {
74 |       if (s.lemniscate === 32 && component && component.target) {
75 |         f1_(myCircle2, seed_.pixiElement)
76 |         f1_(myCircle3, component.target.pixiElement)
77 |       } else {
78 |         myCircle2.x += (Math.random() - 0.5)
79 |         myCircle2.y += (Math.random() - 0.5)
80 |       }
81 |     })
82 |     ticker.stop()
83 |
84 |     return {
85 |       start: () => {
86 |         ticker.start()
87 |       },
88 |       stop: () => {
89 |         ticker.stop()
90 |       }
91 |     }
92 |   }
93 | }
94 |


--------------------------------------------------------------------------------
/scripts/modules/monk/index.js:
--------------------------------------------------------------------------------
 1 | const $ = require('jquery')
 2 | const utils = require('../utils.js')
 3 | module.exports.prayers = require('./prayers.js')
 4 |
 5 | module.exports.verses = () => {
 6 |   return $.ajax({
 7 |     url: 'assets/text/biblePt.txt',
 8 |     success: data => {
 9 |       module.exports.biblePt = utils.chunkArray(data.split('\n'), 3).map(e => {
10 |         return { text: e[0], ref: e[1] }
11 |       })
12 |     }
13 |   })
14 | }
15 |


--------------------------------------------------------------------------------
/scripts/modules/monk/prayers.js:
--------------------------------------------------------------------------------
 1 | module.exports = {
 2 |   abertura: `
 3 |         Pedimos a você Deus Pai, Jesus Cristo, e Espírito Santo,
 4 |         proteção em nosso trabalho para nós e nossas famílias,
 5 |         graça para iluminarmos nossas vidas e a Humanidade.
 6 |         Que as nossas palavras, pensamentos, sentimentos e ações sejam agradáveis a Ti,
 7 |         e que nos concentremos em atuar em Seu Nome e para a Sua Obra.
 8 |         Rogamos que nos livre do engano, orgulho, vaidade e cobiça,
 9 |         e que tenhamos completa confiança em Ti e Sua Providência.
10 |   `,
11 |   fechamento: `
12 |         Obrigado Senhor pela oportunidade concedida,
13 |         pedimos que cuide de nós e de nossas famílias (e em especial de "nome do neófito").
14 |         Limpe nossos corpos, mentes, almas e espíritos de qualquer má influência
15 |         para que possamos continuar nosso trabalho de Luz para a Sua Glória.
16 |         Em Seu Nome, Deus Pai, Jesus Cristo, e Espírito Santo.
17 |   `,
18 |   paiNosso: `
19 |         Pai Nosso que estais nos Céus,
20 |         santificado seja o vosso Nome,
21 |         venha a nós o vosso Reino,
22 |         seja feita a vossa vontade
23 |         assim na terra como no Céu.
24 |         O pão nosso de cada dia nos dai hoje,
25 |         perdoai-nos as nossas ofensas
26 |         assim como nós perdoamos
27 |         a quem nos tem ofendido,
28 |         e não nos deixeis cair em tentação,
29 |         mas livrai-nos do Mal.
30 |   `,
31 |   daPaz: `
32 |         Senhor,
33 |         Fazei de mim um instrumento de vossa Paz.
34 |         Onde houver Ódio, que eu leve o Amor,
35 |         Onde houver Ofensa, que eu leve o Perdão.
36 |         Onde houver Discórdia, que eu leve a União.
37 |         Onde houver Dúvida, que eu leve a Fé.
38 |         Onde houver Erro, que eu leve a Verdade.
39 |         Onde houver Desespero, que eu leve a Esperança.
40 |         Onde houver Tristeza, que eu leve a Alegria.
41 |         Onde houver Trevas, que eu leve a Luz!
42 |
43 |         Ó Mestre,
44 |         fazei que eu procure mais:
45 |         consolar, que ser consolado;
46 |         compreender, que ser compreendido;
47 |         amar, que ser amado.
48 |         Pois é dando, que se recebe.
49 |         Perdoando, que se é perdoado e
50 |         é morrendo, que se vive para a vida eterna!
51 |
52 |         Amém
53 |   `
54 | }
55 |


--------------------------------------------------------------------------------
/scripts/modules/net.js:
--------------------------------------------------------------------------------
  1 | /* global wand */
  2 | const e = module.exports
  3 | const Graph = require('graphology')
  4 | window.amgraph = Graph
  5 | const { erdosRenyi } = require('graphology-generators/random')
  6 | const PIXI = require('pixi.js')
  7 | const { random } = require('graphology-layout')
  8 | const forceAtlas2 = require('graphology-layout-forceatlas2')
  9 | const netdegree = require('graphology-metrics/degree')
 10 | const subGraph = e.subGraph = require('graphology-utils/subgraph')
 11 | const netmetrics = require('graphology-metrics')
 12 | const louvain = require('graphology-communities-louvain')
 13 | const components = require('graphology-components')
 14 |
 15 | const { chooseUnique } = require('./utils')
 16 | const u = require('./router.js').urlArgument
 17 |
 18 | e.netdegree = netdegree
 19 |
 20 | e.eR = (order, probability) => {
 21 |   return erdosRenyi(Graph, { order, probability })
 22 | }
 23 |
 24 | e.ParticleNet = class {
 25 |   constructor (app, nodes, edges) {
 26 |     this.mkContainers(app)
 27 |     this.mkTextures(app)
 28 |     this.plot(nodes, edges)
 29 |     this.input = { app, nodes, edges }
 30 |   }
 31 |
 32 |   mkContainers (app) {
 33 |     this.nodeContainer = new PIXI.ParticleContainer(100000, {
 34 |       scale: true,
 35 |       position: true,
 36 |       rotation: true,
 37 |       alpha: true
 38 |     })
 39 |     this.edgeContainer = new PIXI.ParticleContainer(10000000, {
 40 |       scale: true,
 41 |       position: true,
 42 |       rotation: true,
 43 |       alpha: true
 44 |     })
 45 |     app.stage.addChild(this.edgeContainer)
 46 |     app.stage.addChild(this.nodeContainer)
 47 |   }
 48 |
 49 |   mkTextures (app) {
 50 |     const myLine = new PIXI.Graphics()
 51 |       .lineStyle(1, 0xffffff)
 52 |       .moveTo(0, 0)
 53 |       .lineTo(1000, 0)
 54 |     const myCircle = new PIXI.Graphics()
 55 |       .beginFill(0xffffff)
 56 |       .drawCircle(0, 0, 5)
 57 |       .endFill()
 58 |     this.circleTexture = app.renderer.generateTexture(myCircle)
 59 |     this.lineTexture = app.renderer.generateTexture(myLine)
 60 |   }
 61 |
 62 |   plot (nodes, edges) {
 63 |     nodes.forEach(n => this.mkNode(n))
 64 |     edges.forEach(e => this.mkEdge(nodes[e[0]], nodes[e[1]]))
 65 |   }
 66 |
 67 |   mkNode (pos) {
 68 |     const circle = new PIXI.Sprite(this.circleTexture)
 69 |     circle.x = pos[0]
 70 |     circle.y = pos[1]
 71 |     circle.anchor.x = 0.5
 72 |     circle.anchor.y = 0.5
 73 |     this.nodeContainer.addChild(circle)
 74 |   }
 75 |
 76 |   mkEdge (pos1, pos2) {
 77 |     const line = new PIXI.Sprite(this.lineTexture)
 78 |     const dx = pos2[0] - pos1[0]
 79 |     const dy = pos2[1] - pos1[1]
 80 |     const length = (dx ** 2 + dy ** 2) ** 0.5
 81 |     line.scale.set(length / 1000, 1)
 82 |     const angle = Math.atan2(dy, dx)
 83 |     line.rotation = angle
 84 |     line.x = pos1[0]
 85 |     line.y = pos1[1]
 86 |     this.edgeContainer.addChild(line)
 87 |   }
 88 | }
 89 |
 90 | e.buildFromMongo = (members, friendships) => {
 91 |   // minimal network from members and friendships as returned by OA
 92 |   const net = new Graph()
 93 |   for (let i = 0; i < members.length; i++) {
 94 |     const member = members[i]
 95 |     net.addNode(member.key, { name: member.attributes.name })
 96 |   }
 97 |   for (let i = 0; i < friendships.length; i++) {
 98 |     const friendship = friendships[i]
 99 |     const p1 = friendship.source
100 |     const p2 = friendship.target
101 |     if (!net.hasEdge(p1, p2)) {
102 |       net.addUndirectedEdge(p1, p2)
103 |     }
104 |   }
105 |   return net
106 | }
107 |
108 | e.buildFromSparql = (members, friendships) => {
109 |   // specialized to build network from members and friendships as returned by sparql queries in losd
110 |   const net = new Graph()
111 |   for (let i = 0; i < members.length; i++) {
112 |     const member = members[i]
113 |     net.addNode(member.p.value, { name: member.n.value })
114 |   }
115 |   for (let i = 0; i < friendships.length; i++) {
116 |     const friendship = friendships[i]
117 |     const p1 = friendship.p1.value
118 |     const p2 = friendship.p2.value
119 |     if (!net.hasEdge(p1, p2)) {
120 |       net.addUndirectedEdge(p1, p2)
121 |     }
122 |   }
123 |   return net
124 | }
125 |
126 | e.plotFromMongo = (anet, app, keepUnscrapped) => {
127 |   // const net = e.buildFromMongo(anet.nodes, anet.edges)
128 |   let net = new Graph()
129 |   net.import(anet)
130 |   const removedNodes = []
131 |   if (!keepUnscrapped) {
132 |     net.forEachNode((n, a) => {
133 |       if (!a.scrapped) removedNodes.push({ n, a })
134 |     })
135 |     removedNodes.forEach(v => net.dropNode(v.n))
136 |   }
137 |   net = e.getLargestComponent(net, true)
138 |   // let removedNodes
139 |   // do {
140 |   //   netdegree.assign(net)
141 |   //   removedNodes = []
142 |   //   net.forEachNode((n, a) => {
143 |   //     if (a.degree === 0 || !a.scrapped) {
144 |   //       removedNodes.push({ n, a })
145 |   //     }
146 |   //   })
147 |   //   removedNodes.forEach(v => {
148 |   //     net.dropNode(v.n)
149 |   //   })
150 |   // } while (removedNodes.length > 0)
151 |   netdegree.assign(net)
152 |   random.assign(net)
153 |   const saneSettings = forceAtlas2.inferSettings(net)
154 |   console.log('the settings:', saneSettings)
155 |   // saneSettings.barnesHutTheta = 1.2
156 |   // saneSettings.scalingRatio = 2
157 |   const atlas = forceAtlas2(net, { iterations: parseInt(u('it')) || 150, settings: saneSettings })
158 |   scale(atlas, app)
159 |   return { net, saneSettings, atlas }
160 | }
161 |
162 | e.plotWhatsFromMongo = (data, creator, app, full) => {
163 |   function mkId (n) {
164 |     let name = n[1]
165 |     let tel
166 |     if (name) tel = n[0]
167 |     else name = n[0]
168 |     let anonCount = 0
169 |     if (/^[\d ]*$/.test(name)) name = 'Anon-' + anonCount++
170 |     else if (['you', 'você'].includes(name.toLowerCase())) name = creator || 'Anon-' + anonCount++
171 |     return { name, tel }
172 |   }
173 |   let net = new Graph()
174 |   data.forEach(([n1, n2]) => {
175 |     const m1 = mkId(n1)
176 |     const m2 = mkId(n2)
177 |     if (m1.name === m2.name) return
178 |     if (!net.hasNode(m1.name)) net.addNode(m1.name, m1)
179 |     if (!net.hasNode(m2.name)) net.addNode(m2.name, m2)
180 |     if (!net.hasUndirectedEdge(m1.name, m2.name)) net.addUndirectedEdge(m1.name, m2.name)
181 |   })
182 |   if (!full) net = e.getLargestComponent(net, true)
183 |   netdegree.assign(net)
184 |   random.assign(net)
185 |   const saneSettings = forceAtlas2.inferSettings(net)
186 |   const atlas = forceAtlas2(net, { iterations: 150, settings: saneSettings })
187 |   scale(atlas, app)
188 |   return { net, saneSettings, atlas }
189 | }
190 |
191 | e.plotFromSparql = (members, friendships) => {
192 |   const net = e.buildFromSparql(members, friendships)
193 |   netdegree.assign(net)
194 |   const removedNodes = []
195 |   net.forEachNode((n, a) => {
196 |     if (a.degree === 0) {
197 |       removedNodes.push({ n, a })
198 |     }
199 |   })
200 |   removedNodes.forEach(v => {
201 |     net.dropNode(v.n)
202 |   })
203 |   random.assign(net)
204 |   const saneSettings = forceAtlas2.inferSettings(net)
205 |   const atlas = forceAtlas2(net, { iterations: 150, settings: saneSettings })
206 |   scale(atlas)
207 |   return { net, saneSettings, atlas }
208 | }
209 |
210 | function scale (positions, app) {
211 |   app = app || wand.app
212 |   const k = Object.values(positions)
213 |   const kx = k.map(kk => kk.x)
214 |   const ky = k.map(kk => kk.y)
215 |   const maxx = Math.max(...kx)
216 |   const minx = Math.min(...kx)
217 |   const maxy = Math.max(...ky)
218 |   const miny = Math.min(...ky)
219 |
220 |   const [w_, h_] = [app.renderer.width, app.renderer.height]
221 |   const w = w_ * 0.8
222 |   const h = h_ * 0.8
223 |   const w0 = w_ * 0.1
224 |   const h0 = h_ * 0.1
225 |   Object.keys(positions).forEach(key => {
226 |     positions[key].x = w * (positions[key].x - minx) / (maxx - minx) + w0
227 |     positions[key].y = h * (positions[key].y - miny) / (maxy - miny) + h0
228 |   })
229 |   return positions
230 | }
231 |
232 | e.ParticleNet2 = class { // using graphology net and positions as given by forceatlas2
233 |   constructor (app, net, atlas, interactive = true, bezier = false) {
234 |     this.interactive = interactive
235 |     this.mkContainers(app)
236 |     this.mkTextures(app, bezier)
237 |     this.plot(net, atlas, app)
238 |     this.input = { app, net, atlas }
239 |   }
240 |
241 |   mkContainers (app) {
242 |     this.nodeContainer = new PIXI.ParticleContainer(100000, {
243 |       scale: true,
244 |       position: true,
245 |       rotation: true,
246 |       alpha: true
247 |     })
248 |     this.nodeContainer.interactiveChildren = this.interactive
249 |     this.nodeContainer.interactive = this.interactive
250 |     this.edgeContainer = new PIXI.ParticleContainer(100000, {
251 |       scale: true,
252 |       position: true,
253 |       rotation: true,
254 |       alpha: true
255 |     })
256 |     // this.edgeContainer = new PIXI.Container()
257 |     app.stage.addChild(this.edgeContainer)
258 |     app.stage.addChild(this.nodeContainer)
259 |   }
260 |
261 |   mkTextures (app, bezier) {
262 |     const myCircle = new PIXI.Graphics()
263 |       .beginFill(0xffffff)
264 |       .drawCircle(0, 0, 50)
265 |       .endFill()
266 |     this.circleTexture = app.renderer.generateTexture(myCircle)
267 |     const myLine = new PIXI.Graphics()
268 |       .lineStyle(1, 0xffffff)
269 |     if (bezier) setBezier(myLine)
270 |     else {
271 |       myLine
272 |         .moveTo(0, 0)
273 |         .lineTo(1000, 0)
274 |     }
275 |     this.lineTexture = app.renderer.generateTexture(myLine)
276 |   }
277 |
278 |   plot (net, atlas, app) {
279 |     net.forEachNode((k, a) => {
280 |       const p = atlas[k]
281 |       const circle = new PIXI.Sprite(this.circleTexture)
282 |       circle.x = p.x
283 |       circle.y = p.y
284 |       circle.anchor.x = 0.5
285 |       circle.anchor.y = 0.5
286 |       circle.tint = 0x00ffff
287 |       circle.scale.set(0.1)
288 |       circle.interactive = this.interactive
289 |       this.nodeContainer.addChild(circle)
290 |       a.pixiElement = circle
291 |       a.name = a.name || 'anonym'
292 |       if (a.name) { // todo: implement rendering of the names on the fly
293 |         const texto = new PIXI.Text(
294 |           a.name,
295 |           { fontFamily: 'Arial', fontSize: 35, fill: 0xffffff, align: 'center' }
296 |         )
297 |
298 |         texto.tint = 0xffffff
299 |         texto.x = p.x
300 |         texto.y = p.y
301 |         texto.zIndex = 1000
302 |         texto.alpha = 0
303 |         texto.interactive = this.interactive
304 |         texto.hitArea = new PIXI.Rectangle(-5, -5, 10, 10)
305 |         app.stage.addChild(texto)
306 |
307 |         a.textElement = texto
308 |         texto.on('pointerover', () => {
309 |           texto.alpha = 1
310 |         })
311 |         texto.on('pointerout', () => {
312 |           texto.alpha = 0
313 |         })
314 |       }
315 |     })
316 |     net.forEachEdge((e, a, s, t) => {
317 |       a.pixiElement = this.mkEdge(atlas[s], atlas[t]) // , 1, 0, 0xff0000, app)
318 |     })
319 |   }
320 |
321 |   mkLink (p1, p2, weight = 1, level = 0, tint = 0xff0000, app = undefined) {
322 |     const line = new PIXI.Graphics()
323 |     // fixme: how to map [1, 10] linewidth to resolution and screensize?
324 |     // this was performed in a previous implementation with this ad-hoc-found relation:
325 |     // line.lineStyle(1 + (9 * weight / this.max_weights[level_]) / (this.networks.length - level_) , 0xFFFFFF);
326 |     line.lineStyle(1, 0xffffff) // always 1 pixel width white.
327 |     // fixme: make/migrate colors/palletes to be used.  e.g. line.tint = this.colors[level_];
328 |     line.tint = tint
329 |     line.mtint = tint
330 |     line.mlevel = level
331 |     line.moveTo(p1.x, p1.y)
332 |     line.lineTo(p2.x, p2.y)
333 |     line.alpha = 0.2
334 |     line.p1 = p1
335 |     line.zIndex = 1
336 |     line.p2 = p2
337 |     app.stage.addChild(line)
338 |     return line
339 |   }
340 |
341 |   mkEdge (pos1, pos2) {
342 |     const line = new PIXI.Sprite(this.lineTexture)
343 |     const dx = pos2.x - pos1.x
344 |     const dy = pos2.y - pos1.y
345 |     const length = (dx ** 2 + dy ** 2) ** 0.5
346 |     line.scale.set(length / 1000, 1)
347 |     const angle = Math.atan2(dy, dx)
348 |     line.rotation = angle
349 |     line.x = pos1.x
350 |     line.y = pos1.y
351 |     line.tint = 0xff00ff
352 |     this.edgeContainer.addChild(line)
353 |     return line
354 |   }
355 |
356 |   hide () {
357 |     this.input.net.forEachNode((k, a) => {
358 |       a.pixiElement.alpha = 0
359 |     })
360 |     this.input.net.forEachEdge((k, a) => {
361 |       a.pixiElement.alpha = 0
362 |     })
363 |   }
364 | }
365 |
366 | e.getComponent = (net, seed, size) => {
367 |   const nodes = [seed]
368 |   let possibleNodes = net.neighbors(seed)
369 |   while (nodes.length < size && possibleNodes.length > 0) {
370 |     const newNode = chooseUnique(possibleNodes, 1)[0]
371 |     nodes.push(newNode)
372 |     possibleNodes.push(...net.neighbors(newNode))
373 |     possibleNodes = possibleNodes.filter(n => !nodes.includes(n))
374 |   }
375 |   const sg = subGraph(net, nodes).copy()
376 |   e.assignDistances(sg, seed)
377 |   return sg
378 | }
379 |
380 | e.getSubGraph = (net, nodes) => {
381 |   return subGraph(net, nodes).copy()
382 | }
383 |
384 | e.assignDistances = (g, seed) => {
385 |   // has to be connected
386 |   g.setNodeAttribute(seed, 'ndist', 0)
387 |   const nodes = [seed]
388 |   let border = [seed]
389 |   let border_
390 |   let distance = 1
391 |   while (nodes.length !== g.order) {
392 |     border_ = []
393 |     border.forEach(bn => {
394 |       g.forEachNeighbor(bn, (n, a) => {
395 |         if (!nodes.includes(n)) {
396 |           a.ndist = distance
397 |           nodes.push(n)
398 |           border_.push(n)
399 |         }
400 |       })
401 |     })
402 |     distance++
403 |     border = border_.slice()
404 |   }
405 |   g.ndist = netmetrics.extent(g, 'ndist')
406 |   g.h_ = 0.8 / distance--
407 |   g.forEachNode((n, a) => {
408 |     if (a.ndist === distance) g.target = a
409 |     a.ndist_ = a.ndist / g.ndist[1]
410 |     a.ndist__ = a.ndist_ * (0.8 - g.h_) + 0.1
411 |   })
412 |   g.ndist_ = netmetrics.extent(g, 'ndist_')
413 |   g.ndist__ = netmetrics.extent(g, 'ndist__')
414 |   // g.vals_ = vals.sort().map(i => 0.9 * i / g.ndist[1])
415 |   // g.forEachNode((n, a) => {
416 |   //   a.index = g.vals_.findIndex(i => i > a.ndist_)
417 |   // })
418 | }
419 |
420 | e.mkCommunities = g => {
421 |   // const gg = components.connectedComponents(g)
422 |   // let gg_ = []
423 |   // for (let i = 0; i < gg.length; i++) {
424 |   //   if (gg[i].length > gg_.length) {
425 |   //     gg_ = gg[i]
426 |   //   }
427 |   // }
428 |   // const sg = subGraph(g, gg_).copy()
429 |   const sg = g
430 |   netdegree.assign(sg)
431 |   netmetrics.centrality.degree.assign(sg)
432 |   sg.communities = louvain.detailed(sg)
433 |   const communitySizes = new Array(sg.communities.count).fill(0)
434 |   for (const key in sg.communities.communities) {
435 |     const index = sg.communities.communities[key]
436 |     sg.setNodeAttribute(key, 'community', index)
437 |     communitySizes[index]++
438 |   }
439 |   sg.communities.sizes = {
440 |     all: communitySizes,
441 |     max: Math.max(...communitySizes),
442 |     min: Math.min(...communitySizes)
443 |   }
444 |   return sg
445 | }
446 |
447 | e.getLargestComponent = (g, returnNet) => {
448 |   const gg = components.connectedComponents(g)
449 |   let gg_ = []
450 |   for (let i = 0; i < gg.length; i++) {
451 |     if (gg[i].length > gg_.length) {
452 |       gg_ = gg[i]
453 |     }
454 |   }
455 |   return returnNet ? subGraph(g, gg_).copy() : gg_
456 | }
457 |
458 | e.removeNode = (g, n) => {
459 |   g.getNodeAttribute(n, 'pixiElement').destroy()
460 |   g.forEachEdge(n, (e, ea) => {
461 |     ea.pixiElement.destroy()
462 |   })
463 |   g.dropNode(n)
464 | }
465 |
466 | e.plotSync = (data, app, toDraw = true) => {
467 |   const key = data.source === 'fb' ? 'id' : 'name'
468 |   const net = new Graph()
469 |   data.nodes.forEach(n => net.addNode(n[key], n))
470 |   data.links.forEach(step => {
471 |     step.forEach(link => {
472 |       net.addEdge(link.from, link.to)
473 |     })
474 |   })
475 |   if (!toDraw) return net
476 |   netdegree.assign(net)
477 |   random.assign(net)
478 |   const saneSettings = forceAtlas2.inferSettings(net)
479 |   console.log('bef fa')
480 |   const atlas = forceAtlas2(net, { iterations: 150, settings: saneSettings })
481 |   console.log('aft fa')
482 |   scale(atlas, app)
483 |   return { net, saneSettings, atlas }
484 | }
485 |
486 | e.attrNet = (net, app) => { // to be used with e.plotSync(data, --, false)
487 |   netdegree.assign(net)
488 |   random.assign(net)
489 |   const saneSettings = forceAtlas2.inferSettings(net)
490 |   const atlas = forceAtlas2(net, { iterations: 150, settings: saneSettings })
491 |   scale(atlas, app)
492 |   return { net, saneSettings, atlas }
493 | }
494 |
495 | function setBezier (bezier, xd = 1000, yd = 0, dx1 = 0.25, dy1 = 30, dx2 = 0.75, dy2 = 30) {
496 |   bezier.position.x = 0
497 |   bezier.position.y = 0
498 |   const localDest = { x: xd, y: yd }
499 |   const cp1 = { x: localDest.x * dx1, y: dy1 }
500 |   const cp2 = { x: localDest.x * dx2, y: dy2 }
501 |   bezier.bezierCurveTo(cp1.x, cp1.y, cp2.x, cp2.y, localDest.x, localDest.y)
502 | }
503 |
504 | e.assignCC = net => net.forEachNode((n, a) => {
505 |   if (a.degree < 2) a.cc = 0
506 |   else {
507 |     const sg = e.subGraph(net, [...net.neighbors(n), n])
508 |     a.cc = 2 * (sg.size - a.degree) / (a.degree * (a.degree - 1))
509 |   }
510 | })
511 |


--------------------------------------------------------------------------------
/scripts/modules/router.js:
--------------------------------------------------------------------------------
  1 | /* global wand */
  2 | const utils = require('./utils.js')
  3 |
  4 | const e = module.exports
  5 |
  6 | const pn = decodeURIComponent(window.location.href)
  7 | const u = new URL(pn)
  8 |
  9 | const urlArgument = e.urlArgument = (arg, rotOrFun) => {
 10 |   const a = u.searchParams.get(arg)
 11 |   if (typeof rotOrFun === 'function' && a) {
 12 |     rotOrFun()
 13 |   } else {
 14 |     // return rotOrFun ? wand.utils.rot(a) : a
 15 |     return rotOrFun ? wand.utils.rot(a) : a
 16 |   }
 17 | }
 18 |
 19 | e.urlAllArguments = () => {
 20 |   const urlParams = new URLSearchParams(window.location.search)
 21 |   const entries = urlParams.entries()
 22 |   const keys = []
 23 |   const values = []
 24 |   const dict = {}
 25 |   for (const entry of entries) {
 26 |     keys.push(entry[0])
 27 |     values.push(entry[1])
 28 |     dict[entry[0]] = entry[1]
 29 |   }
 30 |   return { keys, values, dict }
 31 | }
 32 |
 33 | e.mkFooter = () => {
 34 |   const $ = wand.$
 35 |   $('<link/>', {
 36 |     rel: 'stylesheet',
 37 |     href: 'https://code.jquery.com/ui/1.13.3/themes/smoothness/jquery-ui.css'
 38 |   }).appendTo('head')
 39 |
 40 |   wand.$.get('https://ipinfo.io/?token=a1cf42d7d11976', function (response) {
 41 |     wand.country = response.country
 42 |     wand.speaksPortuguese = ['BR', 'PT', 'AO', 'ST'].includes(wand.country)
 43 |     if (window.location.href.includes('localhost')) return
 44 |     response.date = new Date()
 45 |     response.uargs = e.urlAllArguments()
 46 |     wand.transfer.fAll.wcosta(response).then(r => {
 47 |       window.sessionL = r
 48 |       wand.unloadFuncs.unshift(e => {
 49 |         wand.transfer.fAll.ucosta({ _id: r.insertedId }, { dateLeft: new Date() })
 50 |       })
 51 |       setInterval(() => {
 52 |         wand.transfer.fAll.ucosta({ _id: r.insertedId }, { lastSeen: new Date() })
 53 |       }, 3 * 60 * 1000)
 54 |     })
 55 |   }, 'jsonp')
 56 |   wand.$('body').on('DOMNodeInserted', 'div', function () {
 57 |     if (wand.$(this).hasClass('skiptranslate')) wand.$(this).hide()
 58 |   })
 59 |   wand.modal = utils.mkModal()
 60 |   const isMobile = utils.mobileAndTabletCheck()
 61 |   function sWord () {
 62 |     const wlist = ['support', 'back', 'encourage', 'strengthen', 'assist', 'boost']
 63 |     return utils.chooseUnique(wlist, 1)
 64 |   }
 65 |   const ft = wand.$('<div/>', {
 66 |     id: 'afooter',
 67 |     css: {
 68 |       display: 'flex',
 69 |       'white-space': 'nowrap',
 70 |       'overflow-x': 'auto',
 71 |       margin: '0 auto',
 72 |       padding: '8px',
 73 |       'text-align': 'center',
 74 |       width: 'auto'
 75 |     }
 76 |   }).appendTo('body')
 77 |   const lflag = urlArgument('lang') ? `&lang=${urlArgument('lang')}` : ''
 78 |   wand.$('<a/>', {
 79 |     href: `?about${lflag}`,
 80 |     id: 'abouta',
 81 |     css: {
 82 |       // 'margin-left': '1%',
 83 |       margin: 'auto',
 84 |       display: 'inline-block',
 85 |       'font-size': isMobile ? '3vw' : '1vw',
 86 |       float: 'left'
 87 |     }
 88 |   }).html(`<b>Regarding <span class="notranslate">${window.location.hostname === 'aeterni.github.io' ? 'Æterni' : 'AV Medicine'}</span></b>`).appendTo(ft)
 89 |   // wand.$('<div/>', { css: { display: 'inline-block', 'margin-left': '1%', float: 'left' } }).appendTo(ft).html(' | ')
 90 |   wand.$('<a/>', {
 91 |     href: '/',
 92 |     css: {
 93 |       // 'margin-left': '1%',
 94 |       margin: 'auto',
 95 |       display: 'inline-block',
 96 |       'font-size': isMobile ? '3vw' : '1vw',
 97 |       float: 'center'
 98 |     }
 99 |   }).html('<b>Home</b>').appendTo(ft)
100 |   wand.$('<a/>', {
101 |     // href: `?angel${lflag}`,
102 |     // target: '_blank',
103 |     href: '',
104 |     id: 'contribL',
105 |     css: {
106 |       // 'margin-left': '1%',
107 |       margin: 'auto',
108 |       display: 'inline-block',
109 |       'font-size': isMobile ? '3vw' : '1vw',
110 |       float: 'left'
111 |     }
112 |   }).html(`<b>${sWord()} this initiative</b>`).appendTo(ft).click(() => {
113 |     wand.modal.show()
114 |     return false
115 |   })
116 |   wand.$('body', {
117 |     css: {
118 |       'background-color': '#dddddd'
119 |     }
120 |   })
121 |   // wand.$('<div/>', {
122 |   //   id: 'disqus_thread',
123 |   //   css: {
124 |   //     margin: '0 auto',
125 |   //     padding: '1%',
126 |   //     width: '50%'
127 |   //   }
128 |   // }).appendTo('body')
129 |   if (window.location.hostname === 'aeterni.github.io') {
130 |     if (!urlArgument('nolang')) lang(ft)
131 |   }
132 |   // uncomment to enable disqus
133 |   // todo: debug to load correct discussions in each page
134 |   // const uargs = e.urlAllArguments()
135 |   // if (uargs.keys[0] && uargs.keys[0][0] === '_') disqus(uargs.keys[0][0].slice(1))
136 |   if (!wand.showLoginDiv) return
137 |   const ldiv = $('<div/>', { css: { width: '50%', margin: 'auto', padding: '1%' } }).prependTo('body')
138 |   if (window.localStorage.getItem('logged')) {
139 |     wand.user = JSON.parse(window.localStorage.getItem('user'))
140 |     wand.userFuncs.forEach(f => f())
141 |     $('<span/>', { css: { 'margin-right': '1%' } })
142 |       .text(`logged in as: ${wand.user.name}`)
143 |       .appendTo(ldiv)
144 |     $('<button/>')
145 |       .text('logout')
146 |       .appendTo(ldiv)
147 |       .click(() => {
148 |         window.localStorage.removeItem('logged')
149 |         window.localStorage.removeItem('user')
150 |         window.location.reload()
151 |       })
152 |     if (!wand.user.profileForm) {
153 |       $('<a/>', { id: 'pfLink', href: '?profiloForm2', target: '_blank', css: { float: 'right' } })
154 |         .text('Compilare il form del profilo')
155 |         .appendTo(ldiv)
156 |         .click(() => {
157 |           window.registerModal.show()
158 |         })
159 |     }
160 |   } else {
161 |     const loginForm = $('<form/>', { onsubmit: 'event.preventDefault()' }).appendTo(ldiv)
162 |     const email = $('<input/>', { type: 'text', id: 'uemail', placeholder: 'email', css: { 'margin-right': '1%' } })
163 |       .appendTo(loginForm)
164 |     const pw = $('<input/>', { type: 'password', id: 'upwd', placeholder: 'password', css: { 'margin-right': '1%' } })
165 |       .appendTo(loginForm)
166 |     $('<button/>', { css: { 'margin-right': '1%' } })
167 |       .text('login')
168 |       .appendTo(loginForm)
169 |       .click(() => {
170 |         $('#loading').show()
171 |         wand.transfer.fAll.omark({ email: email.val() }).then(r => {
172 |           if (r && wand.bcrypt.compareSync(pw.val(), r.pw)) {
173 |             delete r.pw
174 |             window.localStorage.setItem('logged', true)
175 |             window.localStorage.setItem('user', JSON.stringify(r))
176 |             window.location.reload()
177 |           } else {
178 |             window.alert('email and password were not matched in database')
179 |           }
180 |           $('#loading').hide()
181 |         })
182 |       })
183 |     utils.mkRegisterModal_()
184 |     $('<button/>', { css: { float: 'right' } })
185 |       .text('register')
186 |       .appendTo(loginForm)
187 |       .click(() => {
188 |         window.registerModal.show()
189 |       })
190 |   }
191 | }
192 |
193 | window.disqus_config = function () {
194 |   // this.page.url = `${window.location.origin}?_${id}`
195 |   const url = window.location.href
196 |   this.page.url = url
197 |   // this.page.identifier = id
198 |   this.page.identifier = url.includes('?') ? url.split('?')[1] : '/'
199 | }
200 |
201 | function disqus (id) {
202 |   wand.$('<noscript/>').html('Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>')
203 |   const d = document
204 |   const s = d.createElement('script')
205 |   s.src = 'https://aeterni.disqus.com/embed.js'
206 |   s.setAttribute('data-timestamp', +new Date())
207 |   const asec = (d.head || d.body)
208 |   asec.appendChild(s)
209 | }
210 | window.disqus = disqus
211 |
212 | function lang (ft2) {
213 |   // const ft = wand.$('<div/>', { id: 'afooter', css: { width: '100%', display: 'flex', 'white-space': 'nowrap', 'overflow-x': 'auto' } }).appendTo('body')
214 |   // wand.$('<div/>', { class: 'notranslate', css: { display: 'inline-block', 'margin-left': '30%', float: 'left' } }).appendTo(ft).html('language:')
215 |   // wand.$('<div/>', { id: 'google_translate_element', class: 'notranslate', css: { display: 'inline-block', 'margin-left': '1%', float: 'left' } }).appendTo('body').hide()
216 |
217 |   // wand.$('<div/>', { css: { display: 'inline-block', 'margin-left': '1%', float: 'left' } }).appendTo('#abouta').html(' / lang: ')
218 |   // const ft = wand.$('<div/>', {
219 |   //   id: 'afooter2',
220 |   //   css: {
221 |   //     display: 'flex',
222 |   //     // 'white-space': 'nowrap',
223 |   //     // 'overflow-x': 'auto',
224 |   //     // margin: '0 auto',
225 |   //     // padding: '8px',
226 |   //     // height: '100%',
227 |   //     width: '100%'
228 |   //   }
229 |   // }).appendTo(ft2).hide()
230 |   // const ft = ft2
231 |   wand.$('<div/>', { id: 'google_translate_element' }).appendTo('body') // .hide()
232 |   wand.$('<script/>', {
233 |     type: 'text/javascript',
234 |     src: '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit'
235 |   }).appendTo('body')
236 |   // const adiv = wand.$('<div/>', { class: 'flag' }).appendTo(ft)
237 |   wand.$('<div/>', {
238 |     class: 'flag_link eng',
239 |     'data-lang': 'en',
240 |     title: 'English',
241 |     id: 'menusa',
242 |     css: {
243 |     //   flex: '33.3%'
244 |       cursor: 'pointer'
245 |     }
246 |   }).insertAfter('#abouta') // appendTo(ft)
247 |     .append(wand.$('<img/>', {
248 |       // src: 'assets/flags/uk.png',
249 |       class: 'fimg',
250 |       src: 'assets/flags/uk2.svg',
251 |       css: {
252 |         // display: 'inline',
253 |         // width: '50%',
254 |         // flex: '33.3%',
255 |         // margin: '0 100%',
256 |         // height: '100%'
257 |         height: ft2.height()
258 |       }
259 |     }))
260 |   wand.$('<div/>', {
261 |     class: 'flag_link por',
262 |     'data-lang': 'pt',
263 |     title: 'Português',
264 |     id: 'mptbr',
265 |     css: {
266 |       // flex: '33.3%'
267 |       cursor: 'pointer'
268 |     }
269 |   }).insertAfter('#abouta') // appendTo(ft)
270 |     .append(wand.$('<img/>', {
271 |       // src: 'assets/flags/br.png',
272 |       class: 'fimg',
273 |       src: 'assets/flags/br2.svg',
274 |       css: {
275 |         // display: 'inline',
276 |         // width: '50%',
277 |         // margin: '0 100%',
278 |         // height: '100%'
279 |         height: ft2.height()
280 |       }
281 |     }))
282 |   const afun = e => {
283 |     Array.prototype.forEach.call(iels, e => { e.style.border = '' })
284 |     window.eee = e
285 |     e.firstChild.style.border = '2px solid #ff0000'
286 |     const lang = e.getAttribute('data-lang')
287 |     const languageSelect = document.querySelector('select.goog-te-combo')
288 |     languageSelect.value = lang
289 |     languageSelect.dispatchEvent(new window.Event('change'))
290 |   }
291 |   const iels = document.getElementsByClassName('fimg')
292 |   const els = document.getElementsByClassName('flag_link')
293 |   window.elss = els
294 |   Array.prototype.forEach.call(els, function (e) {
295 |     e.addEventListener('click', function () {
296 |       afun(e)
297 |       const content = wand.$('#contribL').text()
298 |       let count = 0
299 |       const iid = setInterval(() => {
300 |         if (count > 2 || wand.$('#contribL').text() !== content) return clearInterval(iid)
301 |         afun(e)
302 |         count++
303 |       }, 500)
304 |       // afun(e)
305 |     })
306 |   })
307 | }
308 |
309 | e.lang = lang
310 |
311 | e.timeArgument = () => {
312 |   const dd = new Date()
313 |   const d_ = e.urlArgument('s')
314 |   if (d_) {
315 |     const d = d_.split(':')
316 |     dd.setHours(d[0])
317 |     dd.setMinutes(d.length > 1 ? d[1] : 0)
318 |     dd.setSeconds(d.length > 2 ? d[2] : 0)
319 |   } else {
320 |     dd.setMinutes(dd.getMinutes() + 1)
321 |     dd.setSeconds(0)
322 |   }
323 |   dd.setMilliseconds(0)
324 |   return dd
325 | }
326 |


--------------------------------------------------------------------------------
/scripts/modules/transfer.js:
--------------------------------------------------------------------------------
  1 | // mongo:
  2 | const s = require('mongodb-stitch-browser-sdk')
  3 | const e = module.exports
  4 | e.ss = s
  5 |
  6 | const creds = {}
  7 | const regName = (name, app, url, db, coll) => {
  8 |   creds[name] = {
  9 |     cluster: 'mongodb-atlas', // always
 10 |     app,
 11 |     url,
 12 |     db: db || 'anydb',
 13 |     collections: { test: coll || 'anycollection' }
 14 |   }
 15 | }
 16 |
 17 | regName('ttm', 'freene-gui-fzgxa', 'https://ttm.github.io/oa/', 'freenet-all', 'test3') // renato.fabbri@, also cols: test, test2, nets
 18 | // regName('ttm', 'freene-gui-fzgxa', 'https://ttm.github.io/oa/', 'freenet-all', 'nets') // dummy
 19 | regName('tokisona', 'aplicationcreated-mkwpm', 'https://tokisona.github.io/oa/', 'adbcreated', 'acolectioncreated') // sync.aquarium@ and aeterni, also col aatest
 20 | regName('f4b', 'application-0-bcham', '', 'fdb', 'fcol') // f466r1@
 21 | regName('costa', 'application-0-izpfj', '', 'adbb', 'acoll') // rcostafabbri@
 22 | regName('aeterni', 'application-0-knxbk', '', 'adb', 'acol') // aeterni.anima@
 23 | regName('mark', 'anyapplication-faajz', 'https://markturian.github.io/ouraquarium/', 'anydb', 'anycollection') // markarcturian@
 24 | // regName('sync', 'anyapplication-faajz', 'https://worldhealing.github.io/ouraquarium/', 'anydb', 'anycollection') // markarcturian@
 25 |
 26 | const auth = creds.tokisona
 27 | // const auth = creds.mark
 28 | // const auth = creds.ttm
 29 | // const auth = creds.sync
 30 |
 31 | // auth.url = 'http://localhost:8080/'
 32 |
 33 | const client = s.Stitch.initializeDefaultAppClient(auth.app)
 34 | const db = client.getServiceClient(s.RemoteMongoClient.factory, auth.cluster).db(auth.db)
 35 |
 36 | e.writeAny = (data, aa) => {
 37 |   return client.auth.loginWithCredential(new s.AnonymousCredential()).then(user => {
 38 |     return db.collection(aa ? 'aatest' : auth.collections.test).insertOne(data)
 39 |   })
 40 | }
 41 |
 42 | e.findAny = (data, aa) => {
 43 |   return client.auth.loginWithCredential(new s.AnonymousCredential()).then(user => {
 44 |     return db.collection(aa ? 'aatest' : auth.collections.test).findOne(data)
 45 |   })
 46 | }
 47 |
 48 | e.findAll = (query, aa, projection, col) => {
 49 |   return client.auth.loginWithCredential(new s.AnonymousCredential()).then(user => {
 50 |     return db.collection(aa ? 'aatest' : (col || auth.collections.test)).find(query, { projection }).asArray()
 51 |   })
 52 | }
 53 |
 54 | e.remove = (query, aa) => {
 55 |   return client.auth.loginWithCredential(new s.AnonymousCredential()).then(user => {
 56 |     return db.collection(aa ? 'aatest' : auth.collections.test).deleteMany(query)
 57 |   })
 58 | }
 59 |
 60 | // sparql:
 61 | const losdheaders = require('./losdheaders.js')
 62 | const superagent = require('superagent')
 63 |
 64 | e.getNetMembersLinks = (netid, call = console.log) => {
 65 |   const qmembers = `SELECT DISTINCT ?p ?n WHERE {
 66 |     ?s po:snapshotID '${netid}' .
 67 |     ?p a po:Participant .
 68 |     ?p po:snapshot ?s .
 69 |     ?p po:observation ?o .
 70 |     ?o po:name ?n .
 71 |   }`
 72 |   const qfriendships = `SELECT DISTINCT ?p1 ?p2 WHERE {
 73 |     ?f a po:Friendship .
 74 |     ?f po:snapshot ?s .
 75 |     ?s po:snapshotID '${netid}' .
 76 |     ?f po:member ?p1, ?p2 .
 77 |     FILTER(?p1 != ?p2)
 78 |   }`
 79 |   e.losdCall(qmembers, (members) => {
 80 |     e.losdCall(qfriendships, (friendships) => {
 81 |       call({ members, friendships })
 82 |     })
 83 |   })
 84 | }
 85 |
 86 | const dummyQueries = {
 87 |   0: [
 88 |     'SELECT ?s ?n WHERE {',
 89 |     '?s a po:Snapshot .',
 90 |     '?s po:name ?n .',
 91 |     '}'
 92 |   ].join(' '),
 93 |   1: `PREFIX : <https://rfabbri.linked.data.world/d/linked-open-social-data/>
 94 |       PREFIX po: <http://purl.org/socialparticipation/po/>
 95 |       SELECT (COUNT(DISTINCT ?author) as ?c) WHERE {
 96 |         ?author a po:Participant .
 97 |     }`
 98 | }
 99 |
100 | e.losdCall = (query, callback) => {
101 |   if (typeof query === 'object') {
102 |     query = query.join(' ')
103 |   }
104 |   if (Object.keys(dummyQueries).includes(String(query))) {
105 |     query = dummyQueries[query]
106 |   }
107 |   const query_ = [
108 |     'PREFIX : <https://rfabbri.linked.data.world/d/linked-open-social-data/>',
109 |     'PREFIX po: <http://purl.org/socialparticipation/po/>',
110 |     query
111 |   ]
112 |   sparqlCall(
113 |     'https://api.data.world/v0/sparql/rfabbri/linked-open-social-data',
114 |     query_.join(' '),
115 |     callback,
116 |     losdheaders.losdheaders
117 |   )
118 | }
119 |
120 | const sparqlCall = (url, query, callback, headers) => {
121 |   if (typeof query !== 'string') {
122 |     query = query.join(' ')
123 |   }
124 |   superagent
125 |     .get(url)
126 |     .query({ query, format: 'json' })
127 |     .set(headers)
128 |     .then(result => {
129 |       const mres__ = JSON.parse(result.text)
130 |       const sparqlres = mres__.results.bindings
131 |       callback(sparqlres)
132 |     })
133 | }
134 |
135 | // ////////////// generic:
136 | class FindAll {
137 |   constructor () {
138 |     this.dbs = {}
139 |     this.clients = {}
140 |     this.auths = {}
141 |     this.tests = {}
142 |     for (const au in creds) {
143 |       if (au === 'tokisona') continue
144 |       this.mkOne(au)
145 |     }
146 |     this.tokisona = (query, projection, col) => e.findAll(query, false, projection, col)
147 |   }
148 |
149 |   mkOne (au) {
150 |     const auth = creds[au]
151 |     const client = s.Stitch.initializeAppClient(auth.app)
152 |     const db = client.getServiceClient(s.RemoteMongoClient.factory, auth.cluster).db(auth.db)
153 |     const find = (query, projection, col) => client.auth.loginWithCredential(new s.AnonymousCredential()).then(user => {
154 |       return db.collection(col || auth.collections.test).find(query, { projection }).asArray()
155 |     })
156 |     const findo = (query, projection, col) => client.auth.loginWithCredential(new s.AnonymousCredential()).then(user => {
157 |       return db.collection(col || auth.collections.test).findOne(query, { projection })
158 |     })
159 |     const write = (query, col) => client.auth.loginWithCredential(new s.AnonymousCredential()).then(user => {
160 |       return db.collection(col || auth.collections.test).insertOne(query)
161 |     })
162 |     const remove = (query, col) => {
163 |       return client.auth.loginWithCredential(new s.AnonymousCredential()).then(user => {
164 |         return db.collection(col || auth.collections.test).deleteMany(query)
165 |       })
166 |     }
167 |     const update = (query, set, col) => {
168 |       return client.auth.loginWithCredential(new s.AnonymousCredential()).then(user => {
169 |         return db.collection(col || auth.collections.test).updateOne(query, { $set: set })
170 |       })
171 |     }
172 |     const test = (query, projection, col) => client.auth.loginWithCredential(new s.AnonymousCredential()).then(user => {
173 |       return db.collection(col || auth.collections.test)
174 |     })
175 |
176 |     this.tests[au] = test
177 |     this[au] = find
178 |     this['o' + au] = findo
179 |     this['w' + au] = write
180 |     this['d' + au] = remove
181 |     this['u' + au] = update
182 |     this.dbs[au] = db
183 |     this.clients[au] = client
184 |     this.auths[au] = auth
185 |   }
186 | }
187 |
188 | e.fAll = new FindAll()
189 | // fAll.ttm({ sid: { $exists: true } }, { sid: 1 }, 'test').then(r => console.log(r.map(i => i.sid)))
190 |


--------------------------------------------------------------------------------
/you/imgs/person128.ico:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/you/imgs/person128.ico


--------------------------------------------------------------------------------
/you/imgs/person16.png:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/you/imgs/person16.png


--------------------------------------------------------------------------------
/you/imgs/person32.ico:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/you/imgs/person32.ico


--------------------------------------------------------------------------------
/you/imgs/person48.ico:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/you/imgs/person48.ico


--------------------------------------------------------------------------------
/you/imgs2/person128.ico:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/you/imgs2/person128.ico


--------------------------------------------------------------------------------
/you/imgs2/person16.ico:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/you/imgs2/person16.ico


--------------------------------------------------------------------------------
/you/imgs2/person32.ico:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/you/imgs2/person32.ico


--------------------------------------------------------------------------------
/you/imgs2/person48.ico:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/audiovisualmedicine/audiovisualmedicine.github.io/6b5496540c0fb358e7f946261a76b5bc6a3a9724/you/imgs2/person48.ico


--------------------------------------------------------------------------------
/you/manifest.json:
--------------------------------------------------------------------------------
 1 | {
 2 |   "manifest_version": 3,
 3 |   "name": "Yours",
 4 |   "version": "2.0",
 5 |   "description": "Accessing your social self",
 6 |   "permissions": [
 7 |     "scripting",
 8 |     "activeTab",
 9 |     "storage",
10 |     "unlimitedStorage",
11 |     "tabs",
12 |     "notifications"
13 |   ],
14 |   "icons": {
15 |     "16": "imgs2/person16.ico",
16 |     "32": "imgs2/person32.ico",
17 |     "48": "imgs2/person48.ico",
18 |     "128": "imgs2/person128.ico"
19 |   },
20 |   "action": {
21 |     "default_popup": "pop.html",
22 |     "default_icon": "imgs2/person16.ico"
23 |   },
24 |   "background": {
25 |     "service_worker": "scripts/ok/background.js"
26 |   },
27 |   "host_permissions": [
28 |     "http://*/*",
29 |     "https://*/*"
30 |   ]
31 | }
32 |


--------------------------------------------------------------------------------
/you/pop.html:
--------------------------------------------------------------------------------
1 | <!DOCTYPE html>
2 | <html>
3 |   <body style="width:600px;text-align:center">
4 |     <h1>~ Your social self ~</h1>
5 |     <script src="scripts/ok/pop.js"></script>
6 |   </body>
7 | </html>
8 |


--------------------------------------------------------------------------------
/you/scripts/background.js:
--------------------------------------------------------------------------------
 1 | /* global chrome */
 2 | console.log('background service worker initiated')
 3 | const fnet = chrome.fnet = require('./fnetwork.js')
 4 |
 5 | let currentTabId
 6 | let currentStep
 7 | // let visitCount
 8 |
 9 | chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
10 |   console.log('received message on background!', { request, sender, sendResponse })
11 |   if (!request.background) return
12 |   const { command } = request
13 |   if (command === 'login') {
14 |     chrome.storage.sync.set({ lastScrapped: new Date().toJSON() }, () => {
15 |       chrome.windows.create({ url: 'https://www.facebook.com/profile.php' }).then(r => {
16 |         currentTabId = r.tabs[0].id
17 |         currentStep = command
18 |       })
19 |     })
20 |   } else if (command === 'scrappeFriends') {
21 |     chrome.storage.sync.get(['userData'], ({ userData }) => {
22 |       const { sid, nid } = userData
23 |       let url
24 |       if (sid) {
25 |         url = `https://www.facebook.com/${sid}/friends`
26 |       } else {
27 |         url = `https://www.facebook.com/profile.php?id=${nid}&sk=friends`
28 |       }
29 |       chrome.tabs.create({ url }).then(r => {
30 |         currentTabId = r.id
31 |         currentStep = command
32 |       })
33 |     })
34 |   } else if (command === 'scrappeFriendships') {
35 |     const url = fnet.getNextURL()
36 |     console.log({ url })
37 |     chrome.tabs.create({ url }).then(r => {
38 |       currentTabId = r.id
39 |       currentStep = command
40 |     })
41 |     // visitCount = 1
42 |   } else if (command === 'seeNetwork') {
43 |     // write net to database (send to content or popup to do so)
44 |     // then open tab with url
45 |     chrome.runtime.sendMessage({
46 |       command: 'writeNet',
47 |       net: fnet.graph.toJSON(),
48 |       popup: true
49 |     })
50 |   } else if (command === 'absorb') {
51 |     const { structs } = request
52 |     console.log('absorb', { structs })
53 |     fnet.absorb(structs)
54 |     chrome.storage.sync.set({
55 |       nfriends: fnet.graph.order,
56 |       nfriendships: fnet.graph.size,
57 |       nscrapped: fnet.nScrapped()
58 |     }, () => {
59 |       console.log('friends(ships) absorbed in network, and their number written to storage:', { structs })
60 |       // if (fnet.graph.size) { // was getting friendship
61 |       //   if (visitCount === 10) {
62 |       //     visitCount = undefined
63 |       //   } else {
64 |       //     const url = fnet.getNextURL()
65 |       //     chrome.tabs.create({ url }).then(r => {
66 |       //       currentTabId = r.id
67 |       //       currentStep = command
68 |       //     })
69 |       //     visitCount++
70 |       //   }
71 |       // }
72 |     })
73 |   }
74 | })
75 |
76 | chrome.tabs.onUpdated.addListener((tabId, changeInfo) => {
77 |   if (tabId !== currentTabId || changeInfo.status !== 'complete') return
78 |   chrome.scripting.executeScript({
79 |     target: { tabId },
80 |     files: ['scripts/ok/content.js']
81 |   }, () => {
82 |     chrome.tabs.sendMessage(tabId, { command: currentStep, content: true })
83 |   })
84 | })
85 |


--------------------------------------------------------------------------------
/you/scripts/content.js:
--------------------------------------------------------------------------------
  1 | /* global chrome */
  2 | console.log('content script initiated', window.performance.now(), window.location.href)
  3 |
  4 | function getElementsByXPath (xpath, element) {
  5 |   const results = []
  6 |   const query = document.evaluate(xpath, element || document,
  7 |     null, window.XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null)
  8 |   for (let i = 0, length = query.snapshotLength; i < length; ++i) {
  9 |     results.push(query.snapshotItem(i))
 10 |   }
 11 |   return results
 12 | }
 13 |
 14 | function monload (work) {
 15 |   if (document.readyState !== 'complete') {
 16 |     window.addEventListener('load', (event) => {
 17 |       work()
 18 |     })
 19 |   } else {
 20 |     work()
 21 |   }
 22 | }
 23 | const scrollDelayInMilliSeconds = 300
 24 | const scrollMagnitude = 1000
 25 | const scrollTillEnd = (call, isFriends = false) => {
 26 |   const curUrl = document.location.href
 27 |   let criterion
 28 |   if (curUrl.match(/\?uid=(\d+)/)) { // special numeric mutual friends page:
 29 |     if (document.getElementsByClassName('UIStandardFrame_Container').length === 0) {
 30 |       return chrome.runtime.sendMessage({ step: 'blocked', background: true })
 31 |     }
 32 |     criterion = () => document.getElementsByClassName('morePager').length === 0
 33 |   } else {
 34 |     // criterion = () => getElementsByXPath('//*/div[1]/div[1]/div[1]/div[1]/div[1]/div[3]/div/div[@role="progressbar"]').length === 0
 35 |     criterion = () => getElementsByXPath('/html/body/div[1]/div/div[1]/div/div[3]/div/div/div[1]/div[1]/div/div/div[4]/div/div/div/div[2]/div/div/div/div').length > 0
 36 |   }
 37 |
 38 |   monload(() => {
 39 |     const time = setInterval(() => {
 40 |       document.documentElement.scrollTop += scrollMagnitude
 41 |       if (criterion()) {
 42 |         clearInterval(time)
 43 |         call()
 44 |       }
 45 |     }, scrollDelayInMilliSeconds)
 46 |   })
 47 | }
 48 |
 49 | function loginFB () {
 50 |   const curUrl = document.location.href
 51 |   let nid = curUrl.match(/\?uid=(\d+)/) || curUrl.match(/\/profile.php\?id=(\d+)/)
 52 |   let sid
 53 |   if (nid) {
 54 |     nid = nid[1]
 55 |   } else {
 56 |     sid = curUrl.match(/facebook.com\/(.*)\b/)[1]
 57 |   }
 58 |   const id = nid || sid
 59 |   let h1el
 60 |   const interval = setInterval(() => {
 61 |     const h1elements = getElementsByXPath('//*/h1')
 62 |     if (h1elements.length === 0) {
 63 |       h1el = getElementsByXPath('//*/h2/div')[0]
 64 |     } else {
 65 |       h1el = h1elements.length > 1 ? h1elements[1] : h1elements[0]
 66 |     }
 67 |     if (h1el) {
 68 |       clearInterval(interval)
 69 |       advance()
 70 |     }
 71 |   }, 200)
 72 |   function advance () {
 73 |     const membername = h1el.innerText
 74 |     const parts = membername.match(/[^\r\n]+/g)
 75 |     const name = parts[0]
 76 |     let codename // abbiamo perso codename, guardi: https://www.facebook.com/renato.fabbri.125
 77 |     if (parts.length > 1) {
 78 |       codename = parts[1]
 79 |     }
 80 |     const userData = { name, codename, sid, nid, id, newfb: true }
 81 |     chrome.storage.sync.set({ userData }, () => {
 82 |       console.log('userData set', { userData })
 83 |       window.alert('login succeded.')
 84 |     })
 85 |   }
 86 | }
 87 |
 88 | function getFriends (isFriends) { // if isFriends is false, getting friendships
 89 |   scrollTillEnd(() => chrome.storage.sync.get(
 90 |     ['userData'],
 91 |     ({ userData }) => scrappeFriends(userData, isFriends)
 92 |   ), true)
 93 | }
 94 |
 95 | function scrappeFriends (userData, isFriends) {
 96 |   let elements = getElementsByXPath('//*/li/div[1]/div[1]/div[2]/div[1]/div[2]') // mutual friends
 97 |   if (elements.length === 0) { // maybe users' friends:
 98 |     elements = getElementsByXPath('//*/div[1]/div[1]/div[1]/div[1]/div[1]/div[3]/div/div[2]').filter(c => c.children[0] !== undefined)
 99 |   } else if (getElementsByXPath('//*/li/div[1]/div[1]/div[1]/div[2]/div[1]/div[1]/a').length === 0) { // not mutual friends page:
100 |     elements = [] // bypassing!
101 |   }
102 |   const structs = elements.map(c => {
103 |     const struct = { name: c.children[0].innerText }
104 |     if (!c.children[0].children[0]) {
105 |       return struct
106 |     }
107 |     const linkName = c.children[0].children[0].href
108 |     if (!linkName) {
109 |       return struct
110 |     }
111 |     const numericMatch = linkName.match(/\?uid=(\d+)/) || linkName.match(/\/profile.php\?id=(\d+)/)
112 |
113 |     if (numericMatch) {
114 |       const nid = numericMatch[1]
115 |       if (nid !== userData.nid) {
116 |         struct.nid = nid
117 |       }
118 |     } else {
119 |       const stringMatch = linkName.match(/facebook.com\/([^?/]+)/)
120 |       if (stringMatch) {
121 |         const sid = stringMatch[1]
122 |         if (sid !== userData.sid) {
123 |           struct.sid = sid
124 |         }
125 |       }
126 |     }
127 |     if (c.children.length === 1) {
128 |       return struct
129 |     }
130 |     let linkFriends = c.children[1].href
131 |     if (!linkFriends) {
132 |       try {
133 |         linkFriends = c.children[1].children[0].children[0].children[0].children[0].href // fixme: when happends?
134 |       } catch (err) {
135 |         console.log('one friend href not obtained')
136 |       }
137 |     }
138 |     if (linkFriends && (/^([.,\d]+)/).test(c.childNodes[1].innerText)) {
139 |       const num = c.childNodes[1].innerText.match(/^([.,\d]+)/)[1]
140 |       if ((/\?uid=(\d+)/).test(linkFriends)) {
141 |         struct.nid = linkFriends.match(/\?uid=(\d+)/)[1]
142 |         struct.mutual = num
143 |       } else if ((/\/profile.php\?id=(\d+)/).test(linkFriends)) {
144 |         struct.nid = linkFriends.match(/\/profile.php\?id=(\d+)/)[1]
145 |         struct.nfriends = num
146 |       } else if ((/\/friends_mutual$/).test(linkFriends)) {
147 |         struct.sid = linkFriends.match(/facebook.com\/(.*)\/friends_mutual$/)[1]
148 |         struct.mutual = num
149 |       } else if ((/\/friends$/).test(linkFriends)) {
150 |         struct.sid = linkFriends.match(/facebook.com\/(.*)\/friends$/)[1]
151 |         struct.nfriends = num
152 |       } else {
153 |         throw new Error('friends link of a scrapped friend not understood:', linkFriends)
154 |       }
155 |     }
156 |     return struct
157 |   })
158 |   console.log({ structs })
159 |   chrome.runtime.sendMessage({ command: 'absorb', background: true, structs }, () => {
160 |     console.log('friends(ships) scrapped and sent to background:', structs.length)
161 |     if (isFriends) {
162 |       window.alert('friends registered.')
163 |     } else {
164 |       window.alert('friendships registered for 1 more friend.')
165 |     }
166 |   })
167 | }
168 |
169 | chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
170 |   console.log({ request, sender, sendResponse })
171 |   if (!request.content) return
172 |   const { command } = request
173 |   if (command === 'login') {
174 |     console.log('lets get this login data!')
175 |     loginFB()
176 |   } if (command === 'scrappeFriends') {
177 |     getFriends(true)
178 |   } if (command === 'scrappeFriendships') {
179 |     getFriends(false)
180 |   }
181 | })
182 |


--------------------------------------------------------------------------------
/you/scripts/fnetwork.js:
--------------------------------------------------------------------------------
  1 | /* global chrome */
  2 | const Graph = require('graphology')
  3 |
  4 | class FNetwork {
  5 |   constructor () {
  6 |     this.anonCount = 0
  7 |     this.anonNames = {} // { name: id }
  8 |     this.membersNotFound = []
  9 |     this.restart()
 10 |   }
 11 |
 12 |   restart () {
 13 |     this.graph = new Graph()
 14 |     this.graph.setAttribute('preclude', [])
 15 |     this.anonString = 'unnactive-' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15) + '-'
 16 |     this.graph.setAttribute('anonString', this.anonString)
 17 |     this.defineRound()
 18 |   }
 19 |
 20 |   defineRound () {
 21 |     const rounds = []
 22 |     this.graph.forEachNode((n, a) => {
 23 |       if (a.nid) rounds.push(a.scrapped)
 24 |     })
 25 |     if (rounds.length === 0) {
 26 |       this.round = 1
 27 |     } else {
 28 |       const rounds_ = rounds.map(i => {
 29 |         if (i === true) return 1
 30 |         else if (i === undefined) return 0
 31 |         return i
 32 |       })
 33 |       const allEqual = rounds_.every(i => i === rounds_[0])
 34 |       let round
 35 |       if (allEqual) round = rounds_[0] + 1
 36 |       else round = Math.max(...rounds_)
 37 |       chrome.rounds_ = rounds_
 38 |       this.round = round
 39 |       chrome.storage.sync.set({ sround: this.round })
 40 |       console.log('the round:', this.round)
 41 |     }
 42 |   }
 43 |
 44 |   absorb (struct) {
 45 |     if (struct === undefined) return
 46 |     if (this.graph.order) this.addFriendships(struct)
 47 |     else this.addFriends(struct)
 48 |   }
 49 |
 50 |   addFriends (struct) {
 51 |     struct.forEach(s => {
 52 |       const { name, sid, nid, mutual, nfriends } = s
 53 |       let id = sid || nid
 54 |       const anon = !id
 55 |       if (anon) {
 56 |         id = this.anonString + this.anonCount++
 57 |         this.anonNames[name] = id
 58 |       }
 59 |       this.graph.addNode(id, { name, sid, nid, mutual, nfriends, anon })
 60 |     })
 61 |   }
 62 |
 63 |   addFriendships (struct) {
 64 |     struct.forEach(s => {
 65 |       const { name, sid, nid, mutual, nfriends } = s
 66 |       let id = this.findNode(name, sid, nid)
 67 |       let a = {}
 68 |       let exists = true
 69 |       if (id === undefined) [exists, id] = [false, s.sid || s.nid]
 70 |       else a = this.graph.getNodeAttributes(id)
 71 |       a.name = name
 72 |       a.sid = a.sid || sid
 73 |       a.nid = a.nid || nid
 74 |       a.mutual = a.mutual || mutual
 75 |       a.nfriends = a.nfriends || nfriends
 76 |       a.anon = !(a.sid || a.nid)
 77 |       if (a.anon) {
 78 |         id = this.anonString + this.anonCount++
 79 |         this.anonNames[name] = id
 80 |       }
 81 |       if (!exists) {
 82 |         a.foundInRound = this.round
 83 |         this.graph.addNode(id, a)
 84 |       }
 85 |       if (!this.graph.hasEdge(this.lastId, id)) this.graph.addUndirectedEdge(this.lastId, id)
 86 |     })
 87 |     this.graph.setNodeAttribute(this.lastId, 'scrapped', this.round)
 88 |   }
 89 |
 90 |   getIds () {
 91 |     const sids = {}
 92 |     const nids = {}
 93 |     this.graph.forEachNode((n, a) => {
 94 |       if (a.sid) sids[a.sid] = a.nid
 95 |       if (a.nid) nids[a.nid] = a.sid
 96 |     })
 97 |     return { sids, nids }
 98 |   }
 99 |
100 |   findNode (name, sid, nid) {
101 |     const { sids, nids } = this.getIds()
102 |     // node can be sid or nid or anon-xxx, have to try them all
103 |     const nodes = this.graph.nodes()
104 |     if (nodes.includes(sid)) {
105 |       return sid
106 |     } else if (nodes.includes(nid)) {
107 |       return nid
108 |     } else { // id returned might be in the attributes
109 |       const temp = nid
110 |       nid = sids[sid]
111 |       sid = nids[temp]
112 |       if (nodes.includes(sid)) {
113 |         return sid
114 |       } else if (nodes.includes(nid)) {
115 |         return nid
116 |       } else { // or anon
117 |         // fixme: will raise error if two anons have same name, but ok for now:
118 |         return this.anonNames[name]
119 |       }
120 |     }
121 |   }
122 |
123 |   getNextURL () {
124 |     // we are only visiting the nodes with numeric id,
125 |     // which implies the giant component
126 |     // TODO: visit string ids to have the small components as well
127 |     const nodeIds = []
128 |     this.graph.forEachNode((n, a) => {
129 |       if (a.nid === undefined) return
130 |       nodeIds.push({
131 |         nid: a.nid,
132 |         sid: a.sid,
133 |         scrapped: a.scrapped,
134 |         id: n
135 |       })
136 |     })
137 |     let url
138 |     nodeIds.some(i => {
139 |       if (!i.scrapped) {
140 |         // url = `https://www.facebook.com/browse/mutual_friends/?uid=${i.nid}`  // old
141 |         url = `https://www.facebook.com/profile.php?id=${i.nid}&sk=friends_mutual`
142 |         this.lastId = i.id
143 |       }
144 |       return Boolean(url)
145 |     })
146 |     if (!url) {
147 |       nodeIds.some(i => {
148 |         if (i.scrapped < this.round) {
149 |           // url = `https://www.facebook.com/browse/mutual_friends/?uid=${i.nid}` // old
150 |           url = `https://www.facebook.com/profile.php?id=${i.nid}&sk=friends_mutual`
151 |           this.lastId = i.id
152 |         }
153 |         return Boolean(url)
154 |       })
155 |     }
156 |     return url
157 |   }
158 |
159 |   nScrapped () { // calculate scraped in the round and not ever, update in popup
160 |     let count = 0
161 |     this.graph.forEachNode((n, a) => { count += Boolean(a.scrapped) })
162 |     return count
163 |   }
164 |
165 |   info () {
166 |     return {
167 |       scrapped: this.nScrapped(),
168 |       order: this.graph.order,
169 |       size: this.graph.size
170 |     }
171 |   }
172 | }
173 |
174 | module.exports = new FNetwork()
175 |


--------------------------------------------------------------------------------
/you/scripts/ok/content.js:
--------------------------------------------------------------------------------
  1 | (function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
  2 | /* global chrome */
  3 | console.log('content script initiated', window.performance.now(), window.location.href)
  4 |
  5 | function getElementsByXPath (xpath, element) {
  6 |   const results = []
  7 |   const query = document.evaluate(xpath, element || document,
  8 |     null, window.XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null)
  9 |   for (let i = 0, length = query.snapshotLength; i < length; ++i) {
 10 |     results.push(query.snapshotItem(i))
 11 |   }
 12 |   return results
 13 | }
 14 |
 15 | function monload (work) {
 16 |   if (document.readyState !== 'complete') {
 17 |     window.addEventListener('load', (event) => {
 18 |       work()
 19 |     })
 20 |   } else {
 21 |     work()
 22 |   }
 23 | }
 24 | const scrollDelayInMilliSeconds = 300
 25 | const scrollMagnitude = 1000
 26 | const scrollTillEnd = (call, isFriends = false) => {
 27 |   const curUrl = document.location.href
 28 |   let criterion
 29 |   if (curUrl.match(/\?uid=(\d+)/)) { // special numeric mutual friends page:
 30 |     if (document.getElementsByClassName('UIStandardFrame_Container').length === 0) {
 31 |       return chrome.runtime.sendMessage({ step: 'blocked', background: true })
 32 |     }
 33 |     criterion = () => document.getElementsByClassName('morePager').length === 0
 34 |   } else {
 35 |     // criterion = () => getElementsByXPath('//*/div[1]/div[1]/div[1]/div[1]/div[1]/div[3]/div/div[@role="progressbar"]').length === 0
 36 |     criterion = () => getElementsByXPath('/html/body/div[1]/div/div[1]/div/div[3]/div/div/div[1]/div[1]/div/div/div[4]/div/div/div/div[2]/div/div/div/div').length > 0
 37 |   }
 38 |
 39 |   monload(() => {
 40 |     const time = setInterval(() => {
 41 |       document.documentElement.scrollTop += scrollMagnitude
 42 |       if (criterion()) {
 43 |         clearInterval(time)
 44 |         call()
 45 |       }
 46 |     }, scrollDelayInMilliSeconds)
 47 |   })
 48 | }
 49 |
 50 | function loginFB () {
 51 |   const curUrl = document.location.href
 52 |   let nid = curUrl.match(/\?uid=(\d+)/) || curUrl.match(/\/profile.php\?id=(\d+)/)
 53 |   let sid
 54 |   if (nid) {
 55 |     nid = nid[1]
 56 |   } else {
 57 |     sid = curUrl.match(/facebook.com\/(.*)\b/)[1]
 58 |   }
 59 |   const id = nid || sid
 60 |   let h1el
 61 |   const interval = setInterval(() => {
 62 |     const h1elements = getElementsByXPath('//*/h1')
 63 |     if (h1elements.length === 0) {
 64 |       h1el = getElementsByXPath('//*/h2/div')[0]
 65 |     } else {
 66 |       h1el = h1elements.length > 1 ? h1elements[1] : h1elements[0]
 67 |     }
 68 |     if (h1el) {
 69 |       clearInterval(interval)
 70 |       advance()
 71 |     }
 72 |   }, 200)
 73 |   function advance () {
 74 |     const membername = h1el.innerText
 75 |     const parts = membername.match(/[^\r\n]+/g)
 76 |     const name = parts[0]
 77 |     let codename // abbiamo perso codename, guardi: https://www.facebook.com/renato.fabbri.125
 78 |     if (parts.length > 1) {
 79 |       codename = parts[1]
 80 |     }
 81 |     const userData = { name, codename, sid, nid, id, newfb: true }
 82 |     chrome.storage.sync.set({ userData }, () => {
 83 |       console.log('userData set', { userData })
 84 |       window.alert('login succeded.')
 85 |     })
 86 |   }
 87 | }
 88 |
 89 | function getFriends (isFriends) { // if isFriends is false, getting friendships
 90 |   scrollTillEnd(() => chrome.storage.sync.get(
 91 |     ['userData'],
 92 |     ({ userData }) => scrappeFriends(userData, isFriends)
 93 |   ), true)
 94 | }
 95 |
 96 | function scrappeFriends (userData, isFriends) {
 97 |   let elements = getElementsByXPath('//*/li/div[1]/div[1]/div[2]/div[1]/div[2]') // mutual friends
 98 |   if (elements.length === 0) { // maybe users' friends:
 99 |     elements = getElementsByXPath('//*/div[1]/div[1]/div[1]/div[1]/div[1]/div[3]/div/div[2]').filter(c => c.children[0] !== undefined)
100 |   } else if (getElementsByXPath('//*/li/div[1]/div[1]/div[1]/div[2]/div[1]/div[1]/a').length === 0) { // not mutual friends page:
101 |     elements = [] // bypassing!
102 |   }
103 |   const structs = elements.map(c => {
104 |     const struct = { name: c.children[0].innerText }
105 |     if (!c.children[0].children[0]) {
106 |       return struct
107 |     }
108 |     const linkName = c.children[0].children[0].href
109 |     if (!linkName) {
110 |       return struct
111 |     }
112 |     const numericMatch = linkName.match(/\?uid=(\d+)/) || linkName.match(/\/profile.php\?id=(\d+)/)
113 |
114 |     if (numericMatch) {
115 |       const nid = numericMatch[1]
116 |       if (nid !== userData.nid) {
117 |         struct.nid = nid
118 |       }
119 |     } else {
120 |       const stringMatch = linkName.match(/facebook.com\/([^?/]+)/)
121 |       if (stringMatch) {
122 |         const sid = stringMatch[1]
123 |         if (sid !== userData.sid) {
124 |           struct.sid = sid
125 |         }
126 |       }
127 |     }
128 |     if (c.children.length === 1) {
129 |       return struct
130 |     }
131 |     let linkFriends = c.children[1].href
132 |     if (!linkFriends) {
133 |       try {
134 |         linkFriends = c.children[1].children[0].children[0].children[0].children[0].href // fixme: when happends?
135 |       } catch (err) {
136 |         console.log('one friend href not obtained')
137 |       }
138 |     }
139 |     if (linkFriends && (/^([.,\d]+)/).test(c.childNodes[1].innerText)) {
140 |       const num = c.childNodes[1].innerText.match(/^([.,\d]+)/)[1]
141 |       if ((/\?uid=(\d+)/).test(linkFriends)) {
142 |         struct.nid = linkFriends.match(/\?uid=(\d+)/)[1]
143 |         struct.mutual = num
144 |       } else if ((/\/profile.php\?id=(\d+)/).test(linkFriends)) {
145 |         struct.nid = linkFriends.match(/\/profile.php\?id=(\d+)/)[1]
146 |         struct.nfriends = num
147 |       } else if ((/\/friends_mutual$/).test(linkFriends)) {
148 |         struct.sid = linkFriends.match(/facebook.com\/(.*)\/friends_mutual$/)[1]
149 |         struct.mutual = num
150 |       } else if ((/\/friends$/).test(linkFriends)) {
151 |         struct.sid = linkFriends.match(/facebook.com\/(.*)\/friends$/)[1]
152 |         struct.nfriends = num
153 |       } else {
154 |         throw new Error('friends link of a scrapped friend not understood:', linkFriends)
155 |       }
156 |     }
157 |     return struct
158 |   })
159 |   console.log({ structs })
160 |   chrome.runtime.sendMessage({ command: 'absorb', background: true, structs }, () => {
161 |     console.log('friends(ships) scrapped and sent to background:', structs.length)
162 |     if (isFriends) {
163 |       window.alert('friends registered.')
164 |     } else {
165 |       window.alert('friendships registered for 1 more friend.')
166 |     }
167 |   })
168 | }
169 |
170 | chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
171 |   console.log({ request, sender, sendResponse })
172 |   if (!request.content) return
173 |   const { command } = request
174 |   if (command === 'login') {
175 |     console.log('lets get this login data!')
176 |     loginFB()
177 |   } if (command === 'scrappeFriends') {
178 |     getFriends(true)
179 |   } if (command === 'scrappeFriendships') {
180 |     getFriends(false)
181 |   }
182 | })
183 |
184 | },{}]},{},[1]);
185 |


--------------------------------------------------------------------------------
/you/scripts/pop.js:
--------------------------------------------------------------------------------
  1 | /* global chrome */
  2 | console.log('popup (script) initiated')
  3 | const $ = window.$ = require('jquery')
  4 | const fAll = require('../../scripts/modules/transfer.js').fAll
  5 | const { stdDiv, mkGrid, gridDivider, chooseUnique } = require('../../scripts/modules/utils.js')
  6 |
  7 | let cDiv
  8 | window.unused = { mkGrid, gridDivider, chooseUnique }
  9 |
 10 | function mkDate (adate) {
 11 |   if (!adate) return '--'
 12 |   return new Date(adate).toLocaleString('en-GB', {
 13 |     day: 'numeric', month: 'short', year: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric'
 14 |   }).replace(/ /, '/').replace(/ /, '/')
 15 | }
 16 |
 17 | const mkRadio = id => {
 18 |   $('<input/>', { value: id, id, type: 'radio', name: 'oradio' }).appendTo(
 19 |     $('<label/>', { for: id }).html(id).appendTo(cDiv)
 20 |   )
 21 |   stdDiv('80%').attr('class', 'info').attr('id', 'd' + id).hide().html(id)
 22 |     .css('background-color', '#ddd')
 23 | }
 24 |
 25 | function addRow (name, dict, grid, attr) {
 26 |   attr = attr || name
 27 |   $('<span/>').html(name + ':').appendTo(grid)
 28 |   $('<span/>').html(dict[attr] || '--').appendTo(grid)
 29 | }
 30 |
 31 | const build = () => {
 32 |   cDiv = $('<div/>').appendTo('body')
 33 |   mkRadio('Facebook')
 34 |   mkRadio('WhatsApp')
 35 |   mkRadio('Telegram')
 36 |   $('input[type=radio][name=oradio]').on('change', function () {
 37 |     const option = $(this).val()
 38 |     console.log(option)
 39 |     $('.info').hide()
 40 |     $('#d' + option).show()
 41 |   })
 42 |   setFacebook()
 43 | }
 44 |
 45 | function setFacebook () {
 46 |   const grid = mkGrid(2, '#dFacebook', '100%', '#fff')
 47 |     .css('margin-bottom', '1em')
 48 |     .css('width', '')
 49 |   function add (name, dict, attr) {
 50 |     addRow(name, dict, grid, attr)
 51 |   }
 52 |   chrome.storage.sync.get(
 53 |     ['userData', 'nfriends', 'nfriendships', 'nscrapped', 'metaData', 'lastScrapped', 'sround'],
 54 |     ({ userData, nfriends, nfriendships, nscrapped, metaData, lastScrapped, sround }) => {
 55 |       console.log({ userData, nfriends, metaData, lastScrapped, sround })
 56 |       userData = userData || {}
 57 |       add('name', userData)
 58 |       if (userData.codename) add('codename', userData)
 59 |       add('id', userData)
 60 |       gridDivider(160, 160, 160, grid, 1)
 61 |       metaData = metaData || {}
 62 |       $('<span/>').html('friends:').appendTo(grid)
 63 |       $('<span/>').html(nfriends).appendTo(grid)
 64 |       $('<span/>').html('friendships:').appendTo(grid)
 65 |       $('<span/>').html(nfriendships).appendTo(grid)
 66 |       $('<span/>').html('scrapped:').appendTo(grid)
 67 |       $('<span/>').html(nscrapped).appendTo(grid)
 68 |       gridDivider(160, 160, 160, grid, 1)
 69 |       $('<span/>').html('previous scrappe:').appendTo(grid)
 70 |       $('<span/>').html(mkDate(lastScrapped)).appendTo(grid)
 71 |       $('<span/>').html('round:').appendTo(grid)
 72 |       $('<span/>').html(sround || '--').appendTo(grid)
 73 |       const command = userData.id ? 'logout' : 'login'
 74 |       $('<button/>', {
 75 |         css: {
 76 |           width: '75%',
 77 |           background: '#efe'
 78 |         }
 79 |       })
 80 |         .appendTo('#dFacebook')
 81 |         .text(command)
 82 |         .click(() => {
 83 |           if (command === 'logout') {
 84 |             chrome.storage.sync.remove(['userData', 'lastScrapped', 'nfriends', 'nfriendships', 'nscrapped'], () => {
 85 |               console.log('yeah, logged out')
 86 |               setTimeout(() => window.close(), 1000)
 87 |             })
 88 |           } else {
 89 |             chrome.runtime.sendMessage({
 90 |               command,
 91 |               background: true
 92 |             })
 93 |           }
 94 |         })
 95 |
 96 |       const disabled = command === 'login'
 97 |       $('<button/>', {
 98 |         disabled,
 99 |         css: {
100 |           width: '75%',
101 |           background: 'lightred'
102 |         }
103 |       })
104 |         .appendTo('#dFacebook')
105 |         .text('Get friends')
106 |         .click(() => {
107 |           chrome.runtime.sendMessage({
108 |             command: 'scrappeFriends',
109 |             background: true
110 |           })
111 |         })
112 |       $('<button/>', {
113 |         disabled,
114 |         css: {
115 |           width: '75%',
116 |           background: 'lightred'
117 |         }
118 |       })
119 |         .appendTo('#dFacebook')
120 |         .text('Get friendships')
121 |         .click(() => {
122 |           chrome.runtime.sendMessage({
123 |             command: 'scrappeFriendships',
124 |             background: true
125 |           })
126 |         })
127 |       $('<button/>', {
128 |         disabled,
129 |         css: {
130 |           width: '75%',
131 |           background: 'lightyellow'
132 |         }
133 |       })
134 |         .appendTo('#dFacebook')
135 |         .text('See yourself')
136 |         .click(() => {
137 |           chrome.runtime.sendMessage({
138 |             command: 'seeNetwork',
139 |             background: true
140 |           })
141 |         })
142 |     }
143 |   )
144 | }
145 |
146 | const start = () => {
147 |   $('#Facebook').click()
148 | }
149 |
150 | $(document).ready(() => {
151 |   build()
152 |   start()
153 |
154 |   $('<button/>')
155 |     .appendTo(cDiv)
156 |     .text('click to send message to content script!')
157 |     .click(() => {
158 |       chrome.tabs.query({ currentWindow: true, active: true }, function (tabs) {
159 |         const activeTab = tabs[0]
160 |         console.log({ activeTab })
161 |         chrome.tabs.sendMessage(activeTab.id, { message: 'getMeContentScript' })
162 |       })
163 |     }).hide()
164 |   $('<button/>')
165 |     .appendTo(cDiv)
166 |     .text('click to send message to service worker!')
167 |     .click(() => {
168 |       chrome.runtime.sendMessage({ message: 'forwardToServiceWorker' })
169 |     }).hide()
170 |   chrome.runtime.onMessage.addListener(
171 |     function (request, sender, sendResponse) {
172 |       console.log('received message on popup!', { request, sender, sendResponse })
173 |     }
174 |   )
175 | })
176 |
177 | chrome.runtime.onMessage.addListener(function (request, sender, sendResponse) {
178 |   if (!request.popup) return
179 |   const { command } = request
180 |   if (command === 'writeNet') {
181 |     chrome.storage.sync.get(
182 |       ['userData'],
183 |       ({ userData }) => {
184 |         fAll.df4b({ 'userData.id': userData.id }).then(() => {
185 |           userData.net = request.net
186 |           fAll.wf4b({ userData }).then(() => {
187 |             console.log('net written')
188 |             chrome.tabs.create({ url: `http://audiovisualmedicine.github.io?you&fid=${userData.id}&deg=true` })
189 |           })
190 |         })
191 |       }
192 |     )
193 |   }
194 | })
195 |


--------------------------------------------------------------------------------