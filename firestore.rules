rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Diagnostic Reports - Write-only para todos (anônimo ok)
    // Apenas admin pode ler via Firebase Console
    match /diagnostic_reports/{reportId} {
      // Qualquer um pode criar um relatório
      allow create: if true;

      // Apenas o próprio usuário autenticado pode ler seu relatório
      // (ou ninguém, se quisermos 100% write-only)
      allow read: if false; // write-only puro

      // Validação do documento
      allow create: if request.resource.data.keys().hasAll([
        'timestamp', 'browser', 'os', 'system'
      ]) && request.resource.data.message is string
         && request.resource.data.message.size() < 1000; // max 1000 chars
    }

    // Protocolos públicos - Read-only para todos
    // Apenas admin pode escrever via Firebase Console
    match /protocols/{protocolId} {
      allow read: if true; // público
      allow write: if false; // apenas admin via console
    }

    // Sessões de usuário (futuro) - requer autenticação
    match /sessions/{sessionId} {
      allow read, write: if request.auth != null
                         && request.auth.uid == resource.data.userId;
    }

    // Preferências de privacidade por usuário
    match /user_settings/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Eventos privados de uso - acessíveis apenas pelo próprio usuário
    match /usage_events/{eventId} {
      allow create: if request.auth != null
                     && request.auth.uid == request.resource.data.userId;
      allow read: if request.auth != null
                   && request.auth.uid == resource.data.userId;
    }

    // Feed público anonimizado - leitura aberta, escrita apenas autenticada
    match /usage_events_public/{eventId} {
      allow read: if true;
      allow create: if request.auth != null
                     && !(request.resource.data.keys().hasAny(['userId', 'userUid']));
      allow update, delete: if false;
    }

    // Bloquear tudo que não está explicitamente permitido
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
